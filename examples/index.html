<!DOCTYPE html>

<html>

<head>
  <title>Ballsinki</title>
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
    }

    html {
      touch-action: none;
    }
  </style>
  <link rel="stylesheet" href="./ballsinki.css">
  <script type="text/javascript" src="js/ammo.js"></script>
  <script type="text/javascript" src="js/three-121.js"></script>
  <script type="text/javascript" src="js/stats.js"></script>
  <script type="text/javascript" src="js/physi.js"></script>
  <script type="text/javascript" src="js/physijs_worker.js"></script>
  <!-- <script type="text/javascript" src="js/THREEOrbitControls.js"></script> -->
  <script type="text/javascript" src="js/easytimer.js"></script>
  <script type="text/javascript" src="js/howler.min.js"></script>
  <!-- <script src="https://unpkg.com/three@0.112.0/examples/js/loaders/GLTFLoader.js"></script> -->
  <script type="text/javascript" src="./features.js"></script>
  <script type="text/javascript" src="./event-handlers.js"></script>
  <script type="text/javascript" src="./debug.js"></script>
  <script type="text/javascript">
    "use strict";
    const coinProperties = {
      sCoin: [
        "sounds/Sound FX/SFX COIN 1a.mp3",
        "sounds/Sound FX/SFX COIN 1b.mp3",
        "sounds/Sound FX/SFX COIN 1c.mp3"
      ],
      mCoin: [
        "sounds/Sound FX/SFX COIN 2a.mp3",
        "sounds/Sound FX/SFX COIN 2b.mp3",
        "sounds/Sound FX/SFX COIN 2c.mp3"
      ],
      lCoin: [
        "sounds/Sound FX/SFX COIN 3a.mp3",
        "sounds/Sound FX/SFX COIN 3b.mp3",
        "sounds/Sound FX/SFX COIN 3c.mp3"
      ]
    }

    const stageProperties = {
      STAGE0: {
        backgroundColors: [
          "rgba(2,0,36,0)",
          "rgba(121,9,117,1)",
          "rgba(252,231,183,1)",
          "rgba(0,212,255,1)"
        ],
        basicColors: [
          new THREE.Color(0xfff1e3),
          new THREE.Color(0xffd5c9),
          new THREE.Color(0xffa6bb),
          new THREE.Color(0xff757f),
          new THREE.Color(0x159294)
        ],
        sounds: {
          coins: coinProperties,
          beams: [
            "sounds/Sound FX/BALL FALL fx a1.mp3",
            "sounds/Sound FX/BALL FALL fx a2.mp3",
            "sounds/Sound FX/BALL FALL fx a3.mp3",
            "sounds/Sound FX/BALL FALL fx a4.mp3",
            "sounds/Sound FX/BALL FALL fx a5.mp3",
            "sounds/Sound FX/BALL FALL fx a6.mp3",
            "sounds/Sound FX/BALL FALL fx a7.mp3",
            "sounds/Sound FX/BALL FALL fx a8.mp3"
          ],
          prize: "sounds/Sound FX/PRIZE_1.mp3",
          backgroundMusic: "sounds/BALL FALL jingle flat 1.mp3"
        }
      },
      STAGE1: {
        backgroundColors: [
          "#FFDC6A",
          "#FFB83B",
          "#F4AD42",
          "#F96F46"
        ],
        backgroundElementColors: [
          new THREE.Color(0xf3d053),
          new THREE.Color(0xFFCF00),
          new THREE.Color(0xEE6123),
          new THREE.Color(0xFA003F),
          new THREE.Color(0xFFFD77)
        ],
        basicColors: [
          new THREE.Color(0x0070bf),
          new THREE.Color(0x00a5e9),
          new THREE.Color(0x00e4c7),
          new THREE.Color(0xffffff),
          new THREE.Color(0x06b9a3)
        ],
        sounds: {
          coins: coinProperties,
          beams: [
            "sounds/Sound FX/BALL FALL fx b1.mp3",
            "sounds/Sound FX/BALL FALL fx b2.mp3",
            "sounds/Sound FX/BALL FALL fx b3.mp3",
            "sounds/Sound FX/BALL FALL fx b4.mp3",
            "sounds/Sound FX/BALL FALL fx b5.mp3",
            "sounds/Sound FX/BALL FALL fx b6.mp3",
            "sounds/Sound FX/BALL FALL fx b7.mp3",
            "sounds/Sound FX/BALL FALL fx b8.mp3"
          ],
          prize: "sounds/Sound FX/PRIZE_1.mp3",
          backgroundMusic: "sounds/Crystal Canopy.mp3"
        }
      },
      STAGE2: {
        backgroundColors: [
          "#F16D9C",
          "#F16D9C",
          "#A78BBF",
          "#552E8F"
        ],
        basicColors: [
          new THREE.Color(0x9de1ea),
          new THREE.Color(0x805cc5),
          new THREE.Color(0x81a1ab),
          new THREE.Color(0xffd5c9),
          new THREE.Color(0xffffff)
        ],
        sounds: {
          coins: coinProperties,
          beams: [
            "sounds/Sound FX/BALL FALL fx c1.mp3",
            "sounds/Sound FX/BALL FALL fx c2.mp3",
            "sounds/Sound FX/BALL FALL fx c3.mp3",
            "sounds/Sound FX/BALL FALL fx c4.mp3",
            "sounds/Sound FX/BALL FALL fx c5.mp3",
            "sounds/Sound FX/BALL FALL fx c6.mp3",
            "sounds/Sound FX/BALL FALL fx c7.mp3",
            "sounds/Sound FX/BALL FALL fx c8.mp3"
          ],
          prize: "sounds/Sound FX/PRIZE_1.mp3",
          backgroundMusic: "sounds/Goose Down.mp3"
        }
      },
      STAGE3: {
        backgroundColors: [
          "#0F181F",
          "#23a373",
          "#26797d",
          "#363f46"
        ],
        basicColors: [
          new THREE.Color(0xffed6d),
          new THREE.Color(0x77ff8b),
          new THREE.Color(0xa2ffd9),
          new THREE.Color(0xe0e8f0),
          new THREE.Color(0xffffff)
        ],
        sounds: {
          coins: coinProperties,
          beams: [
            "sounds/Sound FX/BALL FALL fx d1.mp3",
            "sounds/Sound FX/BALL FALL fx d2.mp3",
            "sounds/Sound FX/BALL FALL fx d3.mp3",
            "sounds/Sound FX/BALL FALL fx d4.mp3",
            "sounds/Sound FX/BALL FALL fx d5.mp3",
            "sounds/Sound FX/BALL FALL fx d6.mp3",
            "sounds/Sound FX/BALL FALL fx d7.mp3",
            "sounds/Sound FX/BALL FALL fx d8.mp3"
          ],
          prize: "sounds/Sound FX/PRIZE_1.mp3",
          backgroundMusic: "sounds/In A Pinch.mp3"
        }
      },
      STAGE4: {
        backgroundColors: [
          "#0070bf",
          "#00a5e9",
          "#4fffd4",
          "#00e4c7"
        ],
        basicColors: [
          new THREE.Color(0xfea5ff),
          new THREE.Color(0xf191ff),
          new THREE.Color(0x9f7be5),
          new THREE.Color(0xc594ff),
          new THREE.Color(0xffffff)
        ],
        sounds: {
          coins: coinProperties,
          beams: [
            "sounds/Sound FX/BALL FALL fx e1.mp3",
            "sounds/Sound FX/BALL FALL fx e2.mp3",
            "sounds/Sound FX/BALL FALL fx e3.mp3",
            "sounds/Sound FX/BALL FALL fx e4.mp3",
            "sounds/Sound FX/BALL FALL fx e5.mp3",
            "sounds/Sound FX/BALL FALL fx e6.mp3",
            "sounds/Sound FX/BALL FALL fx e7.mp3",
            "sounds/Sound FX/BALL FALL fx e8.mp3"
          ],
          prize: "sounds/Sound FX/PRIZE_1.mp3",
          backgroundMusic: "sounds/Ballsinki Friendship.mp3"
        }
      },
      STAGE5: {
        backgroundColors: [
          "rgba(2,0,36,0)",
          "rgba(121,9,117,1)",
          "#2e3192",
          "rgba(0,0,0,1)"
        ],
        basicColors: [
          new THREE.Color(0xec008c),
          new THREE.Color(0x00aeef)
        ],
        sounds: {
          coins: coinProperties,
          beams: [
            "sounds/Sound FX/BALL FALL fx a1.mp3",
            "sounds/Sound FX/BALL FALL fx a2.mp3",
            "sounds/Sound FX/BALL FALL fx a3.mp3",
            "sounds/Sound FX/BALL FALL fx a4.mp3",
            "sounds/Sound FX/BALL FALL fx a5.mp3",
            "sounds/Sound FX/BALL FALL fx a6.mp3",
            "sounds/Sound FX/BALL FALL fx a7.mp3",
            "sounds/Sound FX/BALL FALL fx a8.mp3"
          ],
          prize: "sounds/Sound FX/PRIZE_1.mp3",
          backgroundMusic: "sounds/Ballsinki Remix.mp3"
        }
      }
    }
    window.appConfig = {
      touchStart: false,
      touchEnd: false,
      currentX: 0,
      currentY: 0,
      prevX: 0,
      prevY: 0,
      diffX: 0,
      diffY: 0,
      start: false,
      pause: false,
      results: {},
      pause: false,
      defaultSphereMass: 4.188790683884756,
      defaultSceneGravity: -10,
      itemAmounts: {
        crystalCross: 0,
        crystalLine: 0,
        crystalCircle: 0,
        bumperGroup: 0,
        prize: 0
      },
      currentStage: 'STAGE0',
      stagesArray: ['STAGE0', 'STAGE1', 'STAGE2', 'STAGE3', 'STAGE4', 'STAGE5'],
      currentStageIndex: 0,
      musicTurnedOn: true,
      sfxTurnedOn: true

    };

    window.appConfig.howlSounds = {
      init: false,
      coins: {
        sCoin: [],
        mCoin: [],
        lCoin: []
      },
      beams: [],
      prize: undefined,
      backgroundMusic: undefined
    }

    const loadSound = (options) => {
      const { src, type } = options;
      const sound = new Howl({
        src: [src],
        autoPlay: type === "backgroundMusic" ? true : false,
        loop: type === "backgroundMusic" ? true : false,
        volume: type === "backgroundMusic" ? .3 : .1,
      }).once("load", () => {
        if (type === "backgroundMusic") {
          window.appConfig.howlSounds.backgroundMusic = sound;
          sound.play();
        }
      });
      return sound;
    };

    Physijs.scripts.worker = "js/physijs_worker.js";
    Physijs.scripts.ammo = "ammo.js";

    let adjustCamera = 20;

    const getRandomColor = () => {
      const basicColors = window.appConfig.stages ? window.appConfig.stages[window.appConfig.currentStage].basicColors : stageProperties.STAGE0.basicColors
      return basicColors[Math.floor(Math.random() * basicColors.length)];
    };

    // LFO
    const lfoPositive = (t = 1000) => {
      let lfoValue = (0.5 + 0.5 * Math.cos(Date.now() / t)) * 1;
      return lfoValue;
    };

    const lfo = (t = 1000) => {
      return (0.5 - lfoPositive(t)) * 2;
    };
    const lfoPositiveStraight = (t = 1000) => {
      let lfoValue = (0.5 + 0.5 * Math.cos(Date.now() / t)) * 1;
      return lfoValue;
    };

    var initScene,
      render,
      _boxes = [],
      spawnBox,
      loader,
      renderer,
      render_stats,
      physics_stats,
      scene,
      ground_material,
      ground,
      light,
      camera,
      orbitControls;

    initScene = function () {
      window.appConfig.soundsBackDestination = "";
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x000000, 0);
      renderer.shadowMap.enabled = true;
      renderer.shadowMapSoft = true;
      document.getElementById("viewport").appendChild(renderer.domElement);

      render_stats = new Stats();
      render_stats.domElement.style.position = "absolute";
      render_stats.domElement.style.top = "0px";
      render_stats.domElement.style.zIndex = 100;
      document
        .getElementById("viewport")
        .appendChild(render_stats.domElement);

      physics_stats = new Stats();
      physics_stats.domElement.style.position = "absolute";
      physics_stats.domElement.style.top = "50px";
      physics_stats.domElement.style.zIndex = 100;
      document
        .getElementById("viewport")
        .appendChild(physics_stats.domElement);

      scene = new Physijs.Scene();

      scene.setGravity(new THREE.Vector3(0, -10, 0));

      scene.addEventListener("update", function () {
        scene.simulate(undefined, 1);
        physics_stats.update();
      });

      window.appConfig.lighting = {
        hemisphereLight: new THREE.HemisphereLight(
          getRandomColor(),
          getRandomColor(),
          0.75
        )
      }

      scene.add(window.appConfig.lighting.hemisphereLight);
      //set html stuff from game options
      const sfxButton =
        document.querySelector('#sfx-toggle-button')
      if (window.appConfig.sfxTurnedOn) {
        sfxButton.textContent = "ON"
        changeSFXVolume(100)
      } else {
        sfxButton.textContent = "OFF"
        changeSFXVolume(0)
      }
      // setTimeout(100, () => {
      //   sfxButton.addEventListener('ready', () => {
      //     toggleSFXButton()
      //   })
      // })
      const musicButton =
        document.querySelector('#music-toggle-button')
      if (window.appConfig.musicTurnedOn) {
        musicButton.textContent = "ON"
        changeMusicVolume(100)
      } else {
        musicButton.textContent = "OFF"
        changeMusicVolume(0)
      }
      // musicButton.addEventListener('click', () => {
      //   toggleMusicButton()
      // })

      camera = new THREE.PerspectiveCamera(
        35,
        window.innerWidth / window.innerHeight,
        1,
        1000
      );

      adjustCamera = 20;
      camera.position.set(0, 10, 10);
      camera.lookAt(new THREE.Vector3(0, 10, 0));
      scene.add(camera);

      // Light
      light = new THREE.SpotLight(0xffffff);
      light.position.set(20, 80, 15);
      light.target.position.copy(scene.position);
      light.castShadow = true;
      light.shadowCameraLeft = -60;
      light.shadowCameraTop = -60;
      light.shadowCameraRight = 60;
      light.shadowCameraBottom = 60;
      light.shadowCameraNear = 20;
      light.shadowCameraFar = 200;
      light.shadowBias = -0.0001;
      light.shadowMapWidth = light.shadowMapHeight = 2048;
      light.shadowDarkness = 0.7;
      scene.add(light);

      const pointLight0 = new THREE.PointLight(getRandomColor(), 1);
      pointLight0.gameName = "POINTLIGHT0";
      pointLight0.power = 25;
      pointLight0.decay = 1;
      pointLight0.distance = 25;
      scene.add(pointLight0);

      const pointLight1 = new THREE.PointLight(getRandomColor(), 1);
      pointLight1.gameName = "POINTLIGHT1";
      pointLight1.power = 25;
      pointLight1.decay = 1;
      pointLight1.distance = 25;
      scene.add(pointLight1);

      const pointLight2 = new THREE.PointLight(getRandomColor(), 1);
      pointLight2.gameName = "POINTLIGHT2";
      pointLight2.power = 25;
      pointLight2.decay = 1;
      pointLight2.distance = 25;
      scene.add(pointLight2);

      const pointLight3 = new THREE.PointLight(getRandomColor(), 1);
      pointLight3.gameName = "POINTLIGHT3";
      pointLight3.power = 25;
      pointLight3.decay = 1;
      pointLight3.distance = 25;
      scene.add(pointLight3);


      // Orbit Controls
      // orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
      // orbitControls.enabled = false;

      //resize event handler
      function onWindowResize(event) {

        console.log('ran window resize', event)
        setFontSizes()
        centerElement({ id: "start-button-container", offsetTop: 0, offsetLeft: 0 });
        centerElement({ id: "level-select", offsetTop: 0, offsetLeft: 0 });
        centerElement({ id: "report", offsetTop: 0, offsetLeft: 0 });
        centerElement({ id: "pause-menu", offsetTop: 0, offsetLeft: 0 });
        centerElement({ id: "title", offsetTop: "-31%", offsetLeft: 0 });
        centerElement({ id: "start-menu", offsetTop: "31%", offsetLeft: 0 });
        var tanFOV = Math.tan(((Math.PI / 180) * camera.fov) / 2);
        var windowHeight = window.innerHeight;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.fov =
          (360 / Math.PI) *
          Math.atan(tanFOV * (window.innerHeight / windowHeight));

        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.render(scene, camera);
      }
      onWindowResize();
      window.addEventListener("resize", onWindowResize, false);

      loader = new THREE.TextureLoader();

      let level = 25;
      window.appConfig.level = level;
      let score = {
        coins: 0,
      };
      window.appConfig.score = score;

      const coins = [];
      window.appConfig.coins = coins;

      const beamMaterial = new THREE.MeshPhongMaterial({
        color: 0xffffff,
      })

      const beamCapGeometry = new THREE.BoxGeometry(1.45, 2, 1.45)

      const createBeam = (config) => {
        const beamBox = new THREE.BoxGeometry((10 * config.s), 2, 2)

        const beam0cap0 = new Physijs.BoxMesh(
          beamCapGeometry,
          Physijs.createMaterial(
            beamMaterial,
            0.6, // medium friction
            0.1 // low restitution
          ),
          0 // mass
        );

        const beam0cap1 = new Physijs.BoxMesh(
          beamCapGeometry,
          Physijs.createMaterial(
            beamMaterial,
            0.6, // medium friction
            0.1 // low restitution
          ),
          0 // mass
        );

        const beam0 = new Physijs.BoxMesh(
          beamBox,
          Physijs.createMaterial(
            beamMaterial,
            0.6, // medium friction
            0.1 // low restitution
          ),
          0 // mass
        );

        beam0.add(beam0cap0)
        beam0.add(beam0cap1)
        beam0cap0.rotation.y = 0.25 * Math.PI;
        beam0cap0.position.x = -5 * config.s;
        beam0cap1.rotation.y = 0.25 * Math.PI;
        beam0cap1.position.x = 5 * config.s;


        beam0.position.set(config.p[0], config.p[1], config.p[2]);
        beam0.rotation.set(config.r[0], config.r[1], config.r[2]);

        return beam0;
      };

      const crystalTopGeometry = new THREE.CylinderGeometry(0, 1, 0.5, 6)
      const crystalMiddleGeometry = new THREE.CylinderGeometry(1, 1, 1, 6)
      const crystalBottomGeometry = new THREE.CylinderGeometry(1, 0, 0.5, 6)

      const tripleHex = 0x159294;
      const doubleHex = 0xffa6bb;
      const singleHex = 0xffd5c9;
      const tripleScale = 2;
      const doubleScale = 1.5;
      const singleScale = 1;
      const xScaleMod = 0.5;
      const yScaleMod = 1;
      const zScaleMod = 0.5;
      const crystalMaterialOptions = {
        color: 0x000000,
        specular: 0x050505,
        shininess: 100
      };
      window.appConfig.crystalMaterials = [
        {
          standard: new THREE.MeshPhongMaterial({ ...crystalMaterialOptions, color: singleHex }),
          pulsing: new THREE.MeshPhongMaterial({ ...crystalMaterialOptions, color: singleHex })
        },
        {
          standard: new THREE.MeshPhongMaterial({ ...crystalMaterialOptions, color: doubleHex }),
          pulsing: new THREE.MeshPhongMaterial({ ...crystalMaterialOptions, color: doubleHex })
        },
        {
          standard: new THREE.MeshPhongMaterial({ ...crystalMaterialOptions, color: tripleHex }),
          pulsing: new THREE.MeshPhongMaterial({ ...crystalMaterialOptions, color: tripleHex })
        },
        {
          standard: new THREE.MeshPhongMaterial(),
          pulsing: new THREE.MeshPhongMaterial()
        }
      ]
      const crystal = (size = 0, p = { x: 0, y: 0, z: 0 }) => {

        const coin = new THREE.Mesh();
        const crystalTop = new THREE.Mesh(
          crystalTopGeometry,
          window.appConfig.crystalMaterials[size].standard
        );
        crystalTop.translateY(0.75);
        const crystalMiddle = new THREE.Mesh(
          crystalMiddleGeometry,
          window.appConfig.crystalMaterials[size].standard
        );

        const crystalBottom = new THREE.Mesh(
          crystalBottomGeometry,
          window.appConfig.crystalMaterials[size].standard
        );
        crystalBottom.translateY(-0.75);
        coin.add(crystalTop);
        coin.add(crystalMiddle);
        coin.add(crystalBottom);
        coin.position.set(p.x, p.y, 0);
        coin.featureType = "COIN";
        if (size === 0) {
          coin.scale.set(
            singleScale * xScaleMod,
            singleScale * yScaleMod,
            singleScale * zScaleMod
          );
          coin.coinType = "single";
          coin.coinValue = 100;
          coin.baseColor = singleHex
          coin.coinHeight =
            coin.children.forEach((child) => {
              child.material.color.setHex(singleHex);
            });
        }
        if (size === 1) {
          coin.scale.set(
            doubleScale * xScaleMod,
            doubleScale * yScaleMod,
            doubleScale * zScaleMod
          );
          coin.coinType = "double";
          coin.coinValue = 200;
          coin.baseColor = doubleHex
          coin.children.forEach((child) => {
            child.material.color.setHex(doubleHex);
          });
        }

        if (size === 2) {
          coin.scale.set(
            tripleScale * xScaleMod,
            tripleScale * yScaleMod,
            tripleScale * zScaleMod
          );
          coin.coinType = "triple";
          coin.coinValue = 300;
          coin.baseColor = tripleHex
          coin.children.forEach((child) => {
            child.material.color.setHex(tripleHex);
          });
        }
        window.appConfig.coins.push(coin);
        coin.size = size
        return coin;
      };

      const prizeMiddleGeometry = new THREE.BoxGeometry(0.75, 0.75, 0.75)
      const prizeTopGeometry = new THREE.ConeGeometry(1, 1, 8)
      const prizeBottomGeometry = new THREE.ConeGeometry(1, -1, 8)
      const prize = (stageNumber, prizeNumber, p = { x: 0, y: 0, z: 0 }) => {
        const prize0Group = new THREE.Group();
        prize0Group.size = 3
        const prize0 = new THREE.Mesh(
          prizeMiddleGeometry,
          window.appConfig.crystalMaterials[prize0Group.size].standard
        );
        const prize0Top = new THREE.Mesh(
          prizeTopGeometry,
          window.appConfig.crystalMaterials[prize0Group.size].standard
        );
        const prize0Bottom = new THREE.Mesh(
          prizeBottomGeometry,
          window.appConfig.crystalMaterials[prize0Group.size].standard
        )
        prize0Group.name = `STAGE${stageNumber}PRIZE${prizeNumber}`
        prize0Group.debugTypeIndex = window.appConfig.itemAmounts.prize
        prize0Group.debugType = 'PRIZE'
        prize0Group.debugName = 'PRIZE' + window.appConfig.itemAmounts.prize
        window.appConfig.itemAmounts.prize++

        prize0.name = `PRIZE${prizeNumber}`
        prize0Top.name = `PRIZE${prizeNumber}TOP`
        prize0Bottom.name = `PRIZE${prizeNumber}BOTTOM`


        prize0.rotation.set(.25 * Math.PI, .25 * Math.PI, 0)
        prize0Group.add(prize0)
        prize0Group.add(prize0Top)
        prize0Group.add(prize0Bottom)

        prize0Top.position.y += 1.5
        prize0Bottom.position.y += -1.5
        prize0Group.position.set(p.x, p.y, 0)
        scene.add(prize0Group)
        prize0Group.prizeValue = 1000

        window.appConfig.coins.push(prize0Group);

      }

      const createCrystalCross = (name = "NO_NAME", s, t = { x: 0, y: 0 }, size = 0) => {
        const crystalCross = new THREE.Group()
        crystalCross.debugTypeIndex = window.appConfig.itemAmounts.crystalCross
        crystalCross.debugType = 'CRYSTALCROSS'
        crystalCross.debugName = 'CRYSTALCROSS' + window.appConfig.itemAmounts.crystalCross
        crystalCross.name = name + '_' + crystalCross.debugName

        crystalCross.add(crystal(size, { x: 0 * s + t.x, y: 1 * s + t.y, z: 0 }));
        crystalCross.add(crystal(size, { x: 0 * s + t.x, y: -1 * s + t.y, z: 0 }));
        crystalCross.add(crystal(size, { x: -1 * s + t.x, y: 0 * s + t.y, z: 0 }));
        crystalCross.add(crystal(size, { x: 1 * s + t.x, y: 0 * s + t.y, z: 0 }));
        scene.add(crystalCross)
        window.appConfig.itemAmounts.crystalCross++
      };

      const createCrystalCircle = (
        name = 'NO_NAME',
        s,
        t = { x: 0, y: 0 },
        size = 0,
        n = 4
      ) => {
        const crystalCircle = new THREE.Group()
        crystalCircle.debugTypeIndex = window.appConfig.itemAmounts.crystalCircle
        crystalCircle.debugType = 'CRYSTALCIRCLE'
        crystalCircle.debugName = 'CRYSTALCIRCLE' + window.appConfig.itemAmounts.crystalCircle
        crystalCircle.name = name + '_' + crystalCircle.debugName
        var ellipse = new THREE.EllipseCurve(0, 0, s, s, 0, 2.0 * Math.PI, false);
        var ellipsePath = new THREE.CurvePath();
        ellipsePath.add(ellipse);
        var ellipseGeometry = ellipsePath.createPointsGeometry(n);
        console.log(ellipseGeometry)
        // debugger
        let i = 0;
        for (i; i < ellipseGeometry.vertices.length - 1; i++) {
          // if (i % 4 == 0) {
          crystalCircle.add(crystal(size, { x: ellipseGeometry.vertices[i].x * s + t.x, y: ellipseGeometry.vertices[i].y * s + t.y, z: 0 }));

          // }
        }
        scene.add(crystalCircle)
        window.appConfig.itemAmounts.crystalCircle++
      };


      const createCrystalLine = (
        name = 'NO_NAME',
        s,
        t = { x: 0, y: 0 },
        size = 0,
        n,
        dir = "x"
      ) => {
        const crystalLine = new THREE.Group()
        crystalLine.debugTypeIndex = window.appConfig.itemAmounts.crystalLine
        crystalLine.debugType = 'CRYSTALLINE'
        crystalLine.debugName = 'CRYSTALLINE' + window.appConfig.itemAmounts.crystalLine
        crystalLine.name = name + '_' + crystalLine.debugName
        let i = 0;
        for (i; i < n; i++) {
          if (dir === "x") {
            crystalLine.add(crystal(size, { x: i * s + t.x, y: t.y, z: 0 }));
          } else {
            crystalLine.add(crystal(size, { x: t.x, y: i * s + t.y, z: 0 }));
          }
        }
        scene.add(crystalLine)
        window.appConfig.itemAmounts.crystalLine++
      };

      const teardownStage = (stage) => {
        // remove all coins
        window.appConfig.coins = []
        const uuidsToRemove = []
        scene.children.forEach(c => {
          if ((c.name.indexOf(stage) > -1) || (c.featureType && c.featureType === "COIN")) {
            uuidsToRemove.push(c.uuid)
          }
        })
        uuidsToRemove.forEach(uuid => {
          const foundIt = scene.children.find(c => c.uuid === uuid)
          scene.remove(foundIt)
        })
      }

      const registerStageObject = (stage, object) => {
        if (typeof object === 'object') {
          window.appConfig.stages[stage][object.name] = object
        } else if (typeof object === 'string') {
          const theObject = scene.children.find((obj) => obj.name === object)
          window.appConfig.stages[stage][theObject.name] = theObject
        }

      }

      window.appConfig.initStageSounds = () => {
        let stageSounds = window.appConfig.stages[window.appConfig.currentStage].sounds
        let howlSounds = window.appConfig.howlSounds
        if (howlSounds.init === false) {
          Howl.prototype.changeSrc = function (newSrc, loop = false) {
            let self = this;
            self.unload();
            self._src = newSrc;
            if (loop === true) {
              self._loop = true;
              self.play()
            }
            self.load();
          }

          howlSounds.init = true

          howlSounds.count1 = loadSound({
            src: "sounds/SFX NEW/COUNT 3.mp3",
            type: 'howlSound'
          })

          howlSounds.count2 = loadSound({
            src: "sounds/SFX NEW/COUNT 2.mp3",
            type: 'howlSound'
          })

          howlSounds.count3 = loadSound({
            src: "sounds/SFX NEW/COUNT 1.mp3",
            type: 'howlSound'
          })

          howlSounds.start = loadSound({
            src: "sounds/SFX NEW/START.mp3",
            type: 'howlSound'
          })

          howlSounds.backgroundMusic = loadSound({
            src: stageSounds.backgroundMusic,
            type: "backgroundMusic",
          })

          window.appConfig.howlSounds.coins.sCoin.push(
            loadSound({
              src: stageSounds.coins.sCoin[0],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.coins.sCoin.push(
            loadSound({
              src: stageSounds.coins.sCoin[1],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.coins.sCoin.push(
            loadSound({
              src: stageSounds.coins.sCoin[2],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.coins.mCoin.push(
            loadSound({
              src: stageSounds.coins.mCoin[0],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.coins.mCoin.push(
            loadSound({
              src: stageSounds.coins.mCoin[1],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.coins.mCoin.push(
            loadSound({
              src: stageSounds.coins.mCoin[2],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.coins.lCoin.push(
            loadSound({
              src: stageSounds.coins.lCoin[0],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.coins.lCoin.push(
            loadSound({
              src: stageSounds.coins.lCoin[1],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.coins.lCoin.push(
            loadSound({
              src: stageSounds.coins.lCoin[2],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.prize = loadSound({
            src: stageSounds.prize,
            type: "howlSound",
          })

          window.appConfig.howlSounds.beams.push(
            loadSound({
              src: stageSounds.beams[0],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.beams.push(
            loadSound({
              src: stageSounds.beams[1],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.beams.push(
            loadSound({
              src: stageSounds.beams[2],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.beams.push(
            loadSound({
              src: stageSounds.beams[3],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.beams.push(
            loadSound({
              src: stageSounds.beams[4],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.beams.push(
            loadSound({
              src: stageSounds.beams[5],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.beams.push(
            loadSound({
              src: stageSounds.beams[6],
              type: "howlSound",
            })
          )

          window.appConfig.howlSounds.beams.push(
            loadSound({
              src: stageSounds.beams[7],
              type: "howlSound",
            })
          )

        } else if (howlSounds.init === true) {
          window.appConfig.howlSounds.backgroundMusic.changeSrc(stageSounds.backgroundMusic, true)
          window.appConfig.howlSounds.prize.changeSrc(stageSounds.prize)

          window.appConfig.howlSounds.coins.sCoin[0].changeSrc(stageSounds.coins.sCoin[0])
          window.appConfig.howlSounds.coins.sCoin[1].changeSrc(stageSounds.coins.sCoin[1])
          window.appConfig.howlSounds.coins.sCoin[2].changeSrc(stageSounds.coins.sCoin[2])

          window.appConfig.howlSounds.coins.mCoin[0].changeSrc(stageSounds.coins.mCoin[0])
          window.appConfig.howlSounds.coins.mCoin[1].changeSrc(stageSounds.coins.mCoin[1])
          window.appConfig.howlSounds.coins.mCoin[2].changeSrc(stageSounds.coins.mCoin[2])

          window.appConfig.howlSounds.coins.lCoin[0].changeSrc(stageSounds.coins.lCoin[0])
          window.appConfig.howlSounds.coins.lCoin[1].changeSrc(stageSounds.coins.lCoin[1])
          window.appConfig.howlSounds.coins.lCoin[2].changeSrc(stageSounds.coins.lCoin[2])

          window.appConfig.howlSounds.beams[0].changeSrc(stageSounds.beams[0])
          window.appConfig.howlSounds.beams[1].changeSrc(stageSounds.beams[1])
          window.appConfig.howlSounds.beams[2].changeSrc(stageSounds.beams[2])
          window.appConfig.howlSounds.beams[3].changeSrc(stageSounds.beams[3])
          window.appConfig.howlSounds.beams[4].changeSrc(stageSounds.beams[4])
          window.appConfig.howlSounds.beams[5].changeSrc(stageSounds.beams[5])
          window.appConfig.howlSounds.beams[6].changeSrc(stageSounds.beams[6])
          window.appConfig.howlSounds.beams[7].changeSrc(stageSounds.beams[7])
        }
      }

      // start stage 0
      window.appConfig.stages = {
        components: {
          createCrystalLine: createCrystalLine,
          createCrystalCircle: createCrystalCircle,
          createCrystalCross: createCrystalCross,
          createStage0MainBeamStructure: (
            scale,
            scaleAdj = 0,
            name,
            p = { x: 0, y: 0 }
          ) => {
            const mainStructure = new Physijs.BoxMesh(
              new THREE.BoxGeometry(0.01, 0.01, 0.01),
              new Physijs.createMaterial(
                new THREE.MeshPhongMaterial({ transparent: true, opacity: 0 }),
                0.6,
                0.3
              ),
              0
            );
            mainStructure.position.set(0 + p.x, 0 + p.y, 1.5);
            mainStructure.add(
              createBeam({
                p: [0 * scale, -8 * scale, -1],
                r: [0, 0, 0],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.add(
              createBeam({
                p: [-8 * scale, 0 * scale, -1],
                r: [0, 0, 0.5 * Math.PI],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.add(
              createBeam({
                p: [8 * scale, 0 * scale, -1],
                r: [0, 0, 0.5 * Math.PI],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.add(
              createBeam({
                p: [0 * scale, 8 * scale, -1],
                r: [0, 0, 0],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.name = name;
            mainStructure.__dirtyPosition = true;
            mainStructure.featureType = "BEAM"
            return mainStructure;
          },
          createStage1MinorBeamStructure: (
            scale,
            scaleAdj = 5,
            name,
            p = { x: 0, y: 0 }
          ) => {
            const minorBeamStructure = new Physijs.BoxMesh(
              new THREE.BoxGeometry(0.01, 0.01, 0.01),
              new Physijs.createMaterial(
                new THREE.MeshPhongMaterial({ transparent: true, opacity: 0 }),
                0.6,
                0.3
              ),
              0
            );
            minorBeamStructure.position.set(0 + p.x, 0 + p.y, 1.5);

            minorBeamStructure.add(
              createBeam({
                p: [20 * scale, 0 * scale, -1],
                r: [0, 0, 0],
                s: (1 + scaleAdj) * scale,
              })
            );

            minorBeamStructure.add(
              createBeam({
                p: [-20 * scale, 0 * scale, -1],
                r: [0, 0, 0],
                s: (1 + scaleAdj) * scale,
              })
            );

            minorBeamStructure.add(
              createBeam({
                p: [0 * scale, -20 * scale, -1],
                r: [0, 0, 0.5 * Math.PI],
                s: (1 + scaleAdj) * scale,
              })
            );

            minorBeamStructure.add(
              createBeam({
                p: [0 * scale, 20 * scale, -1],
                r: [0, 0, 0.5 * Math.PI],
                s: (1 + scaleAdj) * scale,
              })
            );

            minorBeamStructure.name = name;
            minorBeamStructure.__dirtyPosition = true;
            minorBeamStructure.featureType = "BEAM"
            return minorBeamStructure;
          },
          createStage1MainBeamStructure: (
            scale,
            scaleAdj = 5,
            name,
            p = { x: 0, y: 0 }
          ) => {
            const mainStructure = new Physijs.BoxMesh(
              new THREE.BoxGeometry(0.01, 0.01, 0.01),
              new Physijs.createMaterial(
                new THREE.MeshPhongMaterial({ transparent: true, opacity: 0 }),
                0.6,
                0.3
              ),
              0
            );
            mainStructure.position.set(0 + p.x, 0 + p.y, 1.5);
            mainStructure.add(
              createBeam({
                p: [-2 * scale, 4.75 * scale, -1],
                r: [0, 0, 0.5 * Math.PI],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.add(
              createBeam({
                p: [2 * scale, 4.75 * scale, -1],
                r: [0, 0, 0.5 * Math.PI],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.add(
              createBeam({
                p: [-2 * scale, -9.75 * scale, -1],
                r: [0, 0, 0.5 * Math.PI],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.add(
              createBeam({
                p: [2 * scale, -9.75 * scale, -1],
                r: [0, 0, 0.5 * Math.PI],
                s: (1 + scaleAdj) * scale,
              })
            );

            mainStructure.add(
              createBeam({
                p: [7.5 * scale, -1 * scale, -1],
                r: [0, 0, 0],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.add(
              createBeam({
                p: [7.5 * scale, -4 * scale, -1],
                r: [0, 0, 0],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.add(
              createBeam({
                p: [-7.5 * scale, -1 * scale, -1],
                r: [0, 0, 0],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.add(
              createBeam({
                p: [-7.5 * scale, -4 * scale, -1],
                r: [0, 0, 0],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.name = name;
            mainStructure.__dirtyPosition = true;
            mainStructure.featureType = "BEAM"
            return mainStructure;
          },
          createStage3CrossBeamStructure: (
            scale,
            scaleAdj = 5,
            name,
            p = { x: 0, y: 0 }
          ) => {
            const mainStructure = new Physijs.BoxMesh(
              new THREE.BoxGeometry(0.01, 0.01, 0.01),
              new Physijs.createMaterial(
                new THREE.MeshPhongMaterial({ transparent: true, opacity: 0 }),
                0.6,
                0.3
              ),
              0
            );
            mainStructure.position.set(0 + p.x, 0 + p.y, 1.5);
            mainStructure.add(
              createBeam({
                p: [-scale * .5, 0, -1],
                r: [0, 0, 0],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.add(
              createBeam({
                p: [0, scale, -1],
                r: [0, 0, 0.5 * Math.PI],
                s: (1 + scaleAdj) * scale,
              })
            );
            mainStructure.name = name;
            mainStructure.children[1].position.x -= .25
            mainStructure.children[1].position.y -= .25
            mainStructure.children[1].__dirtyPosition = true
            mainStructure.__dirtyPosition = true;
            mainStructure.featureType = "BEAM"
            return mainStructure;
          },
          createStage4PlinkoStructure: (
            scaleX,
            scaleY,
            scaleAdj = 5,
            name,
            p = { x: 0, y: 0 },
            nx = 4,
            ny = 4
          ) => {
            const mainStructure = new Physijs.BoxMesh(
              new THREE.BoxGeometry(0.01, 0.01, 0.01),
              new Physijs.createMaterial(
                new THREE.MeshPhongMaterial({ transparent: true, opacity: 0 }),
                0.6,
                0.3
              ),
              0
            );
            mainStructure.position.set(0 + p.x, 0 + p.y, 1.5);
            let ix
            let iy
            for (iy = 0; iy < ny; iy++) {
              for (ix = 0; ix < nx; ix++) {
                mainStructure.add(
                  createBeam({
                    p: [scaleX * ix * 3, scaleY * iy, -1],
                    r: [0, 0, 0],
                    s: (1 + scaleAdj) * ((scaleX + scaleY) / 2),
                  })
                );
              }
            }
            mainStructure.name = name;
            mainStructure.featureType = "BEAM"
            return mainStructure;
          },
          background: (percentFinished, colors) => {
            return "linear-gradient(180deg, " + colors[0] + " 0%, " + colors[1] + " 0%, " + colors[2] + " " +
              Math.round((1 - percentFinished) * 100) / 3 +
              "%, " + colors[3] + " " +
              Math.round((1 - percentFinished) * 100) +
              "%)";
          }
        },
        STAGE0: {
          data: {
            started: false,
            xAdj: -60,
            vAdj: -70,
            sAdj: 2,
            startingPosition: new THREE.Vector3(0, 0, 0)
          },
          name: stageProperties.STAGE0.name,
          backgroundColors: stageProperties.STAGE0.backgroundColors,
          basicColors: stageProperties.STAGE0.basicColors,
          sounds: stageProperties.STAGE0.sounds,
          defaultTransforms: [
            'STAGE0PRIZE0',
            'STAGE0PRIZE1',
            'STAGE0PRIZE2',
            'STAGE0PRIZE3',
            'STAGE0MAINSTRUCTURE',
            'STAGE0MINORSTRUCTURE',
            'STAGE0MINORSTRUCTURE1',
            'STAGE0MINORSTRUCTURE2',
            'STAGE0MINORSTRUCTURE3'
          ],
          transforms: {
            'STAGE0PRIZE0': { r: { x: .005, y: .005, z: .005 } },
            'STAGE0PRIZE1': { r: { x: .005, y: .005, z: .005 } },
            'STAGE0PRIZE2': { r: { x: .005, y: .005, z: .005 } },
            'STAGE0PRIZE3': { r: { x: .005, y: .005, z: .005 } },
            'STAGE0MAINSTRUCTURE': { r: { x: 0, y: 0, z: .001 } },
            'STAGE0MINORSTRUCTURE': { r: { x: 0, y: 0, z: -.001 } },
            'STAGE0MINORSTRUCTURE1': { r: { x: 0, y: 0, z: -.001 } },
            'STAGE0MINORSTRUCTURE2': { r: { x: 0, y: 0, z: -.001 } },
            'STAGE0MINORSTRUCTURE3': { r: { x: 0, y: 0, z: -.001 } }
          },
          teardown: () => {
            teardownStage('STAGE0')
            window.appConfig.stages.STAGE0.data.started = false
          },
          init: () => {
            window.appConfig.initStageSounds()
            window.appConfig.lighting.hemisphereLight.color = getRandomColor()
            window.appConfig.lighting.hemisphereLight.groundColor = getRandomColor()

            const createBackgroundAnimation = () => {
              const bgGroup = new THREE.Group()
              bgGroup.name = 'STAGE0BGGROUP'
              const elementGeometry = new THREE.IcosahedronGeometry(1, 0)
              const elementMaterials = [
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE0.backgroundColors[0], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE0.backgroundColors[1], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE0.backgroundColors[2], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE0.backgroundColors[3], transparent: true, opacity: .25 }),
              ]

              const numberOfElements = 50
              let elementI = 0
              for (elementI; elementI < numberOfElements; elementI++) {
                bgGroup.add(new THREE.Mesh(elementGeometry, elementMaterials[elementI % elementMaterials.length]))
              }
              scene.add(bgGroup)
              bgGroup.position.set(0, 0, -10)
              bgGroup.children.forEach(c => {
                c.position.set(Math.random() * 200 - 100, Math.random() * 200 - 100, -2 + Math.random() * -10)
                const bgElementScale = 1 + Math.random() * 10
                c.scale.set(bgElementScale, bgElementScale, bgElementScale)
                c.rotation.z = (Math.random() * 2) * Math.PI
              })
              bgGroup.activeCallback = () => {
                if (scene.children.find((obj) => obj.name === "STAGE0BGGROUP")) {
                  scene.children.find((obj) => obj.name === "STAGE0BGGROUP").children.forEach((c, ci) => {
                    c.position.y += .005 * ci / 2
                    c.rotation.y += .005
                    if (c.position.y > 125) {
                      c.position.y = -125
                    }
                    c.scale.set(lfo(500 + ci * 1500) * 10 + 5, lfo(500 + ci * 1750) * 10 + 5, lfo(500 + ci * 2000) * 10 + 5)
                  })
                }
              }
              bgGroup.activeCallback()
              window.appConfig.stages['STAGE0'].bgGroupActiveCallback = bgGroup.activeCallback
            }

            createBackgroundAnimation()


            const createStage0MainBeamStructure = window.appConfig.stages.components.createStage0MainBeamStructure

            const stage0MainBeamStructure = createStage0MainBeamStructure(
              2,
              0,
              "STAGE0MAINSTRUCTURE"
            );
            scene.add(stage0MainBeamStructure);
            const stage0MainBeamStructure1 = createStage0MainBeamStructure(
              4,
              0,
              "STAGE0MAINSTRUCTURE1"
            );
            scene.add(stage0MainBeamStructure1);
            const stage0MainBeamStructure2 = createStage0MainBeamStructure(
              8,
              0.525,
              "STAGE0MAINSTRUCTURE2"
            );
            scene.add(stage0MainBeamStructure2);
            const stage0MinorBeamStructure = createStage0MainBeamStructure(
              1,
              -0.5,
              "STAGE0MINORSTRUCTURE",
              { x: 45, y: 45 }
            );
            scene.add(stage0MinorBeamStructure);
            const stage0MinorBeamStructure1 = createStage0MainBeamStructure(
              1,
              -0.5,
              "STAGE0MINORSTRUCTURE1",
              { x: 45, y: -45 }
            );
            scene.add(stage0MinorBeamStructure1);
            const stage0MinorBeamStructure2 = createStage0MainBeamStructure(
              1,
              -0.5,
              "STAGE0MINORSTRUCTURE2",
              { x: -45, y: -45 }
            );
            scene.add(stage0MinorBeamStructure2);
            const stage0MinorBeamStructure3 = createStage0MainBeamStructure(
              1,
              -0.5,
              "STAGE0MINORSTRUCTURE3",
              { x: -45, y: 45 }
            );
            scene.add(stage0MinorBeamStructure3);

            prize(0, 0, { x: 45, y: 45, z: 0 })
            prize(0, 1, { x: 45, y: -45, z: 0 })
            prize(0, 2, { x: -45, y: -45, z: 0 })
            prize(0, 3, { x: -45, y: 45, z: 0 })

            createCrystalCross('STAGE0', 5);
            createCrystalCross('STAGE0', 10);
            createCrystalCross('STAGE0', 5, { x: 20, y: 20 }, 1);
            createCrystalCross('STAGE0', 5, { x: -20, y: 20 }, 1);
            createCrystalCross('STAGE0', 5, { x: -20, y: -20 }, 1);
            createCrystalCross('STAGE0', 5, { x: 20, y: -20 }, 1);
            createCrystalCross('STAGE0', 3, { x: 55, y: 55 }, 0);
            createCrystalCross('STAGE0', 3, { x: 35, y: 55 }, 0);
            createCrystalCross('STAGE0', 3, { x: 35, y: 35 }, 0);
            createCrystalCross('STAGE0', 3, { x: 55, y: 35 }, 0);
            createCrystalCross('STAGE0', 3, { x: 55, y: -55 }, 0);
            createCrystalCross('STAGE0', 3, { x: 35, y: -55 }, 0);
            createCrystalCross('STAGE0', 3, { x: 35, y: -35 }, 0);
            createCrystalCross('STAGE0', 3, { x: 55, y: -35 }, 0);
            createCrystalCross('STAGE0', 3, { x: -55, y: -55 }, 0);
            createCrystalCross('STAGE0', 3, { x: -35, y: -55 }, 0);
            createCrystalCross('STAGE0', 3, { x: -35, y: -35 }, 0);
            createCrystalCross('STAGE0', 3, { x: -55, y: -35 }, 0);
            createCrystalCross('STAGE0', 3, { x: -55, y: 55 }, 0);
            createCrystalCross('STAGE0', 3, { x: -35, y: 55 }, 0);
            createCrystalCross('STAGE0', 3, { x: -35, y: 35 }, 0);
            createCrystalCross('STAGE0', 3, { x: -55, y: 35 }, 0);
            createCrystalLine('STAGE0', 10, { x: -47.5, y: -20 }, 2, 5, "y");
            createCrystalLine('STAGE0', 5, { x: 54.5, y: -22 }, 0, 10, "y");
            createCrystalLine('STAGE0', 5, { x: 40.5, y: -22.5 }, 0, 10, "y");
            createCrystalLine('STAGE0', 10, { x: 47.5, y: -20 }, 2, 5, "y");
            createCrystalLine('STAGE0', 5, { x: -54.5, y: -22 }, 0, 10, "y");
            createCrystalLine('STAGE0', 5, { x: -40.5, y: -22.5 }, 0, 10, "y");
            createCrystalLine('STAGE0', 10, { x: -20, y: -47.5 }, 2, 5, "x");
            createCrystalLine('STAGE0', 5, { x: -22.5, y: -40 }, 0, 10, "x");
            createCrystalLine('STAGE0', 5, { x: -22.5, y: -54.5 }, 0, 10, "x");
            createCrystalLine('STAGE0', 10, { x: -20, y: 47.5 }, 2, 5, "x");
            createCrystalLine('STAGE0', 5, { x: -22.5, y: 40 }, 0, 10, "x");
            createCrystalLine('STAGE0', 5, { x: -22.5, y: 54.5 }, 0, 10, "x");
            // end stage 0

            window.appConfig.stages.STAGE0.STAGE0PRIZE0 = scene.children.find((obj) => obj.name === "STAGE0PRIZE0")
            window.appConfig.stages.STAGE0.STAGE0PRIZE1 = scene.children.find((obj) => obj.name === "STAGE0PRIZE1")
            window.appConfig.stages.STAGE0.STAGE0PRIZE2 = scene.children.find((obj) => obj.name === "STAGE0PRIZE2")
            window.appConfig.stages.STAGE0.STAGE0PRIZE3 = scene.children.find((obj) => obj.name === "STAGE0PRIZE3")
            window.appConfig.stages.STAGE0.STAGE0MAINSTRUCTURE = scene.children.find((obj) => obj.name === "STAGE0MAINSTRUCTURE")
            window.appConfig.stages.STAGE0.STAGE0MINORSTRUCTURE = scene.children.find((obj) => obj.name === "STAGE0MINORSTRUCTURE")
            window.appConfig.stages.STAGE0.STAGE0MINORSTRUCTURE1 = scene.children.find((obj) => obj.name === "STAGE0MINORSTRUCTURE1")
            window.appConfig.stages.STAGE0.STAGE0MINORSTRUCTURE2 = scene.children.find((obj) => obj.name === "STAGE0MINORSTRUCTURE2")
            window.appConfig.stages.STAGE0.STAGE0MINORSTRUCTURE3 = scene.children.find((obj) => obj.name === "STAGE0MINORSTRUCTURE3")
            window.appConfig.stages.STAGE0.data.started = true
          }
        },
        STAGE1: {
          data: {
            started: false,
            xAdj: -60,
            vAdj: -70,
            sAdj: 2,
            startingPosition: new THREE.Vector3(0, 0, 0)
          },
          backgroundColors: stageProperties.STAGE1.backgroundColors,
          basicColors: stageProperties.STAGE1.basicColors,
          sounds: stageProperties.STAGE1.sounds,
          name: stageProperties.STAGE1.name,
          defaultTransforms: [
            'STAGE1MINORSTRUCTURE',
            'STAGE1MINORSTRUCTUREA',
            'STAGE1MINORSTRUCTUREB',
            'STAGE1MINORSTRUCTURE1',
            'STAGE1MINORSTRUCTURE1A',
            'STAGE1MINORSTRUCTURE1B',
            'STAGE1MINORSTRUCTURE2',
            'STAGE1MINORSTRUCTURE2A',
            'STAGE1MINORSTRUCTURE2B',
            'STAGE1MINORSTRUCTURE3',
            'STAGE1MINORSTRUCTURE3A',
            'STAGE1MINORSTRUCTURE3B',
            'STAGE1PRIZE0',
            'STAGE1PRIZE1',
            'STAGE1PRIZE2',
            'STAGE1PRIZE3'
          ],
          transforms: {
            'STAGE1PRIZE0': { r: { x: .005, y: .005, z: .005 } },
            'STAGE1PRIZE1': { r: { x: .005, y: .005, z: .005 } },
            'STAGE1PRIZE2': { r: { x: .005, y: .005, z: .005 } },
            'STAGE1PRIZE3': { r: { x: .005, y: .005, z: .005 } },
            'STAGE1MINORSTRUCTURE': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE1MINORSTRUCTUREA': { r: { x: 0, y: 0, z: .0025 } },
            'STAGE1MINORSTRUCTUREB': { r: { x: 0, y: 0, z: .0025 } },
            'STAGE1MINORSTRUCTURE1': { r: { x: 0, y: 0, z: .01 } },
            'STAGE1MINORSTRUCTURE1A': { r: { x: 0, y: 0, z: -.0025 } },
            'STAGE1MINORSTRUCTURE1B': { r: { x: 0, y: 0, z: -.0025 } },
            'STAGE1MINORSTRUCTURE2': { r: { x: 0, y: 0, z: .01 } },
            'STAGE1MINORSTRUCTURE2A': { r: { x: 0, y: 0, z: -.0025 } },
            'STAGE1MINORSTRUCTURE2B': { r: { x: 0, y: 0, z: -.0025 } },
            'STAGE1MINORSTRUCTURE3': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE1MINORSTRUCTURE3A': { r: { x: 0, y: 0, z: .0025 } },
            'STAGE1MINORSTRUCTURE3B': { r: { x: 0, y: 0, z: .0025 } },
          },
          teardown: () => {
            teardownStage('STAGE1')
            window.appConfig.stages.STAGE1.data.started = false
          },
          init: () => {
            window.appConfig.initStageSounds()
            window.appConfig.lighting.hemisphereLight.color = getRandomColor()
            window.appConfig.lighting.hemisphereLight.groundColor = getRandomColor()

            const createStage1MainBeamStructure = window.appConfig.stages.components.createStage1MainBeamStructure
            const createStage1MinorBeamStructure = window.appConfig.stages.components.createStage1MinorBeamStructure

            const createBackgroundAnimation = () => {
              const bgGroup = new THREE.Group()
              bgGroup.name = 'STAGE1BGGROUP'
              const elementGeometry = new THREE.BoxGeometry(1, 1, 1)
              const elementMaterials = [
                // new THREE.MeshBasicMaterial({ color: stageProperties.STAGE1.backgroundElementColors[0]}),
                // new THREE.MeshBasicMaterial({ color: stageProperties.STAGE1.backgroundElementColors[1]}),
                // new THREE.MeshBasicMaterial({ color: stageProperties.STAGE1.backgroundElementColors[2]}),
                // new THREE.MeshBasicMaterial({ color: stageProperties.STAGE1.backgroundElementColors[3]}),
                // new THREE.MeshBasicMaterial({ color: stageProperties.STAGE1.backgroundElementColors[4]})
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE1.backgroundColors[0], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE1.backgroundColors[1], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE1.backgroundColors[2], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE1.backgroundColors[3], transparent: true, opacity: .25 }),
                // new THREE.MeshPhongMaterial({ color: stageProperties.STAGE1.backgroundColors[4], transparent: true, opacity: .5})
              ]

              const numberOfElements = 50
              let elementI = 0
              for (elementI; elementI < numberOfElements; elementI++) {
                bgGroup.add(new THREE.Mesh(elementGeometry, elementMaterials[elementI % elementMaterials.length]))
              }
              scene.add(bgGroup)
              bgGroup.position.set(0, 0, -10)
              bgGroup.children.forEach(c => {
                c.position.set(Math.random() * 200 - 100, Math.random() * 200 - 100, -2 + Math.random() * -10)
                const bgElementScale = 1 + Math.random() * 10
                c.scale.set(bgElementScale, bgElementScale, bgElementScale)
                c.rotation.z = (Math.random() * 2) * Math.PI
              })
              bgGroup.activeCallback = () => {
                if (scene.children.find((obj) => obj.name === "STAGE1BGGROUP")) {
                  scene.children.find((obj) => obj.name === "STAGE1BGGROUP").children.forEach((c, ci) => {
                    c.position.y += .005 * ci / 2
                    c.rotation.y += .005
                    if (c.position.y > 125) {
                      c.position.y = -125
                    }
                    c.scale.set(lfo(500 + ci * 1500) * 10 + 5, lfo(500 + ci * 1750) * 10 + 5, lfo(500 + ci * 2000) * 10 + 5)
                  })
                }
              }
              bgGroup.activeCallback()
              window.appConfig.stages['STAGE1'].bgGroupActiveCallback = bgGroup.activeCallback
            }

            createBackgroundAnimation()

            const stage1MainBeamStructure = createStage1MainBeamStructure(
              4,
              0,
              "STAGE1MAINSTRUCTURE",
              { x: 0, y: 10 }
            );
            scene.add(stage1MainBeamStructure);

            const stage1MainBeamStructure1 = window.appConfig.stages.components.createStage0MainBeamStructure(
              12,
              0.56,
              "STAGE1MAINSTRUCTURE1"
            );
            scene.add(stage1MainBeamStructure1);

            const stage1MinorBeamStructure = createStage1MinorBeamStructure(
              .5,
              .5,
              "STAGE1MINORSTRUCTURE",
              { x: 50, y: 50 }
            );
            scene.add(stage1MinorBeamStructure);

            const stage1MinorBeamStructureA = createStage1MinorBeamStructure(
              1.5,
              -.5,
              "STAGE1MINORSTRUCTUREA",
              { x: 50, y: 50 }
            );
            scene.add(stage1MinorBeamStructureA);

            const stage1MinorBeamStructureB = createStage1MinorBeamStructure(
              1.5,
              -.5,
              "STAGE1MINORSTRUCTUREB",
              { x: 50, y: 50 }
            );
            stage1MinorBeamStructureB.rotation.z = .25 * Math.PI
            scene.add(stage1MinorBeamStructureB);



            const stage1MinorBeamStructure1 = createStage1MinorBeamStructure(
              .5,
              .5,
              "STAGE1MINORSTRUCTURE1",
              { x: -50, y: 50 }
            );
            scene.add(stage1MinorBeamStructure1);

            const stage1MinorBeamStructure1A = createStage1MinorBeamStructure(
              1.5,
              -.5,
              "STAGE1MINORSTRUCTURE1A",
              { x: -50, y: 50 }
            );
            scene.add(stage1MinorBeamStructure1A);

            const stage1MinorBeamStructure1B = createStage1MinorBeamStructure(
              1.5,
              -.5,
              "STAGE1MINORSTRUCTURE1B",
              { x: -50, y: 50 }
            );
            stage1MinorBeamStructure1B.rotation.z = -.25 * Math.PI
            scene.add(stage1MinorBeamStructure1B);


            const stage1MinorBeamStructure2 = createStage1MinorBeamStructure(
              .5,
              .5,
              "STAGE1MINORSTRUCTURE2",
              { x: 50, y: -50 }
            );
            scene.add(stage1MinorBeamStructure2);

            const stage1MinorBeamStructure2A = createStage1MinorBeamStructure(
              1.5,
              -.5,
              "STAGE1MINORSTRUCTURE2A",
              { x: 50, y: -50 }
            );
            scene.add(stage1MinorBeamStructure2A);

            const stage1MinorBeamStructure2B = createStage1MinorBeamStructure(
              1.5,
              -.5,
              "STAGE1MINORSTRUCTURE2B",
              { x: 50, y: -50 }
            );
            stage1MinorBeamStructure2B.rotation.z = -.25 * Math.PI
            scene.add(stage1MinorBeamStructure2B);


            const stage1MinorBeamStructure3 = createStage1MinorBeamStructure(
              .5,
              .5,
              "STAGE1MINORSTRUCTURE3",
              { x: -50, y: -50 }
            );
            scene.add(stage1MinorBeamStructure3);

            const stage1MinorBeamStructure3A = createStage1MinorBeamStructure(
              1.5,
              -.5,
              "STAGE1MINORSTRUCTURE3A",
              { x: -50, y: -50 }
            );
            scene.add(stage1MinorBeamStructure3A);

            const stage1MinorBeamStructure3B = createStage1MinorBeamStructure(
              1.5,
              -.5,
              "STAGE1MINORSTRUCTURE3B",
              { x: -50, y: -50 }
            );
            stage1MinorBeamStructure3B.rotation.z = .25 * Math.PI
            scene.add(stage1MinorBeamStructure3B);

            prize(1, 0, { x: 50, y: 50, z: 0 })
            prize(1, 1, { x: 50, y: -50, z: 0 })
            prize(1, 2, { x: -50, y: -50, z: 0 })
            prize(1, 3, { x: -50, y: 50, z: 0 })

            createCrystalCross('STAGE1', 5, { x: 20, y: 19 }, 1);
            createCrystalCross('STAGE1', 5, { x: -20, y: 19 }, 1);
            createCrystalCross('STAGE1', 5, { x: -20, y: -19 }, 1);
            createCrystalCross('STAGE1', 5, { x: 20, y: -19 }, 1);

            createCrystalCross('STAGE1', 5, { x: 85, y: 84 }, 2);
            createCrystalCross('STAGE1', 5, { x: 85, y: -84 }, 2);
            createCrystalCross('STAGE1', 5, { x: -85, y: -84 }, 2);
            createCrystalCross('STAGE1', 5, { x: -85, y: 84 }, 2);

            createCrystalLine('STAGE1', 5, { x: 89.5, y: -35 }, 0, 15, "y");
            createCrystalLine('STAGE1', 5, { x: 75.5, y: -10 }, 0, 5, "y");
            createCrystalLine('STAGE1', 10, { x: 82.5, y: -20 }, 2, 5, "y");
            createCrystalLine('STAGE1', 4, { x: 58, y: 0 }, 1, 4, "x");

            createCrystalLine('STAGE1', 5, { x: -89.5, y: -35 }, 0, 15, "y");
            createCrystalLine('STAGE1', 5, { x: -75.5, y: -10 }, 0, 5, "y");
            createCrystalLine('STAGE1', 10, { x: -82.5, y: -20 }, 2, 5, "y");
            createCrystalLine('STAGE1', 4, { x: -70, y: 0 }, 1, 4, "x");

            createCrystalLine('STAGE1', 5, { x: -35, y: -89.5 }, 0, 15, "x");
            createCrystalLine('STAGE1', 5, { x: -10, y: -75.5 }, 0, 5, "x");
            createCrystalLine('STAGE1', 10, { x: -20, y: -82.5 }, 2, 5, "x");
            createCrystalLine('STAGE1', 4, { x: 0, y: -70 }, 1, 4, "y");

            createCrystalLine('STAGE1', 5, { x: -35, y: 89.5 }, 0, 15, "x");
            createCrystalLine('STAGE1', 5, { x: -10, y: 75.5 }, 0, 5, "x");
            createCrystalLine('STAGE1', 10, { x: -20, y: 82.5 }, 2, 5, "x");
            createCrystalLine('STAGE1', 4, { x: 0, y: 57.5 }, 1, 4, "y");

            createCrystalLine('STAGE1', 5, { x: 0, y: 15 }, 0, 8, "y");

            createCrystalLine('STAGE1', 5, { x: 0, y: -50 }, 0, 8, "y");

            createCrystalLine('STAGE1', 5, { x: 15, y: 0 }, 0, 8, "x");
            createCrystalLine('STAGE1', 5, { x: -50, y: 0 }, 0, 8, "x");

            createCrystalCircle('STAGE1', 4.5, { x: 50, y: 50 }, 1, 4)
            createCrystalCircle('STAGE1', 4.5, { x: 50, y: -50 }, 1, 4)
            createCrystalCircle('STAGE1', 4.5, { x: -50, y: -50 }, 1, 4)
            createCrystalCircle('STAGE1', 4.5, { x: -50, y: 50 }, 1, 4)

            window.appConfig.stages.STAGE1.STAGE1PRIZE0 = scene.children.find((obj) => obj.name === "STAGE1PRIZE0")
            window.appConfig.stages.STAGE1.STAGE1PRIZE1 = scene.children.find((obj) => obj.name === "STAGE1PRIZE1")
            window.appConfig.stages.STAGE1.STAGE1PRIZE2 = scene.children.find((obj) => obj.name === "STAGE1PRIZE2")
            window.appConfig.stages.STAGE1.STAGE1PRIZE3 = scene.children.find((obj) => obj.name === "STAGE1PRIZE3")
            window.appConfig.stages.STAGE1.STAGE1MAINSTRUCTURE = scene.children.find((obj) => obj.name === "STAGE1MAINSTRUCTURE")
            window.appConfig.stages.STAGE1.STAGE1MINORSTRUCTURE = scene.children.find((obj) => obj.name === "STAGE1MINORSTRUCTURE")
            window.appConfig.stages.STAGE1.STAGE1MINORSTRUCTUREA = scene.children.find((obj) => obj.name === "STAGE1MINORSTRUCTUREA")
            window.appConfig.stages.STAGE1.STAGE1MINORSTRUCTUREB = scene.children.find((obj) => obj.name === "STAGE1MINORSTRUCTUREB")
            window.appConfig.stages.STAGE1.STAGE1MINORSTRUCTURE1 = scene.children.find((obj) => obj.name === "STAGE1MINORSTRUCTURE1")
            window.appConfig.stages.STAGE1.STAGE1MINORSTRUCTURE1A = scene.children.find((obj) => obj.name === "STAGE1MINORSTRUCTURE1A")
            window.appConfig.stages.STAGE1.STAGE1MINORSTRUCTURE1B = scene.children.find((obj) => obj.name === "STAGE1MINORSTRUCTURE1B")
            window.appConfig.stages.STAGE1.STAGE1MINORSTRUCTURE2 = scene.children.find((obj) => obj.name === "STAGE1MINORSTRUCTURE2")
            window.appConfig.stages.STAGE1.STAGE1MINORSTRUCTURE2A = scene.children.find((obj) => obj.name === "STAGE1MINORSTRUCTURE2A")
            window.appConfig.stages.STAGE1.STAGE1MINORSTRUCTURE2B = scene.children.find((obj) => obj.name === "STAGE1MINORSTRUCTURE2B")
            window.appConfig.stages.STAGE1.STAGE1MINORSTRUCTURE3 = scene.children.find((obj) => obj.name === "STAGE1MINORSTRUCTURE3")
            window.appConfig.stages.STAGE1.STAGE1MINORSTRUCTURE3A = scene.children.find((obj) => obj.name === "STAGE1MINORSTRUCTURE3A")
            window.appConfig.stages.STAGE1.STAGE1MINORSTRUCTURE3B = scene.children.find((obj) => obj.name === "STAGE1MINORSTRUCTURE3B")
            window.appConfig.stages.STAGE1.data.started = true
          }
        },
        STAGE2: {
          data: {
            started: false,
            xAdj: -60,
            vAdj: -70,
            sAdj: 2,
            startingPosition: new THREE.Vector3(0, 0, 0)
          },
          backgroundColors: stageProperties.STAGE2.backgroundColors,
          basicColors: stageProperties.STAGE2.basicColors,
          sounds: stageProperties.STAGE2.sounds,
          name: stageProperties.STAGE2.name,
          defaultTransforms: [
            'STAGE2PRIZE0',
            'STAGE2PRIZE1',
            'STAGE2PRIZE2',
            'STAGE2PRIZE3',
            'STAGE2MINORSTRUCTURE',
            'STAGE2MINORSTRUCTUREA',
            'STAGE2MINORSTRUCTUREB',
            'STAGE2MINORSTRUCTUREROTATION',
            'STAGE2MINORSTRUCTUREROTATIONA',
            'STAGE2MINORSTRUCTUREROTATIONB',
            'STAGE2MINORSTRUCTUREROTATIONC'
          ],
          transforms: {
            'STAGE2PRIZE0': { r: { x: .005, y: .005, z: .005 } },
            'STAGE2PRIZE1': { r: { x: .005, y: .005, z: .005 } },
            'STAGE2PRIZE2': { r: { x: .005, y: .005, z: .005 } },
            'STAGE2PRIZE3': { r: { x: .005, y: .005, z: .005 } },
            'STAGE2MINORSTRUCTURE': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE2MINORSTRUCTUREA': { r: { x: 0, y: 0, z: .0025 } },
            'STAGE2MINORSTRUCTUREB': { r: { x: 0, y: 0, z: .0025 } },
            'STAGE2MINORSTRUCTUREROTATION': { r: { x: 0, y: 0, z: -.0025 } },
            'STAGE2MINORSTRUCTUREROTATIONA': { r: { x: 0, y: 0, z: -.0025 } },
            'STAGE2MINORSTRUCTUREROTATIONB': { r: { x: 0, y: 0, z: -.0025 } },
            'STAGE2MINORSTRUCTUREROTATIONC': { r: { x: 0, y: 0, z: -.0025 } }
          },
          teardown: () => {
            teardownStage('STAGE2')
            window.appConfig.stages.STAGE2.data.started = false
          },
          init: () => {
            window.appConfig.initStageSounds()
            window.appConfig.lighting.hemisphereLight.color = getRandomColor()
            window.appConfig.lighting.hemisphereLight.groundColor = getRandomColor()

            const createBackgroundAnimation = () => {
              const bgGroup = new THREE.Group()
              bgGroup.name = 'STAGE2BGGROUP'
              const elementGeometry = new THREE.CylinderGeometry(
                1,
                1,
                1,
                Math.ceil(Math.random() * 16 + 2)
              )
              const elementMaterials = [
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE2.backgroundColors[0], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE2.backgroundColors[1], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE2.backgroundColors[2], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE2.backgroundColors[3], transparent: true, opacity: .25 }),
              ]

              const numberOfElements = 50
              let elementI = 0
              for (elementI; elementI < numberOfElements; elementI++) {
                bgGroup.add(new THREE.Mesh(elementGeometry, elementMaterials[elementI % elementMaterials.length]))
              }
              scene.add(bgGroup)
              bgGroup.position.set(0, 0, -10)
              bgGroup.children.forEach(c => {
                c.position.set(Math.random() * 200 - 100, Math.random() * 200 - 100, -2 + Math.random() * -10)
                const bgElementScale = 1 + Math.random() * 10
                c.scale.set(bgElementScale, bgElementScale, bgElementScale)
                c.rotation.z = (Math.random() * 2) * Math.PI
              })
              bgGroup.activeCallback = () => {
                if (scene.children.find((obj) => obj.name === "STAGE2BGGROUP")) {
                  scene.children.find((obj) => obj.name === "STAGE2BGGROUP").children.forEach((c, ci) => {
                    c.position.y += .005 * ci / 2
                    c.rotation.y += .005
                    if (c.position.y > 125) {
                      c.position.y = -125
                    }
                    c.scale.set(lfo(500 + ci * 1500) * 10 + 5, lfo(500 + ci * 1750) * 10 + 5, lfo(500 + ci * 2000) * 10 + 5)
                  })
                }
              }
              bgGroup.activeCallback()
              window.appConfig.stages['STAGE2'].bgGroupActiveCallback = bgGroup.activeCallback
            }

            createBackgroundAnimation()


            const createStage0MainBeamStructure = window.appConfig.stages.components.createStage0MainBeamStructure
            const createStage1MinorBeamStructure = window.appConfig.stages.components.createStage1MinorBeamStructure

            const stage2MainBeamStructure = createStage0MainBeamStructure(
              5,
              0,
              "STAGE2MAINSTRUCTURE",
              { x: 0, y: 0 }
            );
            scene.add(stage2MainBeamStructure);

            const stage2MainBeamStructure2 = createStage0MainBeamStructure(
              8,
              0,
              "STAGE2MAINSTRUCTURE",
              { x: 0, y: 0 }
            );
            scene.add(stage2MainBeamStructure2);

            const stage2MainBeamStructure1 = window.appConfig.stages.components.createStage0MainBeamStructure(
              12,
              0.56,
              "STAGE2MAINSTRUCTURE1"
            );
            stage2MainBeamStructure1.rotation.z = .25 * Math.PI
            scene.add(stage2MainBeamStructure1);

            const stage2MinorBeamStructure = createStage1MinorBeamStructure(
              .5,
              .5,
              "STAGE2MINORSTRUCTURE",
              { x: 0, y: 0 }
            );
            scene.add(stage2MinorBeamStructure);

            const stage2MinorBeamStructureA = createStage1MinorBeamStructure(
              1.5,
              -.5,
              "STAGE2MINORSTRUCTUREA",
              { x: 0, y: 0 }
            );
            scene.add(stage2MinorBeamStructureA);

            const stage2MinorBeamStructureB = createStage1MinorBeamStructure(
              1.5,
              -.5,
              "STAGE2MINORSTRUCTUREB",
              { x: 0, y: 0 }
            );
            stage2MinorBeamStructureB.rotation.z = .25 * Math.PI
            scene.add(stage2MinorBeamStructureB);


            const stage2MinorBeamStructureRotation = createStage0MainBeamStructure(
              1,
              -0.5,
              "STAGE2MINORSTRUCTUREROTATION",
              { x: 50, y: 50 }
            );
            scene.add(stage2MinorBeamStructureRotation);
            const stage2MinorBeamStructureRotationA = createStage0MainBeamStructure(
              1,
              -0.5,
              "STAGE2MINORSTRUCTUREROTATIONA",
              { x: 50, y: -50 }
            );
            scene.add(stage2MinorBeamStructureRotationA);
            const stage2MinorBeamStructureRotationB = createStage0MainBeamStructure(
              1,
              -0.5,
              "STAGE2MINORSTRUCTUREROTATIONB",
              { x: -50, y: -50 }
            );
            scene.add(stage2MinorBeamStructureRotationB);
            const stage2MinorBeamStructureRotationC = createStage0MainBeamStructure(
              1,
              -0.5,
              "STAGE2MINORSTRUCTUREROTATIONC",
              { x: -50, y: 50 }
            );
            scene.add(stage2MinorBeamStructureRotationC);

            prize(2, 0, { x: 50, y: 50, z: 0 })
            prize(2, 1, { x: 50, y: -50, z: 0 })
            prize(2, 2, { x: -50, y: -50, z: 0 })
            prize(2, 3, { x: -50, y: 50, z: 0 })

            createCrystalCross('STAGE2', 5, { x: 90, y: 0 }, 0);
            createCrystalCross('STAGE2', 5, { x: 110, y: 0 }, 2);
            createCrystalCross('STAGE2', 5, { x: 100, y: 10 }, 1);
            createCrystalCross('STAGE2', 5, { x: 100, y: -10 }, 1);

            createCrystalCross('STAGE2', 5, { x: -90, y: 0 }, 0);
            createCrystalCross('STAGE2', 5, { x: -110, y: 0 }, 2);
            createCrystalCross('STAGE2', 5, { x: -100, y: 10 }, 1);
            createCrystalCross('STAGE2', 5, { x: -100, y: -10 }, 1);

            createCrystalCross('STAGE2', 5, { x: 0, y: -90 }, 0);
            createCrystalCross('STAGE2', 5, { x: 0, y: -110 }, 2);
            createCrystalCross('STAGE2', 5, { x: 10, y: -100 }, 1);
            createCrystalCross('STAGE2', 5, { x: -10, y: -100 }, 1);

            createCrystalCross('STAGE2', 5, { x: 0, y: 90 }, 0);
            createCrystalCross('STAGE2', 5, { x: 0, y: 110 }, 2);
            createCrystalCross('STAGE2', 5, { x: 10, y: 100 }, 1);
            createCrystalCross('STAGE2', 5, { x: -10, y: 100 }, 1);

            createCrystalLine('STAGE2', 5, { x: -35, y: 70.5 }, 0, 15, "x");
            createCrystalLine('STAGE2', 10, { x: -20, y: 77.5 }, 2, 5, "x");
            createCrystalLine('STAGE2', 5, { x: -35, y: 57.5 }, 0, 15, "x");
            createCrystalLine('STAGE2', 10, { x: -20, y: 50.5 }, 1, 5, "x");

            createCrystalLine('STAGE2', 5, { x: -35, y: -70.5 }, 0, 15, "x");
            createCrystalLine('STAGE2', 10, { x: -20, y: -77.5 }, 2, 5, "x");
            createCrystalLine('STAGE2', 5, { x: -35, y: -57.5 }, 0, 15, "x");
            createCrystalLine('STAGE2', 10, { x: -20, y: -50.5 }, 1, 5, "x");

            createCrystalLine('STAGE2', 5, { x: -70.5, y: -35 }, 0, 15, "y");
            createCrystalLine('STAGE2', 10, { x: -77.5, y: -20 }, 2, 5, "y");
            createCrystalLine('STAGE2', 5, { x: -57.5, y: -35 }, 0, 15, "y");
            createCrystalLine('STAGE2', 10, { x: -50.5, y: -20 }, 1, 5, "y");

            createCrystalLine('STAGE2', 5, { x: 70.5, y: -35 }, 0, 15, "y");
            createCrystalLine('STAGE2', 10, { x: 77.5, y: -20 }, 2, 5, "y");
            createCrystalLine('STAGE2', 5, { x: 57.5, y: -35 }, 0, 15, "y");
            createCrystalLine('STAGE2', 10, { x: 50.5, y: -20 }, 1, 5, "y");

            createCrystalCircle('STAGE2', 4.5, { x: 0, y: 0 }, 1, 4)

            window.appConfig.stages.STAGE2.STAGE2PRIZE0 = scene.children.find((obj) => obj.name === "STAGE2PRIZE0")
            window.appConfig.stages.STAGE2.STAGE2PRIZE1 = scene.children.find((obj) => obj.name === "STAGE2PRIZE1")
            window.appConfig.stages.STAGE2.STAGE2PRIZE2 = scene.children.find((obj) => obj.name === "STAGE2PRIZE2")
            window.appConfig.stages.STAGE2.STAGE2PRIZE3 = scene.children.find((obj) => obj.name === "STAGE2PRIZE3")
            window.appConfig.stages.STAGE2.STAGE2MAINSTRUCTURE = scene.children.find((obj) => obj.name === "STAGE2MAINSTRUCTURE")
            window.appConfig.stages.STAGE2.STAGE2MINORSTRUCTURE = scene.children.find((obj) => obj.name === "STAGE2MINORSTRUCTURE")
            window.appConfig.stages.STAGE2.STAGE2MINORSTRUCTUREA = scene.children.find((obj) => obj.name === "STAGE2MINORSTRUCTUREA")
            window.appConfig.stages.STAGE2.STAGE2MINORSTRUCTUREB = scene.children.find((obj) => obj.name === "STAGE2MINORSTRUCTUREB")

            window.appConfig.stages.STAGE2.STAGE2MINORSTRUCTUREROTATION = scene.children.find((obj) => obj.name === "STAGE2MINORSTRUCTUREROTATION")
            window.appConfig.stages.STAGE2.STAGE2MINORSTRUCTUREROTATIONA = scene.children.find((obj) => obj.name === "STAGE2MINORSTRUCTUREROTATIONA")
            window.appConfig.stages.STAGE2.STAGE2MINORSTRUCTUREROTATIONB = scene.children.find((obj) => obj.name === "STAGE2MINORSTRUCTUREROTATIONB")
            window.appConfig.stages.STAGE2.STAGE2MINORSTRUCTUREROTATIONC = scene.children.find((obj) => obj.name === "STAGE2MINORSTRUCTUREROTATIONC")

            window.appConfig.stages.STAGE2.data.started = true
          }
        },
        STAGE3: {
          data: {
            started: false,
            xAdj: -60,
            vAdj: -70,
            sAdj: 2,
            startingPosition: new THREE.Vector3(0, 0, 0)
          },
          backgroundColors: stageProperties.STAGE3.backgroundColors,
          basicColors: stageProperties.STAGE3.basicColors,
          sounds: stageProperties.STAGE3.sounds,
          name: stageProperties.STAGE3.name,
          defaultTransforms: [
            'STAGE3PRIZE0',
            'STAGE3PRIZE1',
            'STAGE3PRIZE2',
            'STAGE3PRIZE3',
            'STAGE3MAINSTRUCTURE',
            'STAGE3MAINSTRUCTUREA',
            'STAGE3MAINSTRUCTUREB',
            'STAGE3MAINSTRUCTUREC',
            'STAGE3MAINSTRUCTURED',
            'STAGE3MAINSTRUCTUREE',
            'STAGE3CROSSBEAMSTRUCTURE',
            'STAGE3CROSSBEAMSTRUCTUREA',
            'STAGE3CROSSBEAMSTRUCTUREB',
            'STAGE3CROSSBEAMSTRUCTUREC',
            'STAGE3CROSSBEAMSTRUCTURE1',
            'STAGE3CROSSBEAMSTRUCTURE1A',
            'STAGE3CROSSBEAMSTRUCTURE1B',
            'STAGE3CROSSBEAMSTRUCTURE1C',
            'STAGE3CROSSBEAMSTRUCTURE2',
            'STAGE3CROSSBEAMSTRUCTURE2A',
            'STAGE3CROSSBEAMSTRUCTURE2B',
            'STAGE3CROSSBEAMSTRUCTURE2C',
            'STAGE3CROSSBEAMSTRUCTURE3',
            'STAGE3CROSSBEAMSTRUCTURE3A',
            'STAGE3CROSSBEAMSTRUCTURE3B',
            'STAGE3CROSSBEAMSTRUCTURE3C'
          ],
          transforms: {
            'STAGE3PRIZE0': { r: { x: .005, y: .005, z: .005 } },
            'STAGE3PRIZE1': { r: { x: .005, y: .005, z: .005 } },
            'STAGE3PRIZE2': { r: { x: .005, y: .005, z: .005 } },
            'STAGE3PRIZE3': { r: { x: .005, y: .005, z: .005 } },
            'STAGE3MAINSTRUCTURE': { r: { x: 0, y: 0, z: -.005 } },
            'STAGE3MAINSTRUCTUREA': { r: { x: 0, y: 0, z: -.005 } },
            'STAGE3MAINSTRUCTUREB': { r: { x: 0, y: 0, z: -.005 } },
            'STAGE3MAINSTRUCTUREC': { r: { x: 0, y: 0, z: -.005 } },
            'STAGE3MAINSTRUCTURED': { r: { x: 0, y: 0, z: .005 } },
            'STAGE3MAINSTRUCTUREE': { r: { x: 0, y: 0, z: .005 } },
            'STAGE3CROSSBEAMSTRUCTURE': { r: { x: 0, y: 0, z: .01 } },
            'STAGE3CROSSBEAMSTRUCTUREA': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE3CROSSBEAMSTRUCTUREB': { r: { x: 0, y: 0, z: .01 } },
            'STAGE3CROSSBEAMSTRUCTUREC': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE3CROSSBEAMSTRUCTURE1': { r: { x: 0, y: 0, z: .01 } },
            'STAGE3CROSSBEAMSTRUCTURE1A': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE3CROSSBEAMSTRUCTURE1B': { r: { x: 0, y: 0, z: .01 } },
            'STAGE3CROSSBEAMSTRUCTURE1C': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE3CROSSBEAMSTRUCTURE2': { r: { x: 0, y: 0, z: .01 } },
            'STAGE3CROSSBEAMSTRUCTURE2A': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE3CROSSBEAMSTRUCTURE2B': { r: { x: 0, y: 0, z: .01 } },
            'STAGE3CROSSBEAMSTRUCTURE2C': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE3CROSSBEAMSTRUCTURE3': { r: { x: 0, y: 0, z: .01 } },
            'STAGE3CROSSBEAMSTRUCTURE3A': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE3CROSSBEAMSTRUCTURE3B': { r: { x: 0, y: 0, z: .01 } },
            'STAGE3CROSSBEAMSTRUCTURE3C': { r: { x: 0, y: 0, z: -.01 } }
          },
          teardown: () => {
            teardownStage('STAGE3')
            window.appConfig.stages.STAGE3.data.started = false
          },
          init: () => {
            window.appConfig.initStageSounds()
            window.appConfig.lighting.hemisphereLight.color = getRandomColor()
            window.appConfig.lighting.hemisphereLight.groundColor = getRandomColor()


            const createBackgroundAnimation = () => {
              const bgGroup = new THREE.Group()
              bgGroup.name = 'STAGE3BGGROUP'
              const elementGeometry = new THREE.TetrahedronGeometry(1)
              const elementMaterials = [
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE3.backgroundColors[0], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE3.backgroundColors[1], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE3.backgroundColors[2], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE3.backgroundColors[3], transparent: true, opacity: .25 }),
              ]

              const numberOfElements = 50
              let elementI = 0
              for (elementI; elementI < numberOfElements; elementI++) {
                bgGroup.add(new THREE.Mesh(elementGeometry, elementMaterials[elementI % elementMaterials.length]))
              }
              scene.add(bgGroup)
              bgGroup.position.set(0, 0, -10)
              bgGroup.children.forEach(c => {
                c.position.set(Math.random() * 200 - 100, Math.random() * 200 - 100, -2 + Math.random() * -10)
                const bgElementScale = 1 + Math.random() * 10
                c.scale.set(bgElementScale, bgElementScale, bgElementScale)
                c.rotation.z = (Math.random() * 2) * Math.PI
              })
              bgGroup.activeCallback = () => {
                if (scene.children.find((obj) => obj.name === "STAGE3BGGROUP")) {
                  scene.children.find((obj) => obj.name === "STAGE3BGGROUP").children.forEach((c, ci) => {
                    c.position.y += .005 * ci / 2
                    c.rotation.y += .005
                    if (c.position.y > 125) {
                      c.position.y = -125
                    }
                    c.scale.set(lfo(500 + ci * 1500) * 10 + 5, lfo(500 + ci * 1750) * 10 + 5, lfo(500 + ci * 2000) * 10 + 5)
                  })
                }
              }
              bgGroup.activeCallback()
              window.appConfig.stages['STAGE3'].bgGroupActiveCallback = bgGroup.activeCallback
            }

            createBackgroundAnimation()

            const createStage0MainBeamStructure = window.appConfig.stages.components.createStage0MainBeamStructure
            const createStage1MinorBeamStructure = window.appConfig.stages.components.createStage1MinorBeamStructure
            const createStage3CrossBeamStructure = window.appConfig.stages.components.createStage3CrossBeamStructure

            const stage3MainBeamStructure = createStage0MainBeamStructure(
              6,
              -0.85,
              "STAGE3MAINSTRUCTURE",
              { x: 0, y: 0 }
            );
            scene.add(stage3MainBeamStructure);

            const stage3MainBeamStructureA = createStage0MainBeamStructure(
              6,
              -0.85,
              "STAGE3MAINSTRUCTUREA",
              { x: 0, y: 0 }
            );
            stage3MainBeamStructureA.rotation.z = .25 * Math.PI
            scene.add(stage3MainBeamStructureA);

            const stage3MainBeamStructureB = createStage0MainBeamStructure(
              9,
              -0.85,
              "STAGE3MAINSTRUCTUREB",
              { x: 0, y: 0 }
            );
            scene.add(stage3MainBeamStructureB);

            const stage3MainBeamStructureC = createStage0MainBeamStructure(
              9,
              -0.85,
              "STAGE3MAINSTRUCTUREC",
              { x: 0, y: 0 }
            );
            stage3MainBeamStructureC.rotation.z = .25 * Math.PI
            scene.add(stage3MainBeamStructureC);

            const stage3MainBeamStructureD = createStage0MainBeamStructure(
              7.5,
              -0.85,
              "STAGE3MAINSTRUCTURED",
              { x: 0, y: 0 }
            );
            scene.add(stage3MainBeamStructureD);

            const stage3MainBeamStructureE = createStage0MainBeamStructure(
              7.5,
              -0.85,
              "STAGE3MAINSTRUCTUREE",
              { x: 0, y: 0 }
            );
            stage3MainBeamStructureE.rotation.z = .25 * Math.PI
            scene.add(stage3MainBeamStructureE);

            const stage3MainBeamStructureF = createStage0MainBeamStructure(
              1,
              -.5,
              "STAGE3MAINSTRUCTUREF",
              { x: 0, y: 0 }
            );
            scene.add(stage3MainBeamStructureF);

            const stage3MainBeamStructure1 = window.appConfig.stages.components.createStage0MainBeamStructure(
              12,
              0.56,
              "STAGE3MAINSTRUCTURE1"
            );
            stage3MainBeamStructure1.rotation.z = .25 * Math.PI
            scene.add(stage3MainBeamStructure1);

            const stage3CrossBeamStructure = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE",
              { x: 0, y: 115 }
            );
            scene.add(stage3CrossBeamStructure);

            const stage3CrossBeamStructureA = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTUREA",
              { x: 15, y: 100 }
            );
            scene.add(stage3CrossBeamStructureA);

            const stage3CrossBeamStructureB = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTUREB",
              { x: -15, y: 100 }
            );
            scene.add(stage3CrossBeamStructureB);

            const stage3CrossBeamStructureC = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTUREC",
              { x: 0, y: 85 }
            );
            scene.add(stage3CrossBeamStructureC);

            const stage3CrossBeamStructure1 = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE1",
              { x: 0, y: -115 }
            );
            scene.add(stage3CrossBeamStructure1);

            const stage3CrossBeamStructure1A = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE1A",
              { x: 15, y: -100 }
            );
            scene.add(stage3CrossBeamStructure1A);

            const stage3CrossBeamStructure1B = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE1B",
              { x: -15, y: -100 }
            );
            scene.add(stage3CrossBeamStructure1B);

            const stage3CrossBeamStructure1C = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE1C",
              { x: 0, y: -85 }
            );
            scene.add(stage3CrossBeamStructure1C);

            const stage3CrossBeamStructure2 = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE2",
              { x: -115, y: 0 }
            );
            scene.add(stage3CrossBeamStructure2);

            const stage3CrossBeamStructure2A = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE2A",
              { x: -100, y: 15 }
            );
            scene.add(stage3CrossBeamStructure2A);

            const stage3CrossBeamStructure2B = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE2B",
              { x: -100, y: -15 }
            );
            scene.add(stage3CrossBeamStructure2B);

            const stage3CrossBeamStructure2C = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE2C",
              { x: -85, y: 0 }
            );
            scene.add(stage3CrossBeamStructure2C);



            const stage3CrossBeamStructure3 = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE3",
              { x: 115, y: 0 }
            );
            scene.add(stage3CrossBeamStructure3);

            const stage3CrossBeamStructure3A = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE3A",
              { x: 100, y: 15 }
            );
            scene.add(stage3CrossBeamStructure3A);

            const stage3CrossBeamStructure3B = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE3B",
              { x: 100, y: -15 }
            );
            scene.add(stage3CrossBeamStructure3B);

            const stage3CrossBeamStructure3C = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE3CROSSBEAMSTRUCTURE3C",
              { x: 85, y: 0 }
            );
            scene.add(stage3CrossBeamStructure3C);

            prize(3, 0, { x: 100, y: 0, z: 0 })
            prize(3, 1, { x: 0, y: 100, z: 0 })
            prize(3, 2, { x: -100, y: 0, z: 0 })
            prize(3, 3, { x: 0, y: -100, z: 0 })

            createCrystalCross('STAGE3', 5, { x: -30, y: 85 }, 2);
            createCrystalCross('STAGE3', 5, { x: 30, y: 85 }, 2);
            createCrystalCross('STAGE3', 5, { x: -30, y: -85 }, 2);
            createCrystalCross('STAGE3', 5, { x: 30, y: -85 }, 2);

            createCrystalCross('STAGE3', 5, { x: 85, y: -30 }, 2);
            createCrystalCross('STAGE3', 5, { x: 85, y: 30 }, 2);
            createCrystalCross('STAGE3', 5, { x: -85, y: -30 }, 2);
            createCrystalCross('STAGE3', 5, { x: -85, y: 30 }, 2);

            createCrystalCircle('STAGE3', 4, { x: 0, y: 0 }, 0, 8)
            createCrystalCircle('STAGE3', 4.5, { x: 0, y: 0 }, 1, 8)
            createCrystalCircle('STAGE3', 5, { x: 0, y: 0 }, 2, 8)
            createCrystalCircle('STAGE3', 5.5, { x: 0, y: 0 }, 1, 8)
            createCrystalCircle('STAGE3', 6, { x: 0, y: 0 }, 0, 8)
            createCrystalCircle('STAGE3', 7.375, { x: 0, y: 0 }, 0, 32)
            createCrystalCircle('STAGE3', 8.125, { x: 0, y: 0 }, 1, 32)
            createCrystalCircle('STAGE3', 8.75, { x: 0, y: 0 }, 0, 32)

            window.appConfig.stages.STAGE3.STAGE3PRIZE0 = scene.children.find((obj) => obj.name === "STAGE3PRIZE0")
            window.appConfig.stages.STAGE3.STAGE3PRIZE1 = scene.children.find((obj) => obj.name === "STAGE3PRIZE1")
            window.appConfig.stages.STAGE3.STAGE3PRIZE2 = scene.children.find((obj) => obj.name === "STAGE3PRIZE2")
            window.appConfig.stages.STAGE3.STAGE3PRIZE3 = scene.children.find((obj) => obj.name === "STAGE3PRIZE3")
            window.appConfig.stages.STAGE3.STAGE3MAINSTRUCTURE = scene.children.find((obj) => obj.name === "STAGE3MAINSTRUCTURE")
            window.appConfig.stages.STAGE3.STAGE3MAINSTRUCTUREA = scene.children.find((obj) => obj.name === "STAGE3MAINSTRUCTUREA")
            window.appConfig.stages.STAGE3.STAGE3MAINSTRUCTUREB = scene.children.find((obj) => obj.name === "STAGE3MAINSTRUCTUREB")
            window.appConfig.stages.STAGE3.STAGE3MAINSTRUCTUREC = scene.children.find((obj) => obj.name === "STAGE3MAINSTRUCTUREC")
            window.appConfig.stages.STAGE3.STAGE3MAINSTRUCTURED = scene.children.find((obj) => obj.name === "STAGE3MAINSTRUCTURED")
            window.appConfig.stages.STAGE3.STAGE3MAINSTRUCTUREE = scene.children.find((obj) => obj.name === "STAGE3MAINSTRUCTUREE")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTUREA = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTUREA")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTUREB = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTUREB")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTUREC = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTUREC")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE1 = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE1")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE1A = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE1A")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE1B = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE1B")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE1C = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE1C")

            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE2 = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE2")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE2A = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE2A")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE2B = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE2B")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE2C = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE2C")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE3 = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE3")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE3A = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE3A")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE3B = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE3B")
            window.appConfig.stages.STAGE3.STAGE3CROSSBEAMSTRUCTURE3C = scene.children.find((obj) => obj.name === "STAGE3CROSSBEAMSTRUCTURE3C")

            window.appConfig.stages.STAGE3.data.started = true
          }
        },
        STAGE4: {
          data: {
            started: false,
            xAdj: -60,
            vAdj: -70,
            sAdj: 2,
            startingPosition: new THREE.Vector3(0, 0, 0)
          },
          backgroundColors: stageProperties.STAGE4.backgroundColors,
          basicColors: stageProperties.STAGE4.basicColors,
          sounds: stageProperties.STAGE4.sounds,
          name: stageProperties.STAGE4.name,
          defaultTransforms: [
            'STAGE4PRIZE0',
            'STAGE4PRIZE1',
            'STAGE4PRIZE2',
            'STAGE4PRIZE3',
            'STAGE4MAINSTRUCTURE1',
            'STAGE4MAINSTRUCTURE2',
            'STAGE4CROSSBEAMSTRUCTURE',
            'STAGE4CROSSBEAMSTRUCTUREA',
            'STAGE4CROSSBEAMSTRUCTUREB',
            'STAGE4CROSSBEAMSTRUCTUREC',
            'STAGE4CROSSBEAMSTRUCTURED',
            'STAGE4MAINSTRUCTURE3',
            'STAGE4MAINSTRUCTURE4',
            'STAGE4CROSSBEAMSTRUCTURE1',
            'STAGE4CROSSBEAMSTRUCTURE1A',
            'STAGE4CROSSBEAMSTRUCTURE1B',
            'STAGE4CROSSBEAMSTRUCTURE1C',
            'STAGE4CROSSBEAMSTRUCTURE1D',
            'STAGE4MAINSTRUCTURE5',
            'STAGE4MAINSTRUCTURE6',
            'STAGE4CROSSBEAMSTRUCTURE2',
            'STAGE4CROSSBEAMSTRUCTURE2A',
            'STAGE4CROSSBEAMSTRUCTURE2B',
            'STAGE4CROSSBEAMSTRUCTURE2C',
            'STAGE4CROSSBEAMSTRUCTURE2D',
            'STAGE4MAINSTRUCTURE7',
            'STAGE4MAINSTRUCTURE8',
            'STAGE4CROSSBEAMSTRUCTURE3',
            'STAGE4CROSSBEAMSTRUCTURE3A',
            'STAGE4CROSSBEAMSTRUCTURE3B',
            'STAGE4CROSSBEAMSTRUCTURE3C',
            'STAGE4CROSSBEAMSTRUCTURE3D'
          ],
          transforms: {
            'STAGE4PRIZE0': { r: { x: .005, y: .005, z: .005 } },
            'STAGE4PRIZE1': { r: { x: .005, y: .005, z: .005 } },
            'STAGE4PRIZE2': { r: { x: .005, y: .005, z: .005 } },
            'STAGE4PRIZE3': { r: { x: .005, y: .005, z: .005 } },
            'STAGE4MAINSTRUCTURE1': { r: { x: 0, y: 0, z: -.005 } },
            'STAGE4MAINSTRUCTURE2': { r: { x: 0, y: 0, z: .005 } },
            'STAGE4CROSSBEAMSTRUCTURE': { r: { x: 0, y: 0, z: .01 } },
            'STAGE4CROSSBEAMSTRUCTUREA': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE4CROSSBEAMSTRUCTUREB': { r: { x: 0, y: 0, z: .01 } },
            'STAGE4CROSSBEAMSTRUCTUREC': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE4CROSSBEAMSTRUCTURED': { r: { x: 0, y: 0, z: .01 } },
            'STAGE4MAINSTRUCTURE3': { r: { x: 0, y: 0, z: -.005 } },
            'STAGE4MAINSTRUCTURE4': { r: { x: 0, y: 0, z: .005 } },
            'STAGE4CROSSBEAMSTRUCTURE1': { r: { x: 0, y: 0, z: .01 } },
            'STAGE4CROSSBEAMSTRUCTURE1A': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE4CROSSBEAMSTRUCTURE1B': { r: { x: 0, y: 0, z: .01 } },
            'STAGE4CROSSBEAMSTRUCTURE1C': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE4CROSSBEAMSTRUCTURE1D': { r: { x: 0, y: 0, z: .01 } },
            'STAGE4MAINSTRUCTURE5': { r: { x: 0, y: 0, z: -.005 } },
            'STAGE4MAINSTRUCTURE6': { r: { x: 0, y: 0, z: .005 } },
            'STAGE4CROSSBEAMSTRUCTURE2': { r: { x: 0, y: 0, z: .01 } },
            'STAGE4CROSSBEAMSTRUCTURE2A': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE4CROSSBEAMSTRUCTURE2B': { r: { x: 0, y: 0, z: .01 } },
            'STAGE4CROSSBEAMSTRUCTURE2C': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE4CROSSBEAMSTRUCTURE2D': { r: { x: 0, y: 0, z: .01 } },
            'STAGE4MAINSTRUCTURE7': { r: { x: 0, y: 0, z: -.005 } },
            'STAGE4MAINSTRUCTURE8': { r: { x: 0, y: 0, z: .005 } },
            'STAGE4CROSSBEAMSTRUCTURE3': { r: { x: 0, y: 0, z: .01 } },
            'STAGE4CROSSBEAMSTRUCTURE3A': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE4CROSSBEAMSTRUCTURE3B': { r: { x: 0, y: 0, z: .01 } },
            'STAGE4CROSSBEAMSTRUCTURE3C': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE4CROSSBEAMSTRUCTURE3D': { r: { x: 0, y: 0, z: .01 } }

          },
          teardown: () => {
            teardownStage('STAGE4')
            window.appConfig.stages.STAGE4.data.started = false
          },
          init: () => {
            window.appConfig.initStageSounds()
            window.appConfig.lighting.hemisphereLight.color = getRandomColor()
            window.appConfig.lighting.hemisphereLight.groundColor = getRandomColor()

            const createBackgroundAnimation = () => {
              const bgGroup = new THREE.Group()
              bgGroup.name = 'STAGE4BGGROUP'
              const elementGeometry = new THREE.TetrahedronGeometry(3)
              const elementMaterials = [
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE4.backgroundColors[0], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE4.backgroundColors[1], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE4.backgroundColors[2], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE4.backgroundColors[3], transparent: true, opacity: .25 }),
              ]

              const numberOfElements = 50
              let elementI = 0
              for (elementI; elementI < numberOfElements; elementI++) {
                bgGroup.add(new THREE.Mesh(elementGeometry, elementMaterials[elementI % elementMaterials.length]))
              }
              scene.add(bgGroup)
              bgGroup.position.set(0, 0, -10)
              bgGroup.children.forEach(c => {
                c.position.set(Math.random() * 200 - 100, Math.random() * 200 - 100, -2 + Math.random() * -20)
                const bgElementScale = 1 + Math.random() * 10
                c.scale.set(bgElementScale, bgElementScale, bgElementScale)
                c.rotation.z = (Math.random() * 2) * Math.PI
              })
              bgGroup.activeCallback = () => {
                if (scene.children.find((obj) => obj.name === "STAGE4BGGROUP")) {
                  scene.children.find((obj) => obj.name === "STAGE4BGGROUP").children.forEach((c, ci) => {
                    c.position.y += .005 * ci / 2
                    c.rotation.y += .005
                    if (c.position.y > 125) {
                      c.position.y = -125
                    }
                    c.scale.set(lfo(500 + ci * 1500) * 10 + 5, lfo(500 + ci * 1750) * 10 + 5, lfo(500 + ci * 2000) * 10 + 5)
                  })
                }
              }
              bgGroup.activeCallback()
              window.appConfig.stages['STAGE4'].bgGroupActiveCallback = bgGroup.activeCallback
            }

            createBackgroundAnimation()



            const createStage0MainBeamStructure = window.appConfig.stages.components.createStage0MainBeamStructure
            const createStage1MinorBeamStructure = window.appConfig.stages.components.createStage1MinorBeamStructure
            const createStage3CrossBeamStructure = window.appConfig.stages.components.createStage3CrossBeamStructure
            const createStage4PlinkoStructure = window.appConfig.stages.components.createStage4PlinkoStructure

            const stage4MainBeamStructure1 = createStage0MainBeamStructure(
              1.25,
              -0.5,
              "STAGE4MAINSTRUCTURE1",
              { x: 0, y: 75 }
            );
            scene.add(stage4MainBeamStructure1);

            const stage4MainBeamStructure2 = createStage0MainBeamStructure(
              .75,
              -0.5,
              "STAGE4MAINSTRUCTURE2",
              { x: 0, y: 75 }
            );
            scene.add(stage4MainBeamStructure2);

            const stage4CrossBeamStructure = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE",
              { x: 0, y: 25 }
            );
            scene.add(stage4CrossBeamStructure);

            const stage4CrossBeamStructureA = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTUREA",
              { x: -15, y: 30 }
            );
            scene.add(stage4CrossBeamStructureA);

            const stage4CrossBeamStructureB = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTUREB",
              { x: 15, y: 30 }
            );
            scene.add(stage4CrossBeamStructureB);

            const stage4CrossBeamStructureC = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTUREC",
              { x: -30, y: 40 }
            );
            scene.add(stage4CrossBeamStructureC);

            const stage4CrossBeamStructureD = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURED",
              { x: 30, y: 40 }
            );
            scene.add(stage4CrossBeamStructureD);

            //--

            const stage4MainBeamStructure3 = createStage0MainBeamStructure(
              1.25,
              -0.5,
              "STAGE4MAINSTRUCTURE3",
              { x: 0, y: -75 }
            );
            scene.add(stage4MainBeamStructure3);

            const stage4MainBeamStructure4 = createStage0MainBeamStructure(
              .75,
              -0.5,
              "STAGE4MAINSTRUCTURE4",
              { x: 0, y: -75 }
            );
            scene.add(stage4MainBeamStructure4);

            const stage4CrossBeamStructure1 = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE1",
              { x: 0, y: -25 }
            );
            scene.add(stage4CrossBeamStructure1);

            const stage4CrossBeamStructure1A = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE1A",
              { x: -15, y: -30 }
            );
            scene.add(stage4CrossBeamStructure1A);

            const stage4CrossBeamStructure1B = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE1B",
              { x: 15, y: -30 }
            );
            scene.add(stage4CrossBeamStructure1B);

            const stage4CrossBeamStructure1C = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE1C",
              { x: -30, y: -40 }
            );
            scene.add(stage4CrossBeamStructure1C);

            const stage4CrossBeamStructure1D = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE1D",
              { x: 30, y: -40 }
            );
            scene.add(stage4CrossBeamStructure1D);

            //--

            const stage4MainBeamStructure5 = createStage0MainBeamStructure(
              1.25,
              -0.5,
              "STAGE4MAINSTRUCTURE5",
              { x: -75, y: 0 }
            );
            scene.add(stage4MainBeamStructure5);

            const stage4MainBeamStructure6 = createStage0MainBeamStructure(
              .75,
              -0.5,
              "STAGE4MAINSTRUCTURE6",
              { x: -75, y: 0 }
            );
            scene.add(stage4MainBeamStructure6);

            const stage4CrossBeamStructure2 = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE2",
              { x: -25, y: 0 }
            );
            scene.add(stage4CrossBeamStructure2);

            const stage4CrossBeamStructure2A = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE2A",
              { x: -30, y: -15 }
            );
            scene.add(stage4CrossBeamStructure2A);

            const stage4CrossBeamStructure2B = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE2B",
              { x: -30, y: 15 }
            );
            scene.add(stage4CrossBeamStructure2B);

            const stage4CrossBeamStructure2C = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE2C",
              { x: -40, y: -30 }
            );
            scene.add(stage4CrossBeamStructure2C);

            const stage4CrossBeamStructure2D = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE2D",
              { x: -40, y: 30 }
            );
            scene.add(stage4CrossBeamStructure2D);


            //--

            const stage4MainBeamStructure7 = createStage0MainBeamStructure(
              1.25,
              -0.5,
              "STAGE4MAINSTRUCTURE7",
              { x: 75, y: 0 }
            );
            scene.add(stage4MainBeamStructure7);

            const stage4MainBeamStructure8 = createStage0MainBeamStructure(
              .75,
              -0.5,
              "STAGE4MAINSTRUCTURE8",
              { x: 75, y: 0 }
            );
            scene.add(stage4MainBeamStructure8);

            const stage4CrossBeamStructure3 = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE3",
              { x: 25, y: 0 }
            );
            scene.add(stage4CrossBeamStructure3);

            const stage4CrossBeamStructure3A = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE3A",
              { x: 30, y: -15 }
            );
            scene.add(stage4CrossBeamStructure3A);

            const stage4CrossBeamStructure3B = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE3B",
              { x: 30, y: 15 }
            );
            scene.add(stage4CrossBeamStructure3B);

            const stage4CrossBeamStructure3C = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE3C",
              { x: 40, y: -30 }
            );
            scene.add(stage4CrossBeamStructure3C);

            const stage4CrossBeamStructure3D = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE4CROSSBEAMSTRUCTURE3D",
              { x: 40, y: 30 }
            );
            scene.add(stage4CrossBeamStructure3D);



            const stage4PlinkoStructure = createStage4PlinkoStructure(
              3,
              4,
              -.95,
              "STAGE4PLINKOSTRUCTURE",
              { x: 55, y: 35 },
              4,
              5
            );
            stage4PlinkoStructure.rotation.z = .25 * Math.PI
            scene.add(stage4PlinkoStructure);


            const stage4PlinkoStructureA = createStage4PlinkoStructure(
              3,
              4,
              -.95,
              "STAGE4PLINKOSTRUCTUREA",
              { x: -67.5, y: 57.5 },
              4,
              5
            );
            stage4PlinkoStructureA.rotation.z = -.25 * Math.PI
            scene.add(stage4PlinkoStructureA);

            const stage4PlinkoStructureB = createStage4PlinkoStructure(
              3,
              4,
              -.95,
              "STAGE4PLINKOSTRUCTUREB",
              { x: 37.5, y: -52.5 },
              4,
              5
            );
            stage4PlinkoStructureB.rotation.z = -.25 * Math.PI
            scene.add(stage4PlinkoStructureB);

            const stage4PlinkoStructureC = createStage4PlinkoStructure(
              3,
              4,
              -.95,
              "STAGE4PLINKOSTRUCTUREC",
              { x: -57.5, y: -67.5 },
              4,
              5
            );
            stage4PlinkoStructureC.rotation.z = .25 * Math.PI
            scene.add(stage4PlinkoStructureC);


            const stage4MainBeamStructure = window.appConfig.stages.components.createStage0MainBeamStructure(
              12,
              0.56,
              "STAGE4MAINSTRUCTURE"
            );
            stage4MainBeamStructure.rotation.z = .25 * Math.PI
            scene.add(stage4MainBeamStructure);

            prize(4, 0, { x: 75, y: 0, z: 0 })
            prize(4, 1, { x: 0, y: 75, z: 0 })
            prize(4, 2, { x: -75, y: 0, z: 0 })
            prize(4, 3, { x: 0, y: -75, z: 0 })

            createCrystalCircle('STAGE4', 4, { x: 0, y: 75 }, 0, 8)
            createCrystalCircle('STAGE4', 4.5, { x: 0, y: 75 }, 1, 8)
            createCrystalCircle('STAGE4', 5, { x: 0, y: 75 }, 2, 8)
            createCrystalCircle('STAGE4', 5.5, { x: 0, y: 75 }, 1, 8)
            createCrystalCircle('STAGE4', 6, { x: 0, y: 75 }, 0, 8)

            createCrystalCircle('STAGE4', 4, { x: 0, y: -75 }, 0, 8)
            createCrystalCircle('STAGE4', 4.5, { x: 0, y: -75 }, 1, 8)
            createCrystalCircle('STAGE4', 5, { x: 0, y: -75 }, 2, 8)
            createCrystalCircle('STAGE4', 5.5, { x: 0, y: -75 }, 1, 8)
            createCrystalCircle('STAGE4', 6, { x: 0, y: -75 }, 0, 8)

            createCrystalCircle('STAGE4', 4, { x: -75, y: 0 }, 0, 8)
            createCrystalCircle('STAGE4', 4.5, { x: -75, y: 0 }, 1, 8)
            createCrystalCircle('STAGE4', 5, { x: -75, y: 0 }, 2, 8)
            createCrystalCircle('STAGE4', 5.5, { x: -75, y: 0 }, 1, 8)
            createCrystalCircle('STAGE4', 6, { x: -75, y: 0 }, 0, 8)

            createCrystalCircle('STAGE4', 4, { x: 75, y: 0 }, 0, 8)
            createCrystalCircle('STAGE4', 4.5, { x: 75, y: 0 }, 1, 8)
            createCrystalCircle('STAGE4', 5, { x: 75, y: 0 }, 2, 8)
            createCrystalCircle('STAGE4', 5.5, { x: 75, y: 0 }, 1, 8)
            createCrystalCircle('STAGE4', 6, { x: 75, y: 0 }, 0, 8)

            createCrystalCircle('STAGE4', 3, { x: 0, y: 0 }, 0, 8)
            createCrystalCircle('STAGE4', 3.5, { x: 0, y: 0 }, 1, 8)
            createCrystalCircle('STAGE4', 4, { x: 0, y: 0 }, 0, 8)

            createCrystalCross('STAGE4', 3, { x: -17.5, y: 17.5 }, 2);
            createCrystalCross('STAGE4', 3, { x: 17.5, y: 17.5 }, 2);
            createCrystalCross('STAGE4', 3, { x: -17.5, y: -17.5 }, 2);
            createCrystalCross('STAGE4', 3, { x: 17.5, y: -17.5 }, 2);


            window.appConfig.stages.STAGE4.STAGE4PRIZE0 = scene.children.find((obj) => obj.name === "STAGE4PRIZE0")
            window.appConfig.stages.STAGE4.STAGE4PRIZE1 = scene.children.find((obj) => obj.name === "STAGE4PRIZE1")
            window.appConfig.stages.STAGE4.STAGE4PRIZE2 = scene.children.find((obj) => obj.name === "STAGE4PRIZE2")
            window.appConfig.stages.STAGE4.STAGE4PRIZE3 = scene.children.find((obj) => obj.name === "STAGE4PRIZE3")

            window.appConfig.stages.STAGE4.STAGE4MAINSTRUCTURE1 = scene.children.find((obj) => obj.name === "STAGE4MAINSTRUCTURE1")
            window.appConfig.stages.STAGE4.STAGE4MAINSTRUCTURE2 = scene.children.find((obj) => obj.name === "STAGE4MAINSTRUCTURE2")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTUREA = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTUREA")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTUREB = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTUREB")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTUREC = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTUREC")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURED = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURED")

            window.appConfig.stages.STAGE4.STAGE4MAINSTRUCTURE3 = scene.children.find((obj) => obj.name === "STAGE4MAINSTRUCTURE3")
            window.appConfig.stages.STAGE4.STAGE4MAINSTRUCTURE4 = scene.children.find((obj) => obj.name === "STAGE4MAINSTRUCTURE4")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE1 = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE1")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE1A = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE1A")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE1B = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE1B")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE1C = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE1C")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE1D = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE1D")

            window.appConfig.stages.STAGE4.STAGE4MAINSTRUCTURE5 = scene.children.find((obj) => obj.name === "STAGE4MAINSTRUCTURE5")
            window.appConfig.stages.STAGE4.STAGE4MAINSTRUCTURE6 = scene.children.find((obj) => obj.name === "STAGE4MAINSTRUCTURE6")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE2 = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE2")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE2A = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE2A")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE2B = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE2B")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE2C = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE2C")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE2D = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE2D")

            window.appConfig.stages.STAGE4.STAGE4MAINSTRUCTURE7 = scene.children.find((obj) => obj.name === "STAGE4MAINSTRUCTURE7")
            window.appConfig.stages.STAGE4.STAGE4MAINSTRUCTURE8 = scene.children.find((obj) => obj.name === "STAGE4MAINSTRUCTURE8")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE3 = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE3")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE3A = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE3A")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE3B = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE3B")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE3C = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE3C")
            window.appConfig.stages.STAGE4.STAGE4CROSSBEAMSTRUCTURE3D = scene.children.find((obj) => obj.name === "STAGE4CROSSBEAMSTRUCTURE3D")


            window.appConfig.stages.STAGE4.data.started = true
          }
        },
        STAGE5: {
          data: {
            started: false,
            xAdj: -60,
            vAdj: -70,
            sAdj: 2,
            startingPosition: new THREE.Vector3(0, 0, 0)
          },
          backgroundColors: stageProperties.STAGE5.backgroundColors,
          basicColors: stageProperties.STAGE5.basicColors,
          sounds: stageProperties.STAGE5.sounds,
          name: stageProperties.STAGE5.name,
          defaultTransforms: [
            'STAGE5PRIZE0',
            'STAGE5PRIZE1',
            'STAGE5PRIZE2',
            'STAGE5PRIZE3',
            'STAGE5CROSSBEAMSTRUCTURE',
            'STAGE5CROSSBEAMSTRUCTUREA',
            'STAGE5CROSSBEAMSTRUCTUREB',
            'STAGE5CROSSBEAMSTRUCTUREC',
            'STAGE5MINORSTRUCTURE',
            'STAGE5MINORSTRUCTUREA',
            'STAGE5MINORSTRUCTUREB',
            'STAGE5MINORSTRUCTUREC'
          ],
          transforms: {
            'STAGE5PRIZE0': { r: { x: .005, y: .005, z: .005 } },
            'STAGE5PRIZE1': { r: { x: .005, y: .005, z: .005 } },
            'STAGE5PRIZE2': { r: { x: .005, y: .005, z: .005 } },
            'STAGE5PRIZE3': { r: { x: .005, y: .005, z: .005 } },
            'STAGE5MAINSTRUCTURE1': { r: { x: 0, y: 0, z: -.005 } },

            'STAGE5CROSSBEAMSTRUCTURE': { r: { x: 0, y: 0, z: .01 } },
            'STAGE5CROSSBEAMSTRUCTUREA': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE5MINORSTRUCTURE': { r: { x: 0, y: 0, z: .01 } },
            'STAGE5MINORSTRUCTUREA': { r: { x: 0, y: 0, z: .01 } },

            'STAGE5CROSSBEAMSTRUCTUREB': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE5CROSSBEAMSTRUCTUREC': { r: { x: 0, y: 0, z: .01 } },
            'STAGE5MINORSTRUCTUREB': { r: { x: 0, y: 0, z: -.01 } },
            'STAGE5MINORSTRUCTUREC': { r: { x: 0, y: 0, z: -.01 } }

          },
          teardown: () => {
            teardownStage('STAGE5')
            window.appConfig.stages.STAGE5.data.started = false
          },
          init: () => {
            window.appConfig.initStageSounds()
            window.appConfig.lighting.hemisphereLight.color = getRandomColor()
            window.appConfig.lighting.hemisphereLight.groundColor = getRandomColor()

            const createBackgroundAnimation = () => {
              const bgGroup = new THREE.Group()
              bgGroup.name = 'STAGE5BGGROUP'
              const elementGeometry = new THREE.IcosahedronGeometry(1, 0)
              const elementMaterials = [
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE5.backgroundColors[0], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE5.backgroundColors[1], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE5.backgroundColors[2], transparent: true, opacity: .25 }),
                new THREE.MeshPhongMaterial({ color: stageProperties.STAGE5.backgroundColors[3], transparent: true, opacity: .25 }),
              ]

              const numberOfElements = 50
              let elementI = 0
              for (elementI; elementI < numberOfElements; elementI++) {
                bgGroup.add(new THREE.Mesh(elementGeometry, elementMaterials[elementI % elementMaterials.length]))
              }
              scene.add(bgGroup)
              bgGroup.position.set(0, 0, -10)
              bgGroup.children.forEach(c => {
                c.position.set(Math.random() * 200 - 100, Math.random() * 200 - 100, -2 + Math.random() * -20)
                const bgElementScale = 1 + Math.random() * 10
                c.scale.set(bgElementScale, bgElementScale, bgElementScale)
                c.rotation.z = (Math.random() * 2) * Math.PI
              })
              bgGroup.activeCallback = () => {
                if (scene.children.find((obj) => obj.name === "STAGE5BGGROUP")) {
                  scene.children.find((obj) => obj.name === "STAGE5BGGROUP").children.forEach((c, ci) => {
                    c.position.y += .005 * ci / 2
                    c.rotation.y += .005
                    if (c.position.y > 125) {
                      c.position.y = -125
                    }
                    c.scale.set(lfo(500 + ci * 1500) * 10 + 5, lfo(500 + ci * 1750) * 10 + 5, lfo(500 + ci * 2000) * 10 + 5)
                  })
                }
              }
              bgGroup.activeCallback()
              window.appConfig.stages['STAGE5'].bgGroupActiveCallback = bgGroup.activeCallback
            }

            createBackgroundAnimation()

            const createStage0MainBeamStructure = window.appConfig.stages.components.createStage0MainBeamStructure
            const createStage1MinorBeamStructure = window.appConfig.stages.components.createStage1MinorBeamStructure
            const createStage3CrossBeamStructure = window.appConfig.stages.components.createStage3CrossBeamStructure
            const createStage4PlinkoStructure = window.appConfig.stages.components.createStage4PlinkoStructure

            const stage5MainBeamStructure = window.appConfig.stages.components.createStage0MainBeamStructure(
              12,
              0.56,
              "STAGE5MAINSTRUCTURE"
            );
            stage5MainBeamStructure.rotation.z = .25 * Math.PI
            scene.add(stage5MainBeamStructure);


            const stage5MainBeamStructure1 = createStage0MainBeamStructure(
              1.25,
              -0.5,
              "STAGE5MAINSTRUCTURE1",
              { x: 0, y: -25 }
            );
            stage5MainBeamStructure1.rotation.z = .25 * Math.PI
            scene.add(stage5MainBeamStructure1);

            const stage5MainBeamStructure2 = createStage0MainBeamStructure(
              1.25,
              -0.5,
              "STAGE5MAINSTRUCTURE2",
              { x: 0, y: 25 }
            );
            stage5MainBeamStructure2.rotation.z = .25 * Math.PI
            scene.add(stage5MainBeamStructure2);

            const stage5CrossBeamStructure = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE5CROSSBEAMSTRUCTURE",
              { x: -12.5, y: -50 }
            );
            scene.add(stage5CrossBeamStructure);

            const stage5CrossBeamStructureA = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE5CROSSBEAMSTRUCTUREA",
              { x: 12.5, y: -50 }
            );
            scene.add(stage5CrossBeamStructureA);


            const stage5MinorBeamStructure = createStage1MinorBeamStructure(
              .5,
              .5,
              "STAGE5MINORSTRUCTURE",
              { x: 0, y: -75 }
            );
            scene.add(stage5MinorBeamStructure);

            const stage5MinorBeamStructureA = createStage1MinorBeamStructure(
              .5,
              .5,
              "STAGE5MINORSTRUCTUREA",
              { x: 0, y: -75 }
            );
            stage5MinorBeamStructureA.rotation.z = .25 * Math.PI
            scene.add(stage5MinorBeamStructureA);





            const stage5CrossBeamStructureB = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE5CROSSBEAMSTRUCTUREB",
              { x: -12.5, y: 50 }
            );
            scene.add(stage5CrossBeamStructureB);

            const stage5CrossBeamStructureC = createStage3CrossBeamStructure(
              .5,
              .75,
              "STAGE5CROSSBEAMSTRUCTUREC",
              { x: 12.5, y: 50 }
            );
            scene.add(stage5CrossBeamStructureC);


            const stage5MinorBeamStructureB = createStage1MinorBeamStructure(
              .5,
              .5,
              "STAGE5MINORSTRUCTUREB",
              { x: 0, y: 75 }
            );
            scene.add(stage5MinorBeamStructureB);

            const stage5MinorBeamStructureC = createStage1MinorBeamStructure(
              .5,
              .5,
              "STAGE5MINORSTRUCTUREC",
              { x: 0, y: 75 }
            );
            stage5MinorBeamStructureC.rotation.z = .25 * Math.PI
            scene.add(stage5MinorBeamStructureC);






            const stage5PlinkoStructure = createStage4PlinkoStructure(
              6,
              8,
              -.95,
              "STAGE5PLINKOSTRUCTURE",
              { x: 25, y: -36.25 },
              3,
              10
            );
            scene.add(stage5PlinkoStructure);

            const stage5PlinkoStructureA = createStage4PlinkoStructure(
              6,
              8,
              -.95,
              "STAGE5PLINKOSTRUCTUREA",
              { x: -60, y: -36.25 },
              3,
              10
            );
            scene.add(stage5PlinkoStructureA);

            prize(5, 0, { x: 75, y: 0, z: 0 })
            prize(5, 1, { x: 0, y: 75, z: 0 })
            prize(5, 2, { x: -75, y: 0, z: 0 })
            prize(5, 3, { x: 0, y: -75, z: 0 })

            createCrystalCross('STAGE5', 2.5, { x: -12.5, y: 10 }, 0);
            createCrystalCross('STAGE5', 2.5, { x: 12.5, y: 10 }, 0);
            createCrystalCross('STAGE5', 2.5, { x: -12.5, y: -10 }, 0);
            createCrystalCross('STAGE5', 2.5, { x: 12.5, y: -10 }, 0);

            createCrystalCross('STAGE5', 2.5, { x: -15, y: 37.5 }, 1);
            createCrystalCross('STAGE5', 2.5, { x: 15, y: 37.5 }, 1);
            createCrystalCross('STAGE5', 2.5, { x: -15, y: -37.5 }, 1);
            createCrystalCross('STAGE5', 2.5, { x: 15, y: -37.5 }, 1);


            createCrystalCross('STAGE5', 5, { x: -100, y: 0 }, 0);
            createCrystalCross('STAGE5', 5, { x: -120, y: 0 }, 2);
            createCrystalCross('STAGE5', 5, { x: -110, y: 10 }, 1);
            createCrystalCross('STAGE5', 5, { x: -110, y: -10 }, 1);

            createCrystalCross('STAGE5', 5, { x: -80, y: 20 }, 0);
            createCrystalCross('STAGE5', 5, { x: -100, y: 20 }, 2);
            createCrystalCross('STAGE5', 5, { x: -90, y: 30 }, 1);
            createCrystalCross('STAGE5', 5, { x: -90, y: 10 }, 1);

            createCrystalCross('STAGE5', 5, { x: -80, y: -20 }, 0);
            createCrystalCross('STAGE5', 5, { x: -100, y: -20 }, 2);
            createCrystalCross('STAGE5', 5, { x: -90, y: -30 }, 1);
            createCrystalCross('STAGE5', 5, { x: -90, y: -10 }, 1);



            createCrystalCross('STAGE5', 5, { x: 100, y: 0 }, 0);
            createCrystalCross('STAGE5', 5, { x: 120, y: 0 }, 2);
            createCrystalCross('STAGE5', 5, { x: 110, y: 10 }, 1);
            createCrystalCross('STAGE5', 5, { x: 110, y: -10 }, 1);

            createCrystalCross('STAGE5', 5, { x: 80, y: 20 }, 0);
            createCrystalCross('STAGE5', 5, { x: 100, y: 20 }, 2);
            createCrystalCross('STAGE5', 5, { x: 90, y: 30 }, 1);
            createCrystalCross('STAGE5', 5, { x: 90, y: 10 }, 1);

            createCrystalCross('STAGE5', 5, { x: 80, y: -20 }, 0);
            createCrystalCross('STAGE5', 5, { x: 100, y: -20 }, 2);
            createCrystalCross('STAGE5', 5, { x: 90, y: -30 }, 1);
            createCrystalCross('STAGE5', 5, { x: 90, y: -10 }, 1);




            createCrystalCross('STAGE5', 5, { x: 0, y: 100 }, 0);
            createCrystalCross('STAGE5', 5, { x: 0, y: 120 }, 2);
            createCrystalCross('STAGE5', 5, { x: 10, y: 110 }, 1);
            createCrystalCross('STAGE5', 5, { x: -10, y: 110 }, 1);


            createCrystalCross('STAGE5', 5, { x: 0, y: -100 }, 0);
            createCrystalCross('STAGE5', 5, { x: 0, y: -120 }, 2);
            createCrystalCross('STAGE5', 5, { x: 10, y: -110 }, 1);
            createCrystalCross('STAGE5', 5, { x: -10, y: -110 }, 1);

            createCrystalCross('STAGE5', 3.3, { x: 0, y: -25 }, 0);
            createCrystalCross('STAGE5', 6.6, { x: 0, y: -25 }, 2);
            createCrystalCross('STAGE5', 10, { x: 0, y: -25 }, 1);

            createCrystalCross('STAGE5', 3.3, { x: 0, y: 25 }, 0);
            createCrystalCross('STAGE5', 6.6, { x: 0, y: 25 }, 2);
            createCrystalCross('STAGE5', 10, { x: 0, y: 25 }, 1);

            createCrystalLine('STAGE5', 5, { x: -51.25, y: -35 }, 1, 15, "y");
            createCrystalLine('STAGE5', 5, { x: -32.5, y: -35 }, 2, 15, "y");
            createCrystalLine('STAGE5', 5, { x: 51.25, y: -35 }, 1, 15, "y");
            createCrystalLine('STAGE5', 5, { x: 32.5, y: -35 }, 2, 15, "y");

            createCrystalCircle('STAGE5', 1.5, { x: 25, y: 90 }, 2, 2)
            createCrystalCircle('STAGE5', 2.5, { x: 25, y: 90 }, 1, 2)

            createCrystalCircle('STAGE5', 1.5, { x: -25, y: 90 }, 2, 2)
            createCrystalCircle('STAGE5', 2.5, { x: -25, y: 90 }, 1, 2)

            createCrystalCircle('STAGE5', 1.5, { x: 25, y: -90 }, 2, 2)
            createCrystalCircle('STAGE5', 2.5, { x: 25, y: -90 }, 1, 2)

            createCrystalCircle('STAGE5', 1.5, { x: -25, y: -90 }, 2, 2)
            createCrystalCircle('STAGE5', 2.5, { x: -25, y: -90 }, 1, 2)


            createCrystalCircle('STAGE5', 1.5, { x: 40, y: 60 }, 2, 2)
            createCrystalCircle('STAGE5', 2.5, { x: 40, y: 60 }, 1, 8)
            createCrystalCircle('STAGE5', 3, { x: 40, y: 60 }, 2, 8)
            createCrystalCircle('STAGE5', 3.5, { x: 40, y: 60 }, 1, 8)
            createCrystalCircle('STAGE5', 4, { x: 40, y: 60 }, 0, 8)

            createCrystalCircle('STAGE5', 1.5, { x: -40, y: 60 }, 2, 2)
            createCrystalCircle('STAGE5', 2.5, { x: -40, y: 60 }, 1, 8)
            createCrystalCircle('STAGE5', 3, { x: -40, y: 60 }, 2, 8)
            createCrystalCircle('STAGE5', 3.5, { x: -40, y: 60 }, 1, 8)
            createCrystalCircle('STAGE5', 4, { x: -40, y: 60 }, 0, 8)

            createCrystalCircle('STAGE5', 1.5, { x: 40, y: -60 }, 2, 2)
            createCrystalCircle('STAGE5', 2.5, { x: 40, y: -60 }, 1, 8)
            createCrystalCircle('STAGE5', 3, { x: 40, y: -60 }, 2, 8)
            createCrystalCircle('STAGE5', 3.5, { x: 40, y: -60 }, 1, 8)
            createCrystalCircle('STAGE5', 4, { x: 40, y: -60 }, 0, 8)


            createCrystalCircle('STAGE5', 1.5, { x: -40, y: -60 }, 2, 2)
            createCrystalCircle('STAGE5', 2.5, { x: -40, y: -60 }, 1, 8)
            createCrystalCircle('STAGE5', 3, { x: -40, y: -60 }, 2, 8)
            createCrystalCircle('STAGE5', 3.5, { x: -40, y: -60 }, 1, 8)
            createCrystalCircle('STAGE5', 4, { x: -40, y: -60 }, 0, 8)

            window.appConfig.stages.STAGE5.STAGE5PRIZE0 = scene.children.find((obj) => obj.name === "STAGE5PRIZE0")
            window.appConfig.stages.STAGE5.STAGE5PRIZE1 = scene.children.find((obj) => obj.name === "STAGE5PRIZE1")
            window.appConfig.stages.STAGE5.STAGE5PRIZE2 = scene.children.find((obj) => obj.name === "STAGE5PRIZE2")
            window.appConfig.stages.STAGE5.STAGE5PRIZE3 = scene.children.find((obj) => obj.name === "STAGE5PRIZE3")

            window.appConfig.stages.STAGE5.STAGE5MAINSTRUCTURE1 = scene.children.find((obj) => obj.name === "STAGE5MAINSTRUCTURE1")

            window.appConfig.stages.STAGE5.STAGE5CROSSBEAMSTRUCTURE = scene.children.find((obj) => obj.name === "STAGE5CROSSBEAMSTRUCTURE")
            window.appConfig.stages.STAGE5.STAGE5CROSSBEAMSTRUCTUREA = scene.children.find((obj) => obj.name === "STAGE5CROSSBEAMSTRUCTUREA")
            window.appConfig.stages.STAGE5.STAGE5CROSSBEAMSTRUCTUREB = scene.children.find((obj) => obj.name === "STAGE5CROSSBEAMSTRUCTUREB")
            window.appConfig.stages.STAGE5.STAGE5CROSSBEAMSTRUCTUREC = scene.children.find((obj) => obj.name === "STAGE5CROSSBEAMSTRUCTUREC")

            window.appConfig.stages.STAGE5.STAGE5MINORSTRUCTURE = scene.children.find((obj) => obj.name === "STAGE5MINORSTRUCTURE")
            window.appConfig.stages.STAGE5.STAGE5MINORSTRUCTUREA = scene.children.find((obj) => obj.name === "STAGE5MINORSTRUCTUREA")
            window.appConfig.stages.STAGE5.STAGE5MINORSTRUCTUREB = scene.children.find((obj) => obj.name === "STAGE5MINORSTRUCTUREB")
            window.appConfig.stages.STAGE5.STAGE5MINORSTRUCTUREC = scene.children.find((obj) => obj.name === "STAGE5MINORSTRUCTUREC")

            window.appConfig.stages.STAGE5.data.started = true
          }
        }


      }

      // window.appConfig.stages.STAGE0.init()
      window.appConfig.stages[window.appConfig.currentStage].init()

      spawnBox();

      requestAnimationFrame(render);
      scene.simulate();
      window.appConfig.easyTimerLength = 30
      const timer = new easytimer.Timer({ countdown: true, startValues: { seconds: window.appConfig.easyTimerLength }, precision: "secondTenths" });
      window.appConfig.timer = timer
      timer.addEventListener("secondTenthsUpdated", function (e) {
        document.querySelector(
          "#timer"
        ).innerText = `${timer
          .getTimeValues()
          .toString(["minutes", "seconds", "secondTenths"])}`;
      });
      timer.addEventListener("targetAchieved", function (e) {
        startStageEnd()
      })
      document.querySelector("#curtain").classList.add("opacity-0");
    };

    spawnBox = (function () {
      var sphere_geometry = new THREE.SphereGeometry(1, 32, 32),
        collisionInc = 0,
        lastCollisions = ["", "", ""],
        handleCollision = function (
          collided_with,
          linearVelocity,
          angularVelocity
        ) {
          console.log("collision");
          console.log("collided_with", collided_with);
          if (appConfig.pause === false) {
            const suonousFeatureTypes = [
              "BEAM",
              "BOX",
              "ICOSAHEDRON",
              "TETRAHEDRON",
              "CONE",
              "DISC",
              "TORUS",
              "PLINKO",
              "COIN",
            ];

            const playHowlOnCollision = [
              function () {
                window.appConfig.howlSounds.beams[0].play();
              },
              function () {
                window.appConfig.howlSounds.beams[1].play();
              },
              function () {
                window.appConfig.howlSounds.beams[2].play();
              },
              function () {
                window.appConfig.howlSounds.beams[3].play();
              },
              function () {
                window.appConfig.howlSounds.beams[4].play();
              },
              function () {
                window.appConfig.howlSounds.beams[5].play();
              },
              function () {
                window.appConfig.howlSounds.beams[6].play();
              },
              function () {
                window.appConfig.howlSounds.beams[7].play();
              }
            ]
            if (suonousFeatureTypes.indexOf(collided_with.featureType) > -1) {

              const sphere = scene.children.find(obj => {
                if (obj.gameName === "SPHERE0" && obj.type === "Mesh") {
                  return obj
                }
              })

              const i = Math.floor(collisionInc % playHowlOnCollision.length)
              if (!(lastCollisions[0] === collided_with.uuid && lastCollisions[1] === collided_with.uuid && lastCollisions[2] === collided_with.uuid)) {
                playHowlOnCollision[i]()
                collisionInc++
                lastCollisions.push(collided_with.uuid)
              }
              if (lastCollisions.length > 3) {
                lastCollisions.shift()
              }
              console.log("AFTERPLAY");
            }
          }
        }

      let createSphere = function () {
        var sphere, material;

        material = Physijs.createMaterial(
          new THREE.MeshPhongMaterial({
            color: 0xffffff,
            // envMap: scene.background,
            // combine: THREE.MixOperation,
            reflectivity: 100,
            transparent: true,
            opacity: 0.95,
            specular: 0x050505,
            shininess: 200
          }),
          0.5, // medium friction
          1 // low restitution
        );
        sphere = new Physijs.SphereMesh(sphere_geometry, material);
        sphere.collisions = 0;
        // sphere.position.set(window.appConfig.stages[window.appConfig.currentStage].data.startingPosition);
        sphere.position.set(0, 0, 0);

        sphere.rotation.set(
          Math.random() * Math.PI,
          Math.random() * Math.PI,
          Math.random() * Math.PI
        );

        sphere.castShadow = true;
        sphere.addEventListener("collision", handleCollision);
        sphere.gameName = "SPHERE0";
        sphere.name = "SPHERE0";
        sphere.setCcdMotionThreshold(.5)
        sphere.setCcdSweptSphereRadius(1)
        scene.add(sphere);
        window.appConfig.sphere = sphere
      };
      return () => {
        createSphere();
        const findCoin = (x, y, xMod = 10, yMod = 10) => {
          return window.appConfig.coins.find(
            (coin, coinIndex) => {
              if (coinIndex % (window.appConfig.coinFrameCheckNumber % 10)) {
                if (
                  Math.abs(coin.position.x - x) < coin.scale.x * xMod &&
                  Math.abs(coin.position.y - y) < coin.scale.x * yMod &&
                  !coin.spriteFetching &&
                  !coin.prizeValue) {
                  return true
                } else return false;
              }
            }
          )
        }
        const setSpriteSpherical = (sprite) => {
          const spritePhi = (lfoPositive((sprite.phiT + sprite.phiMod * sprite.phiT)) + lfoPositive(100 * Math.random()) / 500) * (2 * Math.PI)
          const spriteTheta = (lfo((sprite.thetaT + sprite.thetaMod * sprite.thetaT)) + lfo(721 * Math.random()) / 1000) * (Math.PI)
          sprite.spherical.set(sprite.radius + lfoPositive(1111) * 10, spritePhi, spriteTheta)
        }
        window.appConfig.sprites = []
        const createSprite = (num) => {
          const spriteGeometry = new THREE.SphereGeometry(.2, 16, 16)
          const spriteMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: .5 })
          const thetaMod = Math.random()
          const phiMod = Math.random()
          const sprite0Mesh = new THREE.Mesh(spriteGeometry, spriteMaterial)
          const spriteLight = new THREE.PointLight(getRandomColor(), 1)
          spriteLight.power = 25;
          spriteLight.decay = 1;
          spriteLight.distance = 25;
          sprite0Mesh.add(spriteLight)
          scene.add(sprite0Mesh)
          let sprite0 = {
            mesh: sprite0Mesh,
            spherical: new THREE.Spherical(),
            radius: 1.5,
            thetaT: 1500,
            phiT: 2000,
            thetaMod: thetaMod,
            phiMod: phiMod,
            isFetchingCoin: false,
            fetchData: {},
            num: num
          }
          sprite0.mesh.name = "sprite"
          sprite0.reset = () => {
            sprite0.isFetchingCoin = false
            sprite0.fetchData = {}
          }



          sprite0.activeCallback = () => {
            setSpriteSpherical(sprite0)
            const spriteVector3 = new THREE.Vector3()
            spriteVector3.setFromSpherical(sprite0.spherical)
            spriteVector3.x = spriteVector3.x + window.appConfig.sphere.position.x
            spriteVector3.y = spriteVector3.y + window.appConfig.sphere.position.y
            spriteVector3.z = spriteVector3.z + window.appConfig.sphere.position.z
            sprite0.mesh.position.x = spriteVector3.x
            sprite0.mesh.position.y = spriteVector3.y
            sprite0.mesh.position.z = spriteVector3.z
            sprite0.mesh.material.opacity = .5 + (lfoPositive(1000) + lfoPositive(77) / 2)

            if (!sprite0.isFetchingCoin && window.appConfig.start && !window.appConfig.pause && !window.appConfig.userHasEnded) {
              if (sprite0.returnData && sprite0.returnData.startingPosition) {
                let percentComplete = window.appConfig.timers.data[`spriteReturn${sprite0.num}`].percentComplete
                const newX = sprite0.returnData.startingPosition.x * (1 - percentComplete) + (spriteVector3.x * percentComplete)
                const newY = sprite0.returnData.startingPosition.y * (1 - percentComplete) + (spriteVector3.y * percentComplete)
                sprite0.mesh.position.x = newX
                sprite0.mesh.position.y = newY
              }

              const theCoin = findCoin(sprite0.mesh.position.x, sprite0.mesh.position.y)
              if (theCoin) {
                sprite0.isFetchingCoin = true
                sprite0.fetchData.startingPosition = sprite0.mesh.position.clone()
                sprite0.fetchData.target = theCoin
                sprite0.fetchData.coinBrightnessLfoMod = Math.ceil(Math.random() * 33)
                sprite0.isReturning = false
                sprite0.returnData = {}
                const foundTimerIndex = window.appConfig.timers.activeTimers.findIndex((timer, timerIndex) => {
                  return timer.name === `SPRITERETURN${sprite0.num}`
                })
                if (foundTimerIndex > -1) {
                  window.appConfig.timers.activeTimers.splice(foundTimerIndex, 1)
                }

                window.appConfig.timers.activeTimers.push(window.appConfig.timers[`spriteFetch${sprite0.num}`](sprite0))
                theCoin.spriteFetching = sprite0
              }
            } else if (sprite0.isFetchingCoin && window.appConfig.start && !window.appConfig.pause) {

              sprite0.fetchData.target.children.forEach(child => {
                child.material = window.appConfig.crystalMaterials[sprite0.fetchData.target.size].pulsing
              })
              let percentComplete = window.appConfig.timers.data[`spriteFetch${sprite0.num}`].percentComplete
              if (percentComplete < .5) {
                const percentThere = percentComplete / .5
                sprite0.mesh.position.x = sprite0.fetchData.startingPosition.x * (1 - percentThere) + (sprite0.fetchData.target.position.x * percentThere)
                sprite0.mesh.position.y = sprite0.fetchData.startingPosition.y * (1 - percentThere) + (sprite0.fetchData.target.position.y * percentThere)
              } else if (percentComplete > .5) {
                if (!sprite0.fetchData.coinStartingPosition) {
                  sprite0.fetchData.coinStartingPosition = sprite0.fetchData.target.position.clone()
                }
                const percentThere = (percentComplete - .5) / .5
                const newX = sprite0.fetchData.coinStartingPosition.x * (1 - percentThere) + (window.appConfig.sphere.position.x * percentThere)
                const newY = sprite0.fetchData.coinStartingPosition.y * (1 - percentThere) + (window.appConfig.sphere.position.y * percentThere)
                sprite0.mesh.position.x = newX
                sprite0.mesh.position.y = newY

                sprite0.fetchData.target.position.x = newX
                sprite0.fetchData.target.position.y = newY
              }
            }
          }
          window.appConfig.sprites.push(sprite0)

        }
        createSprite(0)
        createSprite(1)
        createSprite(2)



        const sidesColor = getRandomColor();

        const glassMesh0 = new Physijs.BoxMesh(
            /*geometry*/ new THREE.BoxGeometry(1000, 1000, 1),
            /*material*/ new THREE.MeshBasicMaterial({
          color: getRandomColor(),
          opacity: 0,
          transparent: true,
          wifeframe: true,
        }),
            /*mass*/ 0
        );
        glassMesh0.gameName = "FRONTGLASS";
        glassMesh0.name = "glassMesh0";

        const glassMesh1 = new Physijs.BoxMesh(
            /*geometry*/ new THREE.BoxGeometry(1000, 1000, 1),
            /*material*/ new THREE.MeshBasicMaterial({
          color: getRandomColor(),
          opacity: 0.0,
          transparent: true,
          wifeframe: true,
        }),
            /*mass*/ 0
        );
        glassMesh1.gameName = "BACKGLASS";
        glassMesh1.name = "glassMesh1";

        glassMesh0.position.z = 1.5;
        glassMesh1.position.z = -1.5;
        glassMesh0.position.y = -137.5;
        glassMesh1.position.y = -140;
        glassMesh0.__dirtyPosition = true;
        glassMesh0.__dirtyRotation = true;
        glassMesh1.__dirtyPosition = true;
        glassMesh1.__dirtyRotation = true;

        scene.add(glassMesh0);
        scene.add(glassMesh1);

      };
    })();

    let appStartTime = new Date().getTime();
    let initialBallZoomTime = 0;

    window.appConfig.activeTransforms = []

    let currentTime = new Date().getTime();

    const timers = {
      initialBallZoom: () => {
        return {
          started: 0,
          ended: 0,
          percentComplete: 0,
          time: 2000,
          timeLeft: 0,
          currentTime: 0,
          name: 'INITIALBALLZOOM',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.initialBallZoom.percentComplete = percentComplete
          }
        }
      },
      countdownName: (action) => {
        return {
          started: 0,
          ended: 0,
          percentComplete: 0,
          time: 4000,
          timeLeft: 0,
          currentTime: 0,
          name: 'COUNTDOWNNAME',
          id: Math.round(Math.random() * 10000),
          startedCallback: (percentComplete) => {
            showStageCountDownName()
            document.querySelector('#stage-name-title').style.opacity = 1
            document.querySelector('#stage-number').style.opacity = 1
          },
          activeCallback: (percentComplete) => {
            const percentComputed = (percentComplete * 16) > 8 ? 8 : (percentComplete * 16)
            document.querySelector('#stage-name-title').style.fontSize = percentComputed * .75 + "rem"
            document.querySelector('#stage-number').style.fontSize = percentComputed / 2 + "rem"
            document.querySelector('#gradient-curtain').style.background = window.appConfig.stages.components.background(
              lfoPositive(2750), window.appConfig.stages[window.appConfig.currentStage].backgroundColors
            )
            if (percentComplete < .5) {
              document.querySelector('#gradient-curtain').style.opacity = percentComplete * 2
            }
            if (percentComplete > .5) {
              document.querySelector('#gradient-curtain').style.opacity = (1 - ((percentComplete - .5) * 2)) < 0 ? 0 : (1 - ((percentComplete - .5) * 2))
            }
            centerElement({ id: "stage-name", offsetTop: 0, offsetLeft: 0 })
            if (percentComplete > .9) {
              document.querySelector('#stage-name-title').style.opacity = 1 - (percentComplete - .9) * 10
              document.querySelector('#stage-number').style.opacity = 1 - (percentComplete - .9) * 10
            }
          },
          completedCallback: (percentComplete) => {
            showStageCountDown3()
            window.appConfig.timers.activeTimers.push(window.appConfig.timers.countdown2())
            window.appConfig.timers.activeTimers.push(window.appConfig.timers.countdown1())
          }
        }
      },
      countdown2: (action) => {
        return {
          started: 0,
          ended: 0,
          percentComplete: 0,
          time: 750,
          timeLeft: 0,
          currentTime: 0,
          name: 'COUNTDOWN2',
          id: Math.round(Math.random() * 10000),
          startedCallback: () => {
            window.appConfig.howlSounds.count2.play()
          },
          completedCallback: (percentComplete) => {
            showStageCountDown2()
            window.appConfig.howlSounds.count3.play()
          }
        }
      },
      countdown1: (action) => {
        return {
          started: 0,
          ended: 0,
          percentComplete: 0,
          time: 1500,
          timeLeft: 0,
          currentTime: 0,
          name: 'COUNTDOWN1',
          id: Math.round(Math.random() * 10000),
          completedCallback: (percentComplete) => {
            window.appConfig.howlSounds.count1.play()
            showStageCountDown1()
            window.appConfig.timers.activeTimers.push(window.appConfig.timers.countdownStart())
          }
        }
      },
      countdownStart: (action) => {
        return {
          started: 0,
          ended: 0,
          percentComplete: 0,
          time: 1000,
          timeLeft: 0,
          currentTime: 0,
          name: 'COUNTDOWNSTART',
          id: Math.round(Math.random() * 10000),
          completedCallback: (percentComplete) => {
            showStageCountDownStart()
            window.appConfig.howlSounds.start.play()
            window.appConfig.gameModeFunctions.start()
            window.appConfig.timers.activeTimers.push(window.appConfig.timers.countdownStartFlash())
          },
        }
      },
      countdownStartFlash: (action) => {
        return {
          started: 0,
          ended: 0,
          percentComplete: 0,
          time: 1000,
          timeLeft: 0,
          currentTime: 0,
          name: 'COUNTDOWNSTARTFLASH',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            console.log('ACTIVE CALL BACK')
            if (percentComplete < .5) {
              document.querySelector('#gradient-curtain').style.opacity = percentComplete * 2
            }
            if (percentComplete > .5) {
              document.querySelector('#gradient-curtain').style.opacity = (1 - ((percentComplete - .5) * 2)) < 0 ? 0 : (1 - ((percentComplete - .5) * 2))
            }
          }
        }
      },
      stageReset: (action) => {
        return {
          started: 0,
          ended: 0,
          z: scene.children.find((obj) => obj.gameName === "SPHERE0")
            .position.z,
          percentComplete: 0,
          time: 2000,
          timeLeft: 0,
          currentTime: 0,
          name: 'STAGERESET',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.stageReset.percentComplete = percentComplete
          },
          completedCallback: (percentComplete) => {
            window.appConfig.stages[window.appConfig.currentStage].teardown()
            if (action && action.action === 'levelSelect') {
              window.appConfig.currentStageIndex = action.level
              window.appConfig.currentStage = window.appConfig.stagesArray[window.appConfig.currentStageIndex]
            }

            if (action && action.action === 'next') {
              window.appConfig.currentStageIndex++
              if (window.appConfig.currentStageIndex >= window.appConfig.stagesArray.length) {
                window.appConfig.currentStageIndex = 0
              }
              window.appConfig.currentStage = window.appConfig.stagesArray[window.appConfig.currentStageIndex]
            }

            // window.appConfig.gameModeFunctions.start()
            window.appConfig.timers.activeTimers.push(window.appConfig.timers.countdownName())

            // turn into countdown which then calls start()
            document.querySelector("#curtain").classList.add("opacity-0");
            const restartBallPosition = window.appConfig.stages[window.appConfig.currentStage].data.startingPosition
            window.appConfig.positionBall(restartBallPosition)
            window.appConfig.timers.data.initialBallZoom.percentComplete = 0
            window.appConfig.timers.data.stageReset.percentComplete = 0
            window.appConfig.timers.data.stageResultsBallZoom.percentComplete = 0

            //            window.appConfig.positionCamera(restartBallPosition)
          }
        }
      },
      stageResultsBallZoom: () => {
        return {
          started: 0,
          ended: 0,
          z: scene.children.find((obj) => obj.gameName === "SPHERE0")
            .position.z,
          percentComplete: 0,
          time: 2000,
          timeLeft: 0,
          currentTime: 0,
          name: 'STAGERESULTSBALLZOOM',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.stageResultsBallZoom.percentComplete = percentComplete
          }
        }
      },
      spriteFetch0: (sprite) => {
        return {
          started: 0,
          ended: 0,
          z: scene.children.find((obj) => obj.gameName === "SPHERE0")
            .position.z,
          percentComplete: 0,
          time: 2000,
          timeLeft: 0,
          currentTime: 0,
          name: 'SPRITEFETCH0',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.spriteFetch0.percentComplete = percentComplete
          }
        }
      },
      spriteFetch1: (sprite) => {
        return {
          started: 0,
          ended: 0,
          z: scene.children.find((obj) => obj.gameName === "SPHERE0")
            .position.z,
          percentComplete: 0,
          time: 2000,
          timeLeft: 0,
          currentTime: 0,
          name: 'SPRITEFETCH1',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.spriteFetch1.percentComplete = percentComplete
          }
        }
      },
      spriteFetch2: (sprite) => {
        return {
          started: 0,
          ended: 0,
          z: scene.children.find((obj) => obj.gameName === "SPHERE0")
            .position.z,
          percentComplete: 0,
          time: 2000,
          timeLeft: 0,
          currentTime: 0,
          name: 'SPRITEFETCH2',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.spriteFetch2.percentComplete = percentComplete
          }
        }
      },
      spriteFetch3: (sprite) => {
        return {
          started: 0,
          ended: 0,
          z: scene.children.find((obj) => obj.gameName === "SPHERE0")
            .position.z,
          percentComplete: 0,
          time: 2000,
          timeLeft: 0,
          currentTime: 0,
          name: 'SPRITEFETCH3',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.spriteFetch3.percentComplete = percentComplete
          }
        }
      },
      spriteFetch4: (sprite) => {
        return {
          started: 0,
          ended: 0,
          z: scene.children.find((obj) => obj.gameName === "SPHERE0")
            .position.z,
          percentComplete: 0,
          time: 2000,
          timeLeft: 0,
          currentTime: 0,
          name: 'SPRITEFETCH4',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.spriteFetch4.percentComplete = percentComplete
          }
        }
      },
      spriteReturn0: (sprite0) => {
        return {
          started: 0,
          ended: 0,
          z: scene.children.find((obj) => obj.gameName === "SPHERE0")
            .position.z,
          percentComplete: 0,
          time: 800,
          timeLeft: 0,
          currentTime: 0,
          name: 'SPRITERETURN0',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.spriteReturn0.percentComplete = percentComplete
          },
          completedCallback: (percentComplete) => {
            sprite0.isReturning = false
            sprite0.returnData = {}
            window.appConfig.timers.data.spriteReturn0.percentComplete = 0
          }
        }
      },
      spriteReturn1: (sprite0) => {
        return {
          started: 0,
          ended: 0,
          z: scene.children.find((obj) => obj.gameName === "SPHERE0")
            .position.z,
          percentComplete: 0,
          time: 800,
          timeLeft: 0,
          currentTime: 0,
          name: 'SPRITERETURN1',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.spriteReturn1.percentComplete = percentComplete
          },
          completedCallback: (percentComplete) => {
            sprite0.isReturning = false
            sprite0.returnData = {}
            window.appConfig.timers.data.spriteReturn1.percentComplete = 0
          }
        }
      },
      spriteReturn2: (sprite0) => {
        return {
          started: 0,
          ended: 0,
          z: scene.children.find((obj) => obj.gameName === "SPHERE0")
            .position.z,
          percentComplete: 0,
          time: 800,
          timeLeft: 0,
          currentTime: 0,
          name: 'SPRITERETURN2',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.spriteReturn2.percentComplete = percentComplete
          },
          completedCallback: (percentComplete) => {
            sprite0.isReturning = false
            sprite0.returnData = {}
            window.appConfig.timers.data.spriteReturn2.percentComplete = 0
          }
        }
      },
      spriteReturn3: (sprite0) => {
        return {
          started: 0,
          ended: 0,
          z: scene.children.find((obj) => obj.gameName === "SPHERE0")
            .position.z,
          percentComplete: 0,
          time: 800,
          timeLeft: 0,
          currentTime: 0,
          name: 'SPRITERETURN3',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.spriteReturn3.percentComplete = percentComplete
          },
          completedCallback: (percentComplete) => {
            sprite0.isReturning = false
            sprite0.returnData = {}
            window.appConfig.timers.data.spriteReturn3.percentComplete = 0
          }
        }
      },
      spriteReturn4: (sprite0) => {
        return {
          started: 0,
          ended: 0,
          z: scene.children.find((obj) => obj.gameName === "SPHERE0")
            .position.z,
          percentComplete: 0,
          time: 800,
          timeLeft: 0,
          currentTime: 0,
          name: 'SPRITERETURN4',
          id: Math.round(Math.random() * 10000),
          activeCallback: (percentComplete) => {
            window.appConfig.timers.data.spriteReturn4.percentComplete = percentComplete
          },
          completedCallback: (percentComplete) => {
            sprite0.isReturning = false
            sprite0.returnData = {}
            window.appConfig.timers.data.spriteReturn4.percentComplete = 0
          }
        }
      },
      data: {
        initialBallZoom: {
          percentComplete: 0
        },
        stageReset: {
          percentComplete: 0
        },
        stageResultsBallZoom: {
          percentComplete: 0
        },
        spriteFetch0: {
          percentComplete: 0
        },
        spriteFetch1: {
          percentComplete: 0
        },
        spriteFetch2: {
          percentComplete: 0
        },
        spriteFetch3: {
          percentComplete: 0
        },
        spriteFetch4: {
          percentComplete: 0
        },
        spriteReturn0: {
          percentComplete: 0
        },
        spriteReturn1: {
          percentComplete: 0
        },
        spriteReturn2: {
          percentComplete: 0
        },
        spriteReturn3: {
          percentComplete: 0
        },
        spriteReturn4: {
          percentComplete: 0
        }
      },
      activeTimers: []
    }

    window.appConfig.timers = timers
    const appTimers = window.appConfig.timers
    window.appConfig.coinFrameCheckNumber = 0


    render = function () {
      currentTime = new Date().getTime();

      if (!window.appConfig.stages[window.appConfig.currentStage].data.started) {
        window.appConfig.stages[window.appConfig.currentStage].init()
      } else {
        if (!window.appConfig.pause && !window.appConfig.userHasEnded) {
          window.appConfig.activeTransforms.length > 0 && window.appConfig.activeTransforms.forEach(t => {
            if (window.appConfig.stages[window.appConfig.currentStage].transforms[t].r && window.appConfig.stages[window.appConfig.currentStage][t]) {
              window.appConfig.stages[window.appConfig.currentStage][t].rotation.x += window.appConfig.stages[window.appConfig.currentStage].transforms[t].r.x
              window.appConfig.stages[window.appConfig.currentStage][t].rotation.y += window.appConfig.stages[window.appConfig.currentStage].transforms[t].r.y
              window.appConfig.stages[window.appConfig.currentStage][t].rotation.z += window.appConfig.stages[window.appConfig.currentStage].transforms[t].r.z
              window.appConfig.stages[window.appConfig.currentStage][t].__dirtyRotation = true
            }
            if (window.appConfig.stages[window.appConfig.currentStage].transforms[t].t && window.appConfig.stages[window.appConfig.currentStage][t]) {
              window.appConfig.stages[window.appConfig.currentStage][t].position.x += window.appConfig.stages[window.appConfig.currentStage].transforms[t].t.x
              window.appConfig.stages[window.appConfig.currentStage][t].position.y += window.appConfig.stages[window.appConfig.currentStage].transforms[t].t.y
              window.appConfig.stages[window.appConfig.currentStage][t].position.z += window.appConfig.stages[window.appConfig.currentStage].transforms[t].t.z
              window.appConfig.stages[window.appConfig.currentStage][t].__dirtyPosition = true
            }
            if (window.appConfig.stages[window.appConfig.currentStage].transforms[t].callback && window.appConfig.stages[window.appConfig.currentStage][t]) {
              callback(t, window.appConfig.stages[window.appConfig.currentStage].transforms[t])
            }
          })
        }
      }

      if (appTimers.activeTimers.length > 0) {
        let removeTimersArray = []
        appTimers.activeTimers.forEach((t, ti) => {
          if (appTimers.activeTimers[ti].started === 0) {
            appTimers.activeTimers[ti].started = currentTime
            appTimers.activeTimers[ti].currentTime = currentTime
            if (appTimers.activeTimers[ti].startedCallback) {
              appTimers.activeTimers[ti].startedCallback(appTimers.activeTimers[ti].percentComplete)
            }
          }
          if (appTimers.activeTimers[ti].started !== 0 && appTimers.activeTimers[ti].ended === 0) {
            appTimers.activeTimers[ti].currentTime = currentTime
            appTimers.activeTimers[ti].percentComplete = (currentTime - appTimers.activeTimers[ti].started) / appTimers.activeTimers[ti].time;
            appTimers.activeTimers[ti].timeLeft = (currentTime - appTimers.activeTimers[ti].started)
            console.log("time left: " + appTimers.activeTimers[ti].timeLeft);
            console.log("% complete: " + appTimers.activeTimers[ti].percentComplete);
            if (appTimers.activeTimers[ti].activeCallback) {
              appTimers.activeTimers[ti].activeCallback(appTimers.activeTimers[ti].percentComplete)
            }
            if (appTimers.activeTimers[ti].timeLeft > appTimers.activeTimers[ti].time) {
              // end the timer --> this will make the first check not fire the function since ended has a value
              appTimers.activeTimers[ti].ended = currentTime
              console.log('timer ended: ', appTimers.activeTimers[ti]);
              removeTimersArray.push(appTimers.activeTimers[ti].name)
              if (appTimers.activeTimers[ti].completedCallback) {
                appTimers.activeTimers[ti].completedCallback(appTimers.activeTimers[ti].percentComplete)
              }
            }
          }
        })
        if (removeTimersArray.length > 0) {
          removeTimersArray.forEach(rt => {
            appTimers.activeTimers.forEach((at, ati) => {
              if (at.name === rt) {
                appTimers.activeTimers.splice(ati, 1)
              }
            })
          })
        }
      }

      const sphere = scene.children.find((obj) => obj.gameName === "SPHERE0");
      const pointLight0 = scene.children
        .find((obj) => obj.gameName === "POINTLIGHT0")
      const pointLight1 = scene.children
        .find((obj) => obj.gameName === "POINTLIGHT1")
      const pointLight2 = scene.children
        .find((obj) => obj.gameName === "POINTLIGHT2")
      const pointLight3 = scene.children
        .find((obj) => obj.gameName === "POINTLIGHT3")
      if (
        window.appConfig.start === false ||
        window.appConfig.pause === true
      ) {
        if (window.appConfig.start === false) {
          sphere.position.set(0, 10, 0);
        }
        sphere
          .setLinearVelocity(new THREE.Vector3(0, 0, 0));
      } else {
        if (
          window.appConfig.touchStart === true &&
          window.appConfig.touchEnd === false
        ) {
          console.log("ACTIVE!!!");
          const scaleV = 0.25;
          let newVelocity = new THREE.Vector3(
            window.appConfig.diffX * scaleV,
            window.appConfig.diffY * -scaleV,
            0
          )
          const speedClamp = 50
          const newVelocityLength = newVelocity.length()
          if (newVelocityLength > speedClamp) {
            //            debugger
            newVelocity = newVelocity.multiplyScalar(speedClamp / newVelocityLength)
          }
          console.log(newVelocity)
          sphere
            .setLinearVelocity(newVelocity)
        }
      }

      pointLight0.position.set(
        sphere.position.x,
        sphere.position.y + 1,
        sphere.position.z
      );

      pointLight1.position.set(
        sphere.position.x * lfo(1000),
        sphere.position.y * lfo(750),
        sphere.position.z * lfo(1500)
      );

      pointLight2.position.set(
        sphere.position.x * lfo(777),
        sphere.position.y * lfo(1212),
        sphere.position.z * lfo(993)
      );

      pointLight3.position.set(
        sphere.position.x * lfo(750),
        sphere.position.y * lfo(500),
        sphere.position.z * lfo(1412)
      );

      if (currentTime % 10 < 3) {
        // let countdownNameFlag = false
        // window.appConfig.timers.activeTimers.forEach(at => {
        //   if(at.name === 'COUNTDOWNNAME') {
        //     countdownNameFlag = true
        //   }
        // })
        // if(countdownNameFlag === false) {
        const percentFinished = Math.abs(sphere.position.y) / 375;
        window.appConfig.percentFinished = percentFinished;
        document.body.style.background =
          window.appConfig.stages.components.background(
            percentFinished,
            window.appConfig.stages[window.appConfig.currentStage].backgroundColors
          )
        // }
      }

      // camera positioning
      camera.position.x = sphere.position.x;
      camera.position.y = sphere.position.y;
      camera.position.z =
        10 +
        80 * window.appConfig.timers.data.initialBallZoom.percentComplete -
        window.appConfig.timers.data.stageResultsBallZoom.percentComplete * 80 -
        window.appConfig.timers.data.stageReset.percentComplete * 5;
      // camera.position.z =
      //   10 +
      //   90 * window.appConfig.timers.data.initialBallZoom.percentComplete -
      //   window.appConfig.timers.data.stageResultsBallZoom.percentComplete * 90 -
      //   window.appConfig.timers.data.stageReset.percentComplete * 5;

      if (window.appConfig.userHasEnded) {
        sphere
          .setLinearVelocity(new THREE.Vector3(0, 0, 0));
        sphere
          .setAngularVelocity(new THREE.Vector3(0, 0, 0));
      }
      window.appConfig.crystalMaterials.forEach(cm => {

        const newHsl = colorLightnessLfo(cm.pulsing.color, 268)
        cm.pulsing.color.setHSL(newHsl.h, newHsl.s, newHsl.l)
        // cm.pulsing.color.setHSL(newHsl.h, newHsl.s, 0)
      })


      const sphereLinearVelocityLength = sphere.getLinearVelocity().length()
      const xCoinMod = 2 + sphereLinearVelocityLength * .03
      const yCoinMod = 3 + sphereLinearVelocityLength * .03

      let coinIndexToRemove = undefined;
      const potentiallyGrabbedCoin = window.appConfig.coins.find(
        (coin, coinIndex) => {
          if (coinIndex % (window.appConfig.coinFrameCheckNumber % 5) < 1) {
            coinIndexToRemove = coinIndex;
            if (
              Math.abs(coin.position.x - sphere.position.x) <
              coin.scale.x * xCoinMod &&
              Math.abs(coin.position.y - sphere.position.y) < coin.scale.x * yCoinMod) {
              return true
            } else return false;
          }
        }
      );
      //  && window.appConfig.coinFrameCheckNumber % 2 < 1
      if (window.appConfig.stages[window.appConfig.currentStage].bgGroupActiveCallback) {
        window.appConfig.stages[window.appConfig.currentStage].bgGroupActiveCallback()
      }

      if (potentiallyGrabbedCoin) {
        console.log(potentiallyGrabbedCoin)
        const coinValue = potentiallyGrabbedCoin.coinValue
        const prizeValue = potentiallyGrabbedCoin.prizeValue
        if (potentiallyGrabbedCoin.spriteFetching) {
          potentiallyGrabbedCoin.spriteFetching.fetchData = {}
          potentiallyGrabbedCoin.spriteFetching.isFetchingCoin = false
          const foundTimerIndex = window.appConfig.timers.activeTimers.findIndex((timer, timerIndex) => {
            return timer.name === `SPRITEFETCH${potentiallyGrabbedCoin.spriteFetching.num}`
          })
          if (foundTimerIndex > -1) {
            window.appConfig.timers.activeTimers.splice(foundTimerIndex, 1)
          }
          potentiallyGrabbedCoin.spriteFetching.isReturning = true
          console.log(`spriteReturn${potentiallyGrabbedCoin.spriteFetching.num}`)
          window.appConfig.timers.activeTimers.push(window.appConfig.timers[`spriteReturn${potentiallyGrabbedCoin.spriteFetching.num}`](potentiallyGrabbedCoin.spriteFetching))
          console.log(window.appConfig.timers.activeTimers)
          potentiallyGrabbedCoin.spriteFetching.returnData = {
            startingPosition: potentiallyGrabbedCoin.spriteFetching.mesh.position.clone()
          }
        }
        if (coinValue > 0) {
          window.appConfig.score.coins += potentiallyGrabbedCoin.coinValue;
          potentiallyGrabbedCoin.visible = false
          window.appConfig.coins.splice(coinIndexToRemove, 1);
          document.querySelector("#score").innerText =
            window.appConfig.score.coins;
          if (potentiallyGrabbedCoin.coinType === 'single') {
            window.appConfig.howlSounds.coins.sCoin[Math.floor(Math.random() * 2.99)].play()
          }
          if (potentiallyGrabbedCoin.coinType === 'double') {
            window.appConfig.howlSounds.coins.mCoin[Math.floor(Math.random() * 2.99)].play()
          }
          if (potentiallyGrabbedCoin.coinType === 'triple') {
            window.appConfig.howlSounds.coins.lCoin[Math.floor(Math.random() * 2.99)].play()
          }

        } else if (prizeValue > 0) {
          window.appConfig.howlSounds.prize.play()
          window.appConfig.score.coins += potentiallyGrabbedCoin.prizeValue;
          potentiallyGrabbedCoin.visible = false
          window.appConfig.coins.splice(coinIndexToRemove, 1);
          document.querySelector("#score").innerText =
            window.appConfig.score.coins;
          // startStageEnd()
          //add ten secs
          console.log(window.appConfig.timer.getTimeValues())
          const currentTime = window.appConfig.timer.getTimeValues()
          const newTimer = new easytimer.Timer({ countdown: true, startValues: { seconds: currentTime.seconds + 10, secondTenths: currentTime.secondTenths }, precision: "secondTenths" });

          window.appConfig.timer.stop()
          window.appConfig.timer.removeEventListener("secondTenthsUpdated", function (e) {
            document.querySelector(
              "#timer"
            ).innerText = `${window.appConfig.timer
              .getTimeValues()
              .toString(["minutes", "seconds", "secondTenths"])}`;
          });
          window.appConfig.timer.removeEventListener("targetAchieved", function (e) {
            startStageEnd()
          })
          window.appConfig.timer = newTimer
          newTimer.start()
          newTimer.addEventListener("secondTenthsUpdated", function (e) {
            document.querySelector(
              "#timer"
            ).innerText = `${window.appConfig.timer
              .getTimeValues()
              .toString(["minutes", "seconds", "secondTenths"])}`;
          });
          newTimer.addEventListener("targetAchieved", function (e) {
            startStageEnd()
          })
        }
      }

      window.appConfig.sprites.forEach(sprite => {
        sprite.activeCallback()
      }
      )


      window.appConfig.coinFrameCheckNumber++
      requestAnimationFrame(render);
      renderer.render(scene, camera);
      render_stats.update();
    };

    window.appConfig.positionBall = (p) => {
      const sphere = scene.children.find((obj) => obj.gameName === "SPHERE0")
      sphere.position.x = p.x
      sphere.position.y = p.y
      sphere.position.z = p.z
      sphere.__dirtyPosition = true
    }

    window.appConfig.positionCamera = (p) => {
      const cam = scene.children.find((obj) => obj.type === "PerspectiveCamera")
      cam.position.x = p.x
      cam.position.y = p.y
      cam.position.z = p.z
      cam.__dirtyPosition = true
    }

    const calculateStageScore = (seconds, coins) => {
      let normalizedSeconds = Math.floor(seconds)
      if (normalizedSeconds < 1) {
        normalizedSeconds = 1
      }
      let score = normalizedSeconds * coins
      return score
    }

    const startStageEnd = () => {
      //now start end of stage
      window.appConfig.userHasEnded = true

      scene.setGravity(new THREE.Vector3(0, 0, 0));
      window.appConfig.sphere._physijs.mass = 0

      window.appConfig.timers.activeTimers.push(window.appConfig.timers.stageResultsBallZoom())
      window.appConfig.timer.pause();
      window.appConfig.results[`stage${window.appConfig.level}`]
        ? (window.appConfig.results[
          `stage${window.appConfig.level}`
        ].finalTime = window.appConfig.timer
          .getTimeValues()
          .toString(["minutes", "seconds", "secondTenths"]))
        : (window.appConfig.results[
          `stage${window.appConfig.level}`
        ] = {
          finalTime: window.appConfig.timer
            .getTimeValues()
            .toString(["minutes", "seconds", "secondTenths"]),
        });
      //now performance report and start level transition
      console.dir(window.appConfig.results);
      const stageScore = calculateStageScore(window.appConfig.timer
        .getTimeValues().seconds, window.appConfig.score.coins)
      document.querySelector("#report-time").innerText =
        window.appConfig.results[
          `stage${window.appConfig.level}`
        ].finalTime;
      document.querySelector("#report-coins").innerText =
        window.appConfig.score.coins;
      document.querySelector("#report-score").innerText =
        stageScore;
      showReport()
      document.querySelector("#pause-button").disabled = true;

    }

    const countdown = () => {
      window.appConfig.timers.activeTimers.push(window.appConfig.timers.countdownName())
    }

    const start = () => {
      window.appConfig.userHasEnded = false
      window.appConfig.start = true;
      window.appConfig.pause = false;
      if (!window.appConfig.howlSounds.backgroundMusic.playing()) (
        window.appConfig.howlSounds.backgroundMusic.play()
      )
      setTimeout(() => showHTMLElements(["pause-button", "game-scoreboard"]), 1000)
      // window.appConfig.initialBallZoom.userHasClickedStart = true;
      window.appConfig.timers.activeTimers.push(timers.initialBallZoom())
      window.appConfig.timer.start();
      scene.setGravity(new THREE.Vector3(0, -10, 0));
      window.appConfig.sphere._physijs.mass = window.appConfig.defaultSphereMass
      document.querySelector("#pause-button").disabled = false;
      const theBall = scene.children.find(c => c.gameName === 'SPHERE0')
      theBall.position.set(window.appConfig.stages[window.appConfig.currentStage].data.startingPosition);
      window.appConfig.activeTransforms = window.appConfig.stages[window.appConfig.currentStage].defaultTransforms
      const sphere = scene.children.find(obj => {
        if (obj.gameName === "SPHERE0" && obj.type === "Mesh") {
          return obj
        }
      })
      sphere.setLinearVelocity(new THREE.Vector3(0, -10, 0))
    };

    const pause = () => {
      window.appConfig.pause
        ? window.appConfig.howlSounds.backgroundMusic.play()
        : window.appConfig.howlSounds.backgroundMusic.pause();
      window.appConfig.pause = !window.appConfig.pause;
      if (window.appConfig.pause) {
        window.appConfig.timer.pause();
        scene.setGravity(new THREE.Vector3(0, 0, 0));
        window.appConfig.sphere._physijs.mass = 0
        showPauseMenu();
      } else {
        scene.setGravity(new THREE.Vector3(0, window.appConfig.defaultSceneGravity, 0));
        window.appConfig.sphere._physijs.mass = window.appConfig.defaultSphereMass
        window.appConfig.timer.start();
        showGameMode();
      }
    };

    const reset = (action) => {
      window.appConfig.timers.activeTimers.push(window.appConfig.timers.stageReset(action))
      window.appConfig.results = {}
      window.appConfig.score.coins = 0
      window.appConfig.diffX = 0
      window.appConfig.diffY = 0
      window.appConfig.sprites.forEach(sprite => {
        sprite.reset()
      })
      document.querySelector("#score").innerText = 0
      showHTMLElements([]);
      document.querySelector("#curtain").classList.remove("opacity-0");
      const newTimer = new easytimer.Timer({ countdown: true, startValues: { seconds: window.appConfig.easyTimerLength }, precision: "secondTenths" });
      window.appConfig.timer.stop()
      window.appConfig.timer.removeEventListener("secondTenthsUpdated", function (e) {
        document.querySelector(
          "#timer"
        ).innerText = `${window.appConfig.timer
          .getTimeValues()
          .toString(["minutes", "seconds", "secondTenths"])}`;
      });
      window.appConfig.timer.removeEventListener("targetAchieved", function (e) {
        startStageEnd()
      })
      window.appConfig.timer = newTimer
      newTimer.start()
      newTimer.addEventListener("secondTenthsUpdated", function (e) {
        document.querySelector(
          "#timer"
        ).innerText = `${window.appConfig.timer
          .getTimeValues()
          .toString(["minutes", "seconds", "secondTenths"])}`;
      });
      newTimer.addEventListener("targetAchieved", function (e) {
        startStageEnd()
      })
      window.appConfig.timer.reset();
      window.appConfig.timer.pause();
      window.appConfig.activeTransforms = []
    };

    window.appConfig.gameModeFunctions = {
      start: start,
      reset: reset,
      pause: pause
    }
    const colorLightnessLfo = (baseColor, lfoMod) => {
      const color = new THREE.Color(baseColor)
      let hsl = {}
      color.getHSL(hsl)
      const theLfo = lfoPositive(141 + lfoMod) * .6
      hsl.l = hsl.l + theLfo
      return hsl
    }
    const showReport = () => {
      showHTMLElements(["report", "tinted-overlay"]);
      centerElement({ id: "report", offsetTop: 0, offsetLeft: 0 });
    }
    const showLevelSelect = () => {
      showHTMLElements(["level-select", "tinted-overlay"]);
      centerElement({ id: "level-select", offsetTop: 0, offsetLeft: 0 });
    };
    const showSounds = () => {
      showHTMLElements(["sounds", "tinted-overlay"]);
      centerElement({ id: "sounds", offsetTop: 0, offsetLeft: 0 });
    };
    const showCredits = () => {
      showHTMLElements(["credits", "tinted-overlay"]);
      centerElement({ id: "credits", offsetTop: 0, offsetLeft: 0 });
    };
    const showStart = () => {
      showHTMLElements(["start-menu", "title", "start-button-container", "tinted-overlay"]);
      centerElement({ id: "start-button-container", offsetTop: 0, offsetLeft: 0 });
      centerElement({ id: "title", offsetTop: "-31%", offsetLeft: 0 });
      centerElement({ id: "start-menu", offsetTop: "31%", offsetLeft: 0 });
    };
    const showPauseMenu = () => {
      showHTMLElements(["pause-button", "pause-menu", "game-scoreboard", "tinted-overlay"]);
      centerElement({ id: "pause-menu", offsetTop: 0, offsetLeft: 0 });
    };

    const showStageCountDownName = () => {
      showHTMLElements(["stage-name", "stage-number", "tinted-overlay"]);
      centerElement({ id: "stage-name", offsetTop: 0, offsetLeft: 0 });
      centerElement({ id: "stage-number", offsetTop: "-40%", offsetLeft: 0 });
    };

    const showStageCountDown3 = () => {
      showHTMLElements(["stage-countdown-3", "tinted-overlay"]);
      centerElement({ id: "stage-countdown-3", offsetTop: 0, offsetLeft: 0 });
    };

    const showStageCountDown2 = () => {
      showHTMLElements(["stage-countdown-2", "tinted-overlay"]);
      centerElement({ id: "stage-countdown-2", offsetTop: 0, offsetLeft: 0 });
    };

    const showStageCountDown1 = () => {
      showHTMLElements(["stage-countdown-1", "tinted-overlay"]);
      centerElement({ id: "stage-countdown-1", offsetTop: 0, offsetLeft: 0 });
    };

    const showStageCountDownStart = () => {
      showHTMLElements(["stage-countdown-start", "pause-button", "game-scoreboard"]);
      centerElement({ id: "stage-countdown-start", offsetTop: 0, offsetLeft: 0 });
    };

    const showGameMode = () => {
      showHTMLElements(["pause-button", "game-scoreboard"]);
    };
    const goBack = () => {
      if (window.appConfig.pause) {
        showPauseMenu();
      } else if (window.appConfig.userHasEnded) {
        showReport()
      } else {
        showStart();
      }
    };
    const centerElement = (options) => {
      const { id, offsetLeft, offsetTop } = options;
      const element = document.getElementById(id);
      const buttonHeight = element.offsetHeight;
      const buttonWidth = element.offsetWidth;
      let offsetHeight
      if (typeof offsetTop === "number") {
        offsetHeight = window.innerHeight / 2 - buttonHeight / 2 + offsetTop;
      } else {
        const parsedNum = Number.parseInt(offsetTop)
        const percentFromTop = (50 + parsedNum) / 100 //assume it's a percent between -50% and 50%
        offsetHeight = window.innerHeight * percentFromTop - buttonHeight / 2;
      }
      let offsetWidth
      if (typeof offsetLeft === "number") {
        offsetWidth = window.innerWidth / 2 - buttonWidth / 2 + offsetLeft;
      } else {
        const parsedNum = Number.parseInt(offsetLeft)
        const percentFromLeft = (50 + parsedNum) / 100 //assume it's a percent between -50% and 50%
        offsetWidth = window.innerWidth * percentFromLeft - buttonWidth / 2;
      }


      const root = document.documentElement;
      root.style.setProperty(`--${id}-offset-top`, offsetHeight + "px");
      root.style.setProperty(`--${id}-offset-left`, offsetWidth + "px");
    };

    const setFontSizes = () => {
      let hSq = window.innerHeight * window.innerHeight
      let wSq = window.innerWidth * window.innerWidth
      let diagonalLength = Math.sqrt(hSq + wSq)
      const root = document.documentElement;
      root.style.setProperty(`--font-size-0`, Math.ceil(diagonalLength * .01) + "px");
      root.style.setProperty(`--font-size-1`, Math.ceil(diagonalLength * .02) + "px");
      root.style.setProperty(`--font-size-2`, Math.ceil(diagonalLength * .03) + "px");
      root.style.setProperty(`--font-size-3`, Math.ceil(diagonalLength * .04) + "px");
      root.style.setProperty(`--font-size-4`, Math.ceil(diagonalLength * .05) + "px");
      root.style.setProperty(`--font-size-5`, Math.ceil(diagonalLength * .06) + "px");
      root.style.setProperty(`--font-size-6`, Math.ceil(diagonalLength * .07) + "px");
      root.style.setProperty(`--font-size-7`, Math.ceil(diagonalLength * .08) + "px");
      root.style.setProperty(`--full-screen-width`, Math.ceil(window.innerWidth) + "px");
      root.style.setProperty(`--quarter-screen-height`, Math.ceil(window.innerHeight * .25) + "px");
    }
    const changeMusicVolume = (val) => {
      // window.appConfig.backgroundMusics.forEach((m, mIndex) => {
      //   const currentVol = m.volume();
      //   m.fade(currentVol, val * 0.1 * 0.01, 1);
      // });
    };
    const changeSFXVolume = (val) => {
      // window.appConfig.howlSounds.forEach((m, mIndex) => {
      //   const currentVol = m.volume();
      //   m.fade(currentVol, val * 0.01, 1);
      // });
    };
    const allElements = [
      "sounds",
      "start-menu",
      "pause-menu",
      "report",
      "level-select",
      "game-scoreboard",
      "title",
      "credits",
      "start-button-container",
      "pause-button",
      "tinted-overlay",
      "stage-name",
      "stage-number",
      "stage-countdown-3",
      "stage-countdown-2",
      "stage-countdown-1",
      "stage-countdown-start"
    ];
    const showHTMLElements = (elements) => {
      // elements is an array of id strings
      allElements.forEach((el) => {
        document.getElementById(el).classList.add("hide");
      });
      elements.forEach((el) => {
        document.getElementById(el).classList.remove("hide");
      });
    };
    const setLevel = (level) => {
      window.appConfig.level = level;
    };
    const toggleSFXButton = () => {
      console.log('sfx firing')
      window.appConfig.sfxTurnedOn = !window.appConfig.sfxTurnedOn
      const sfxButton =
        document.querySelector('#sfx-toggle-button')
      if (window.appConfig.sfxTurnedOn) {
        sfxButton.textContent = "ON"
        changeSFXVolume(100)
      } else {
        sfxButton.textContent = "OFF"
        changeSFXVolume(0)
      }
    }
    const toggleMusicButton = () => {
      console.log('music firing')
      window.appConfig.musicTurnedOn = !window.appConfig.musicTurnedOn
      const musicButton =
        document.querySelector('#music-toggle-button')
      if (window.appConfig.musicTurnedOn) {
        musicButton.textContent = "ON"
        changeMusicVolume(100)
      } else {
        musicButton.textContent = "OFF"
        changeMusicVolume(0)
      }
    }
    window.onload = initScene;
  </script>
</head>

<body>
  <div class="debug hide">
  </div>
  <div id="viewport"></div>
  <div id="tinted-overlay"></div>
  <div id="game-scoreboard" class="hide">
    <div id="timer"></div>
    <div id="score"></div>
  </div>
  <div id="sounds" class="hide">
    <div id="sounds-title" class="menu-title-text">Sounds</div>
    <table id="sound-menu">
      <tr>
        <td class="sound-menu-button sound-menu-left-td">SFX</td>
        <td class="sound-menu-right-td"><button class="sound-menu-button" id="sfx-toggle-button"
            onClick="toggleSFXButton()"></button></td>
      </tr>
      <tr>
        <td class="sound-menu-button sound-menu-left-td">Music</td>
        <td class="sound-menu-right-td"><button class="sound-menu-button" id="music-toggle-button"
            onClick="toggleMusicButton()"></button></td>
      </tr>
    </table>
    <button class="start-menu-button" onClick="goBack()">Back</button>
  </div>
  <div id="credits" class="hide">
    <div id="credits-title" class="menu-title-text">Credits</div>
    <div id="credits-menu">
      <div class="margin-bottom-2">
        <div class="credits-role">Programming Design</div>
        <div class="credits-name">Sean Lynch, Ian Lynch</div>
      </div>
      <div class="margin-bottom-2">
        <div class="credits-role">UX Design</div>
        <div class="credits-name">Haley Rheinhart, Sean Lynch</div>
      </div class="margin-bottom-2">
      <div>
        <div class="credits-role">Music & Sound Design</div>
        <div class="credits-name">Haley Rheinhart</div>
      </div>
    </div>
    <button class="start-menu-button" onClick="goBack()">Back</button>
  </div>
  <div id="report" class="hide">
    <table>
      <tr>
        <td>Time:</td>
        <td id="report-time"></td>
      </tr>
      <tr>
        <td>Crystals:</td>
        <td id="report-coins"></td>
      </tr>
      <tr>
        <td>Score:</td>
        <td id="report-score"></td>
      </tr>
    </table>
    <div id="report-options">
      <button id="report-level-select-button" class="start-menu-button" onClick="showLevelSelect()">
        Level Select
      </button>
      <button id="report-reset-button" class="start-menu-button" onClick="reset({action:'reset'})">
        Try Again
      </button>
      <button id="report-reset-button" class="start-menu-button" onClick="reset({action:'next'})">
        Next Level
      </button>
    </div>
  </div>
  <div id="level-select" class="hide">
    <div id="level-select-title">Level Select</div>
    <div class="level-select-menu-container">
      <button class="level-select-button stage-0" onClick="reset({action:'levelSelect', level: 0})">Stage 0</button>
      <button class="level-select-button stage-1" onClick="reset({action:'levelSelect', level: 1})">Stage 1</button>
      <button class="level-select-button stage-2" onClick="reset({action:'levelSelect', level: 2})">Stage 2</button>
      <button class="level-select-button stage-3" onClick="reset({action:'levelSelect', level: 3})">Stage 3</button>
      <button class="level-select-button stage-4" onClick="reset({action:'levelSelect', level: 4})">Stage 4</button>
      <button class="level-select-button stage-5" onClick="reset({action:'levelSelect', level: 5})">Stage 5</button>
    </div>
    <button class="start-menu-button" onClick="goBack()">Back</button>
  </div>

  <div id="pause-menu" class="hide">
    <button id="pause-level-select-button" class="start-menu-button" onClick="pause()">
      Resume
    </button>
    <button id="pause-level-select-button" class="start-menu-button" onClick="showLevelSelect()">
      Level Select
    </button>
    <button id="pause-sounds-button" class="start-menu-button" onClick="showSounds()">
      Sounds
    </button>
    <button id="pause-reset-button" class="start-menu-button" onClick="reset({action:'reset'})">
      Restart Level
    </button>
  </div>
  <div id="title">BALLSINKI</div>
  <div id="start-button-container">
    <button id="start-button" onClick="countdown()">Start</button>
  </div>
  <div id="start-menu">
    <button id="start-level-select-button" class="start-menu-button" onClick="showLevelSelect()">
      Level Select
    </button>
    <button id="start-sounds-button" class="start-menu-button" onClick="showSounds()">
      Sounds
    </button>
    <button id="start-credits-button" class="start-menu-button" onClick="showCredits()">
      Credits
    </button>
  </div>

  <div id="stage-number">STAGE 1</div>
  <div id="stage-name" class="hide">
    <div id="stage-name-title">GILGAMESH</div>
  </div>
  <div id="stage-countdown-3" class="hide">3</div>
  <div id="stage-countdown-2" class="hide">2</div>
  <div id="stage-countdown-1" class="hide">1</div>
  <div id="stage-countdown-start" class="hide">START!</div>

  <div id="gradient-curtain"></div>

  <img src="images/pause.png" id="pause-button" disabled class="hide" onClick="pause()" />
  <div id="curtain"></div>
</body>
<script>
  // window.console.log = () => { }
  // window.console.warn = () => { }
  // window.console.dir = () => { }
  // window.console.error = () => { }
</script>

</html>