<!DOCTYPE html>

<html>
  <head>
    <title>Ball Fall</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
      }
      html {
        touch-action: none;
      }
      body {
        background: rgb(2, 0, 36);
        background: linear-gradient(
          180deg,
          rgba(2, 0, 36, 0) 0%,
          rgba(121, 9, 117, 1) 0%,
          rgba(0, 212, 255, 1) 32%,
          rgba(252, 231, 183, 1) 98%
        );
      }
    </style>

    <script type="text/javascript" src="js/ammo.js"></script>
    <script type="text/javascript" src="js/three-121.js"></script>
    <script type="text/javascript" src="js/stats.js"></script>
    <script type="text/javascript" src="js/physi.js"></script>
    <script type="text/javascript" src="js/physijs_worker.js"></script>
    <script type="text/javascript" src="js/THREEOrbitControls.js"></script>
    <script type="text/javascript" src="js/easytimer.js"></script>
    <script type="text/javascript" src="js/howler.min.js"></script>

    <script type="text/javascript">
      "use strict";

      var backgroundMusic0 = new Howl({
        src: ['sounds/ball-fall-sounds 19-3-Audio 1.mp3'],
        autoPlay: true,
        loop: true,
        onend: () => {
          console.log("finished 1")
        }
      });

      var howlSound0 = new Howl({
        src: ['sounds/ball-fall-sounds 15-3-Audio 1.mp3'],
        onstart: () => {
          console.log("started 0")
        },
        onend: () => {
          console.log("finished 0")
        }
      });

      var howlSound1 = new Howl({
        src: ['sounds/ball-fall-sounds 15-3-Audio 1.mp3'],
        onstart: () => {
          console.log("started 1")
        },
        onend: () => {
          console.log("finished 1")
        }
      });

      var howlSound2 = new Howl({
        src: ['sounds/ball-fall-sounds 15-3-Audio 1.mp3'],
        onstart: () => {
          console.log("started 2")
        },
        onend: () => {
          console.log("finished 2")
        }
      });

      var howlSound3 = new Howl({
        src: ['sounds/ball-fall-sounds 15-3-Audio 1.mp3'],
        onstart: () => {
          console.log("started 3")
        },
        onend: () => {
          console.log("finished 3")
        }
      });

      var howlSound4 = new Howl({
        src: ['sounds/ball-fall-sounds 15-3-Audio 1.mp3'],
        onstart: () => {
          console.log("started 4")
        },
        onend: () => {
          console.log("finished 4")
        }
      });

      var howlSound5 = new Howl({
        src: ['sounds/ball-fall-sounds 15-3-Audio 1.mp3'],
        onstart: () => {
          console.log("started 5")
        },
        onend: () => {
          console.log("finished 5")
        }
      });

      var howlSound6 = new Howl({
        src: ['sounds/ball-fall-sounds 15-3-Audio 1.mp3'],
        onstart: () => {
          console.log("started 6")
        },
        onend: () => {
          console.log("finished 6")
        }
      });

      var howlSound7 = new Howl({
        src: ['sounds/ball-fall-sounds 15-3-Audio 1.mp3'],
        onstart: () => {
          console.log("started 7")
        },
        onend: () => {
          console.log("finished 7")
        }
      });

      backgroundMusic0.play()
      Physijs.scripts.worker = "js/physijs_worker.js";
      Physijs.scripts.ammo = "ammo.js";

      const basicColors = [
        new THREE.Color(0xfff1e3),
        new THREE.Color(0xffd5c9),
        new THREE.Color(0xffa6bb),
        new THREE.Color(0xff757f),
        new THREE.Color(0x159294),
      ];

      const getRandomColor = () => {
        return basicColors[Math.floor(Math.random() * basicColors.length)];
      };

      var initScene,
        render,
        _boxes = [],
        spawnBox,
        loader,
        renderer,
        render_stats,
        physics_stats,
        scene,
        ground_material,
        ground,
        light,
        camera,
        orbitControls;

      initScene = function () {
        window.appConfig = {};
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x000000, 0);
        renderer.shadowMap.enabled = true;
        renderer.shadowMapSoft = true;
        document.getElementById("viewport").appendChild(renderer.domElement);

        render_stats = new Stats();
        render_stats.domElement.style.position = "absolute";
        render_stats.domElement.style.top = "0px";
        render_stats.domElement.style.zIndex = 100;
        document
          .getElementById("viewport")
          .appendChild(render_stats.domElement);

        physics_stats = new Stats();
        physics_stats.domElement.style.position = "absolute";
        physics_stats.domElement.style.top = "50px";
        physics_stats.domElement.style.zIndex = 100;
        document
          .getElementById("viewport")
          .appendChild(physics_stats.domElement);

        scene = new Physijs.Scene();

        // scene.background = getRandomColor();
        scene.setGravity(new THREE.Vector3(0, -10, 0));

        scene.addEventListener("update", function () {
          scene.simulate(undefined, 1);
          physics_stats.update();
        });

        const skyColor = getRandomColor();
        const groundColor = getRandomColor();
        const hemisphereLight = new THREE.HemisphereLight(
          skyColor,
          groundColor,
          0.75
        );
        scene.add(hemisphereLight);

        camera = new THREE.PerspectiveCamera(
          35,
          window.innerWidth / window.innerHeight,
          1,
          1000
        );
        camera.position.set(0, 25, 100);
        camera.lookAt(scene.position);
        scene.add(camera);

        // Light
        light = new THREE.SpotLight(0xffffff);
        light.position.set(20, 80, 15);
        light.target.position.copy(scene.position);
        light.castShadow = true;
        light.shadowCameraLeft = -60;
        light.shadowCameraTop = -60;
        light.shadowCameraRight = 60;
        light.shadowCameraBottom = 60;
        light.shadowCameraNear = 20;
        light.shadowCameraFar = 200;
        light.shadowBias = -0.0001;
        light.shadowMapWidth = light.shadowMapHeight = 2048;
        light.shadowDarkness = 0.7;
        scene.add(light);

        const pointLight0 = new THREE.PointLight(getRandomColor(), 1);
        pointLight0.gameName = "POINTLIGHT0";
        pointLight0.power = 5;
        pointLight0.decay = 1;
        pointLight0.distance = 5;
        scene.add(pointLight0);

        // LFO
        const lfoPositive = (t = 1000) => {
          let lfoValue = (0.5 + 0.5 * Math.cos(Date.now() / t)) * 1;
          return lfoValue;
        };

        const lfo = (t = 1000) => {
          return (0.5 - lfoPositive(t)) * 2;
        };

        // Orbit Controls
        // orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
        // orbitControls.enableRotate = false;

        //resize event handler
        function onWindowResize(event) {
          // remember these initial values
          var tanFOV = Math.tan(((Math.PI / 180) * camera.fov) / 2);
          var windowHeight = window.innerHeight;
          camera.aspect = window.innerWidth / window.innerHeight;

          // adjust the FOV
          camera.fov =
            (360 / Math.PI) *
            Math.atan(tanFOV * (window.innerHeight / windowHeight));

          camera.updateProjectionMatrix();
          camera.lookAt(scene.position);

          renderer.setSize(window.innerWidth, window.innerHeight);
          renderer.render(scene, camera);
        }
        onWindowResize();
        window.addEventListener("resize", onWindowResize, false);

        loader = new THREE.TextureLoader();

        let level = 1;
        window.appConfig.level = level;
        let features = [
          [
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
            { appearAtLevel: 1, type: "ramp" },
            { appearAtLevel: 25 },
          ],
          [
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
            { appearAtLevel: 1, type: "ramp" },
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
          ],
          [
            { appearAtLevel: 25 },
            { appearAtLevel: 1, type: "ramp" },
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
          ],
          [
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
            { appearAtLevel: 1, type: "ramp" },
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
          ],
          [
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
            { appearAtLevel: 1, type: "ramp" },
            { appearAtLevel: 25 },
          ],
          [
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
            { appearAtLevel: 1, type: "ramp" },
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
          ],
          [
            { appearAtLevel: 25 },
            { appearAtLevel: 1, type: "ramp" },
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
            { appearAtLevel: 25 },
          ],
          [
            { appearAtLevel: 1, type: "plinko" },
            { appearAtLevel: 1, type: "plinko" },
            { appearAtLevel: 1, type: "plinko" },
            { appearAtLevel: 1, type: "plinko" },
            { appearAtLevel: 1, type: "plinko" },
          ],
        ];
        features.forEach((row, rowIndex) => {
          row.forEach((zone, zoneIndex) => {
            // console.log(zone);
            const xPercent = zoneIndex / row.length;
            const yPercent = rowIndex / features.length;
            const xPosition = xPercent * 25 - 12.5;
            const yPosition = -(yPercent * 375);
            // console.log("xPercent", xPercent);
            // console.log("yPercent", yPercent);
            // console.log("xPosition", xPosition);
            // console.log("yPosition", yPosition);
            // if (zone) {
            //   if (zone) {
            if (zone.appearAtLevel <= level) {
              if (zone.type === "ramp") {
                const obj = new Physijs.BoxMesh(
                  new THREE.BoxGeometry(
                    Math.random() * 12 + 3,
                    Math.random() * 0.5 + 0.9,
                    Math.random() * 0.5 + 0.9
                  ),
                  Physijs.createMaterial(
                    new THREE.MeshPhongMaterial({ color: getRandomColor() }),
                    // new THREE.MeshLambertMaterial({ map: loader.load( 'images/plywood.jpg' ) }),
                    0.6, // medium friction
                    0.3 // low restitution
                  ),
                  0 // mass
                );
                // console.dir(obj);
                zone.obj = obj;
                // obj.position.set(new THREE.Vector3(xPosition, yPosition, 0));

                obj.position.x = xPosition;
                obj.position.y = yPosition;
                obj.position.z = 0;
                obj.position.__dirtyPosition = true;
                obj.setLinearVelocity(new THREE.Vector3(0, 0, 0));
                obj.setAngularVelocity(new THREE.Vector3(0, 0, 0));
                obj.castShadow = true;
                obj.receiveShadow = true;
                // obj.rotation.x = Math.random() * 2 * Math.PI;
                // obj.rotation.y = 0.3 * Math.PI;
                obj.rotation.z = Math.random() * 2 * Math.PI;
                obj.featureType = "BOX";
                scene.add(obj);
                // console.dir(JSON.stringify(obj.position));
              }
            }
          });
        });

        spawnBox();

        requestAnimationFrame(render);
        scene.simulate();
        const clickRay = new THREE.Raycaster();

        const timer = new easytimer.Timer();
        timer.addEventListener("secondTenthsUpdated", function (e) {
          document.querySelector(
            "#timer"
          ).innerText = `${timer.getTimeValues()}`;
        });
        const results = {};
        window.appConfig = {
          ...window.appConfig,
          touchStart: false,
          touchEnd: false,
          currentX: 0,
          currentY: 0,
          prevX: 0,
          prevY: 0,
          diffX: 0,
          diffY: 0,
          start: false,
          pause: false,
          timer: timer,
          results: results,
          pause: false
        };

        document.addEventListener("touchstart", (e) => {
          window.appConfig.touchEnd = false;
          window.appConfig.touchStart = true;
          window.appConfig.currentX = e.touches[0].clientX;
          window.appConfig.currentY = e.touches[0].clientY;

          window.appConfig.prevX = e.touches[0].clientX;
          window.appConfig.prevY = e.touches[0].clientY;
          window.appConfig.diffX =
            window.appConfig.currentX - window.appConfig.prevX;
          window.appConfig.diffY =
            window.appConfig.currentY - window.appConfig.prevY;
          console.log("TOUCHSTART", e);
          console.log("APPCONFIG", window.appConfig);
        });
        // document.addEventListener('mousemove', (e) => {
        // 	console.log('MOUSEMOVE', e.clientX, e.clientY)
        // })
        document.body.addEventListener(
          "touchmove",
          (e) => {
            window.appConfig.prevX = window.appConfig.currentX;
            window.appConfig.prevY = window.appConfig.currentY;
            window.appConfig.currentX = e.touches[0].clientX;
            window.appConfig.currentY = e.touches[0].clientY;
            window.appConfig.diffX =
              e.touches[0].clientX - window.appConfig.prevX;
            window.appConfig.diffY =
              e.touches[0].clientY - window.appConfig.prevY;
            console.log(
              "TOUCHMOVE",
              e.touches[0].clientX,
              e.touches[0].clientY
            );
            console.log("APPCONFIG", window.appConfig);
            console.log(window.appConfig.diffX, window.appConfig.diffY);
            e.preventDefault();
          },
          true
        );
        document.addEventListener("touchend", (e) => {
          window.appConfig.touchEnd = true;
          window.appConfig.touchStart = false;
          window.appConfig.currentX = 0;
          window.appConfig.currentY = 0;
          window.appConfig.diffX = 0;
          window.appConfig.diffY = 0;
          console.log("TOUCHEND", e);
          console.log("APPCONFIG", window.appConfig);
        });
        document.addEventListener("click", (e) => {
          e.preventDefault();
          console.log("CLICK", e);
          const normalized = new THREE.Vector2(e.clientX, e.clientY);
          clickRay.setFromCamera(normalized.normalize(), camera);

          console.log(
            clickRay.intersectObject(
              scene.children.find((obj) => obj.gameName === "FRONTGLASS")
            )
          );
          console.log("APPCONFIG", window.appConfig);
        });
      };

      spawnBox = (function () {
        var box_geometry = new THREE.BoxGeometry(4, 4, 4),
          sphere_geometry = new THREE.SphereGeometry(1, 16, 16),
          handleCollision = function (
            collided_with,
            linearVelocity,
            angularVelocity
          ) {
            console.log("collision");
            console.log("collided_with", collided_with);
            if (collided_with.featureType === "STAGEFLOOR") {
              window.appConfig.timer.pause();
              window.appConfig.results[`stage${window.appConfig.level}`]
                ? (window.appConfig.results[
                    `stage${window.appConfig.level}`
                  ].finalTime = window.appConfig.timer
                    .getTimeValues()
                    .toString())
                : (window.appConfig.results[
                    `stage${window.appConfig.level}`
                  ] = {
                    finalTime: window.appConfig.timer
                      .getTimeValues()
                      .toString(),
                  });
              //now performance report and start level transition
              console.dir(window.appConfig.results);
              document.querySelector("#report").innerText =
                window.appConfig.results[
                  `stage${window.appConfig.level}`
                ].finalTime;
              document.querySelector("#report").classList.remove("hide");
              document.querySelector("#pause-button").disabled = true;
            }
            if (collided_with.featureType === "BOX") {
              switch (++this.collisions % 8) {
                case 1:
                  howlSound0.play()
                  break;

                case 2:
                  howlSound1.play()
                  break;

                case 3:
                  howlSound2.play()
                  break;

                case 4:
                  howlSound3.play()
                  break;

                case 5:
                  howlSound4.play()
                  break;

                case 6:
                  howlSound5.play()
                  break;

                case 7:
                  howlSound6.play()
                  break;

                case 8:
                  howlSound7.play()
                  break;
              }

              console.log("AFTERPLAY");
            }
          },
          createBox = function () {
            var box, material;

            material = Physijs.createMaterial(
              new THREE.MeshPhongMaterial(),
              // new THREE.MeshLambertMaterial({ map: loader.load( 'images/plywood.jpg' ) }),
              0.6, // medium friction
              0.3 // low restitution
            );

            //material = new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'images/rocks.jpg' ) });

            box = new Physijs.BoxMesh(box_geometry, material);
            box.collisions = 0;

            box.position.set(
              Math.random() * 15 - 7.5,
              25,
              Math.random() * 15 - 7.5
            );

            box.rotation.set(
              Math.random() * Math.PI,
              Math.random() * Math.PI,
              Math.random() * Math.PI
            );

            box.castShadow = true;
            // box.addEventListener("collision", handleCollision);
            box.addEventListener("ready", spawnBox);
            scene.add(box);
          };

        let createSphere = function () {
          var sphere, material;

          material = Physijs.createMaterial(
            new THREE.MeshLambertMaterial({
              color: getRandomColor(),
              // envMap: scene.background,
              // combine: THREE.MixOperation,
              // reflectivity: 0.1,
              // transparent: true,
              // opacity: 0.98
            }),
            0.5, // medium friction
            3 // low restitution
          );
          sphere = new Physijs.SphereMesh(sphere_geometry, material);
          sphere.collisions = 0;

          sphere.position.set(0, 10, 0);

          sphere.rotation.set(
            Math.random() * Math.PI,
            Math.random() * Math.PI,
            Math.random() * Math.PI
          );

          sphere.castShadow = true;
          sphere.addEventListener("collision", handleCollision);
          sphere.gameName = "SPHERE0";
          scene.add(sphere);
        };
        return () => {
          createSphere();
          const stageColor = getRandomColor();

          const glassMesh0 = new Physijs.BoxMesh(
            /*geometry*/ new THREE.BoxGeometry(25, 375, 1),
            /*material*/ new THREE.MeshBasicMaterial({
              color: stageColor,
              opacity: 0.1,
              transparent: true,
              wifeframe: true,
            }),
            /*mass*/ 0
          );
          glassMesh0.gameName = "FRONTGLASS";
          glassMesh0.name = "glassMesh0";

          const glassMesh1 = new Physijs.BoxMesh(
            /*geometry*/ new THREE.BoxGeometry(25, 375, 1),
            /*material*/ new THREE.MeshBasicMaterial({
              color: stageColor,
              opacity: 0,
              transparent: true,
              wifeframe: true,
            }),
            /*mass*/ 0
          );
          const glassMesh2 = new Physijs.BoxMesh(
            /*geometry*/ new THREE.BoxGeometry(3, 375, 1),
            /*material*/ new THREE.MeshBasicMaterial({
              color: stageColor,
              opacity: 0,
              transparent: true,
              wifeframe: true,
            }),
            /*mass*/ 0
          );

          const glassMesh3 = new Physijs.BoxMesh(
            /*geometry*/ new THREE.BoxGeometry(3, 375, 1),
            /*material*/ new THREE.MeshBasicMaterial({
              color: stageColor,
              opacity: 0,
              transparent: true,
              wifeframe: true,
            }),
            /*mass*/ 0
          );
          const stageFloor = new Physijs.BoxMesh(
            /*geometry*/ new THREE.BoxGeometry(25, 1, 3),
            /*material*/ new THREE.MeshBasicMaterial({
              color: stageColor,
              opacity: 0.1,
              transparent: true,
            }),
            /*mass*/ 0
          );

          stageFloor.name = "stageFloor";
          stageFloor.featureType = "STAGEFLOOR";
          glassMesh0.position.z = -1.5;
          glassMesh1.position.z = 1.5;
          glassMesh2.position.x = -12.5;
          glassMesh2.rotation.y = Math.PI * 0.5;
          glassMesh3.position.x = 12.5;
          glassMesh3.rotation.y = Math.PI * -0.5;
          glassMesh0.position.y = -140;
          glassMesh1.position.y = -140;
          glassMesh2.position.y = -140;
          glassMesh3.position.y = -140;
          stageFloor.position.y = -327;

          scene.add(glassMesh0);
          scene.add(glassMesh1);
          scene.add(glassMesh2);
          scene.add(glassMesh3);
          scene.add(stageFloor);
        };
      })();

      render = function () {
        
        const sphere = scene.children.find((obj) => obj.gameName === "SPHERE0");

        if (
          window.appConfig.start === false ||
          window.appConfig.pause === true
        ) {
          if (window.appConfig.start === false) {
            sphere.position.set(0, 10, 0);
          }
          scene.children
            .find((obj) => obj.gameName === "SPHERE0")
            .setLinearVelocity(new THREE.Vector3(0, 0, 0));
        } else {
          if (
            window.appConfig.touchStart === true &&
            window.appConfig.touchEnd === false
          ) {
            console.log("ACTIVE!!!");
            const scaleV = 0.5;
            scene.children
              .find((obj) => obj.gameName === "SPHERE0")
              .setLinearVelocity(
                new THREE.Vector3(
                  window.appConfig.diffX * scaleV,
                  window.appConfig.diffY * -scaleV,
                  0
                )
              );
          }
        }

        const spherePosition = scene.children.find(
          (obj) => obj.gameName === "SPHERE0"
        ).position;
        scene.children
          .find((obj) => obj.gameName === "POINTLIGHT0")
          .position.set(
            spherePosition.x,
            spherePosition.y + 1,
            spherePosition.z
          );

        const stageFloor = scene.children.find(
          (obj) => obj.name === "stageFloor"
        );
        const compareVector = new THREE.Vector3();
        const distanceSphereToStageFloor = compareVector
          .subVectors(
            new THREE.Vector3().setFromMatrixPosition(sphere.matrixWorld),
            new THREE.Vector3().setFromMatrixPosition(stageFloor.matrixWorld)
          )
          .length();
        const percentFinished = distanceSphereToStageFloor / 375;
        window.appConfig.percentFinished = percentFinished;
        if (new Date().getTime() % 10 < 3) {
          document.body.style.background =
            "linear-gradient(180deg, rgba(2,0,36,0) 0%, rgba(121,9,117,1) 0%, rgba(0,212,255,1) " +
            Math.round((1 - percentFinished) * 100) / 3 +
            "%, rgba(252,231,183,1) " +
            Math.round((1 - percentFinished) * 100) +
            "%)";
        }
        if (distanceSphereToStageFloor > 50) {
          camera.position.y = sphere.position.y;
        }

        const timerElement = document.querySelector("#timer");

        requestAnimationFrame(render);
        renderer.render(scene, camera);
        render_stats.update();
      };

      const start = () => {
        window.appConfig.start = true;
        document.querySelector("#start-button").classList.add("hide");
        document.querySelector("#pause-button").disabled = false;
        window.appConfig.timer.start();
      };

      const pause = () => {
        window.appConfig.pause ? backgroundMusic0.play() : backgroundMusic0.pause()
        window.appConfig.pause = !window.appConfig.pause;
        if (window.appConfig.pause) {
          window.appConfig.timer.pause();
        } else {
          window.appConfig.timer.start();
        }
      };

      window.onload = initScene;
    </script>
    <style>
      #start-button {
        position: fixed;
        left: 40%;
        top: 50%;
        padding: 10px 30px;
        border: 0;
        border-radius: 5px;
        opacity: 0.75;
      }
      #pause-button {
        position: fixed;
        left: 3%;
        bottom: 3%;
        padding: 10px 30px;
        border: 0;
        border-radius: 5px;
        opacity: 0.75;
      }
      .hide {
        display: none;
        visibility: hidden;
      }
      #timer {
        padding: 10px 30px;
        height: 100px;
        width: 200px;
        position: absolute;
        top: 3%;
        right: 3%;
      }

      #report {
        position: fixed;
        left: 40%;
        top: 50%;
        padding: 10px 30px;
        /* border: 3px solid black; */
        border: 0;
        border-radius: 5px;
        opacity: 0.75;
      }
    </style>
  </head>

  <body>
    <div id="viewport"></div>
    <div id="timer"></div>
    <div id="report" class="hide"></div>
    <button id="start-button" onClick="start()">Start</button>
    <button id="pause-button" disabled onClick="pause()">Pause</button>
  </body>
</html>
